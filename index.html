<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Still Waters Counseling - Book Your Appointment</title>
  <!-- Single-file build | v2025-09-12_siblings-fixed | 3-hour blocks for households -->
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --primary-color: #2c5282;
      --secondary-color: #4299e1;
      --accent-color: #63b3ed;
      --success-color: #48bb78;
      --danger-color: #f56565;
      --light-bg: #f7fafc;
      --white: #ffffff;
      --gray-light: #e2e8f0;
      --gray-medium: #718096;
      --gray-dark: #2d3748;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      line-height: 1.6;
    }

    .container { background: var(--white); border-radius: 20px; box-shadow: var(--shadow-lg); max-width: 900px; width: 100%; overflow: hidden; animation: slideIn 0.5s ease-out; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(30px);} to { opacity: 1; transform: translateY(0);} }

    .header { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: var(--white); padding: 40px 30px; text-align: center; }
    .header h1 { font-size: 2.5rem; margin-bottom: 10px; font-weight: 300; letter-spacing: -1px; }
    .header p { font-size: 1.1rem; opacity: 0.95; }

    .emergency-notice { background: var(--danger-color); color: var(--white); padding: 15px 30px; text-align: center; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 10px; }
    .emergency-notice svg { width: 24px; height: 24px; fill: currentColor; }

    .form-container { padding: 40px 30px; }
    .form-section { margin-bottom: 35px; animation: fadeIn 0.5s ease-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .form-section h2 { color: var(--gray-dark); font-size: 1.5rem; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid var(--gray-light); font-weight: 600; }

    .form-group { margin-bottom: 20px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

    label { display: block; color: var(--gray-dark); font-weight: 500; margin-bottom: 8px; font-size: 0.95rem; }
    .required { color: var(--danger-color); }

    input[type="text"], input[type="email"], input[type="tel"], input[type="date"], input[type="time"], select, textarea { width: 100%; padding: 12px 15px; border: 2px solid var(--gray-light); border-radius: 10px; font-size: 1rem; transition: all 0.3s ease; background: var(--white); }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--secondary-color); box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1); }
    textarea { resize: vertical; min-height: 100px; }

    .radio-group { display: flex; gap: 30px; margin-top: 10px; }
    .radio-option { display: flex; align-items: center; cursor: pointer; padding: 15px 25px; border: 2px solid var(--gray-light); border-radius: 10px; transition: all 0.3s ease; flex: 1; background: var(--white); }
    .radio-option:hover { border-color: var(--secondary-color); background: var(--light-bg); }
    .radio-option input[type="radio"] { margin-right: 10px; width: 20px; height: 20px; cursor: pointer; }
    .radio-option.selected { border-color: var(--secondary-color); background: linear-gradient(135deg, rgba(66, 153, 225, 0.1), rgba(99, 179, 237, 0.1)); }

    .checkbox-group { display: flex; align-items: flex-start; margin: 20px 0; }
    .checkbox-group input[type="checkbox"] { margin-right: 10px; margin-top: 5px; width: 20px; height: 20px; cursor: pointer; }
    .checkbox-group label { cursor: pointer; margin-bottom: 0; flex: 1; }

    .time-slots { display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 15px; }
    .time-slot { padding: 15px; border: 2px solid var(--gray-light); border-radius: 12px; background: var(--white); box-shadow: var(--shadow); }
    .time-slot .date { font-weight: 700; font-size: 1rem; margin-bottom: 10px; color: var(--gray-dark); }
    .time-slot .range { font-size: 0.9rem; color: var(--gray-medium); margin-bottom: 10px; }

    .slot-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }
    .slot-chip { user-select: none; text-align: center; padding: 10px 12px; border: 2px solid var(--gray-light); border-radius: 9999px; background: var(--white); font-size: 0.95rem; cursor: pointer; transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease, background .15s ease, color .15s ease; }
    .slot-chip:hover { transform: translateY(-1px); border-color: var(--secondary-color); box-shadow: var(--shadow); }
    .slot-chip.selected { background: var(--secondary-color); color: var(--white); border-color: var(--secondary-color); }

    .hidden { display: none !important; }

    .button-group { display: flex; gap: 15px; margin-top: 40px; justify-content: center; }
    .btn { padding: 15px 40px; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px; }
    .btn-primary { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: var(--white); box-shadow: 0 4px 15px rgba(66, 153, 225, 0.3); }
    .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(66, 153, 225, 0.4); }
    .btn-secondary { background: var(--white); color: var(--primary-color); border: 2px solid var(--primary-color); }
    .btn-secondary:hover { background: var(--light-bg); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .loading-spinner { width: 20px; height: 20px; border: 3px solid var(--white); border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; margin-left: 10px; display: inline-block; vertical-align: middle; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .success-message { background: var(--success-color); color: var(--white); padding: 20px; border-radius: 10px; text-align: center; margin: 20px 0; display: none; animation: slideDown 0.5s ease-out; }
    .error-message { background: var(--danger-color); color: var(--white); padding: 15px; border-radius: 10px; text-align: center; margin: 20px 0; display: none; }

    .sibling-card { border:2px solid var(--gray-light); border-radius:12px; padding:15px; margin-bottom:12px; background:var(--light-bg); }
    .sibling-row { display:grid; grid-template-columns: 1.5fr 0.8fr 1fr; gap:12px; }
    .sibling-guardian { margin-top:10px; padding:10px; border-radius:10px; background:#fff; border:1px dashed var(--gray-light); }
    .sibling-remove { margin-top:10px; }
    .hint { color: var(--gray-medium); margin-bottom: 10px; font-size: 0.95rem; }
    .siblings-notice { background: #fff3cd; border: 1px solid #ffc107; color: #856404; padding: 12px; border-radius: 8px; margin-bottom: 15px; }

    @media (max-width: 768px) {
      .header h1 { font-size: 2rem; }
      .form-row { grid-template-columns: 1fr; }
      .radio-group { flex-direction: column; }
      .time-slots { grid-template-columns: 1fr; }
      .button-group { flex-direction: column; }
      .btn { width: 100%; }
      .slot-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }
      .sibling-row { grid-template-columns: 1fr; }
    }

    .loading-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 9999; }
    .loading-overlay.active { display: flex; }
    .loading-content { background: var(--white); padding: 30px; border-radius: 15px; text-align: center; box-shadow: var(--shadow-lg); }
    .loading-content .spinner { width: 50px; height: 50px; border: 5px solid var(--gray-light); border-top-color: var(--secondary-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Still Waters Counseling</h1>
      <p>Schedule Your Intake Appointment</p>
    </div>

    <div class="emergency-notice">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/></svg>
      <span>If you are experiencing an emergency, please dial 911 immediately</span>
    </div>

    <form id="bookingForm" class="form-container" novalidate>
      <div id="successMessage" class="success-message">Appointment booked successfully! You'll receive a confirmation soon.</div>
      <div id="errorMessage" class="error-message">There was an error booking your appointment. Please try again.</div>

      <div class="form-section">
        <h2>Client Information</h2>
        <div class="form-row">
          <div class="form-group">
            <label for="firstName">First Name <span class="required">*</span></label>
            <input type="text" id="firstName" name="firstName" required />
          </div>
          <div class="form-group">
            <label for="lastName">Last Name <span class="required">*</span></label>
            <input type="text" id="lastName" name="lastName" required />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="email">Email Address <span class="required">*</span></label>
            <input type="email" id="email" name="email" required />
          </div>
          <div class="form-group">
            <label for="phone">Phone Number <span class="required">*</span></label>
            <input type="tel" id="phone" name="phone" required placeholder="123-456-7890" />
          </div>
        </div>
      </div>

      <div class="form-section">
        <h2>Age Verification</h2>
        <div class="form-row">
          <div class="form-group">
            <label for="dob">Date of Birth <span class="required">*</span></label>
            <input type="date" id="dob" name="dob" required />
          </div>
          <div class="form-group">
            <label>Is the person receiving services over 18? <span class="required">*</span></label>
            <div class="radio-group">
              <div class="radio-option" data-over18="yes">
                <input type="radio" id="over18Yes" name="over18" value="yes" required />
                <label for="over18Yes">Yes</label>
              </div>
              <div class="radio-option" data-over18="no">
                <input type="radio" id="over18No" name="over18" value="no" required />
                <label for="over18No">No</label>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div id="guardianInfo" class="form-section hidden">
        <h2>Guardian Information</h2>
        <div class="form-row">
          <div class="form-group">
            <label for="guardianName">Guardian Name <span class="required">*</span></label>
            <input type="text" id="guardianName" name="guardianName" />
          </div>
          <div class="form-group">
            <label for="guardianPhone">Guardian Phone <span class="required">*</span></label>
            <input type="tel" id="guardianPhone" name="guardianPhone" placeholder="123-456-7890" />
          </div>
        </div>
        <div class="form-group">
          <label for="guardianEmail">Guardian Email <span class="required">*</span></label>
          <input type="email" id="guardianEmail" name="guardianEmail" />
        </div>
      </div>

      <!-- Siblings / Household Section -->
      <div class="form-section">
        <h2>Household / Siblings</h2>

        <div class="form-group">
          <label>Are there others in your household receiving services? <span class="required">*</span></label>
          <div class="radio-group">
            <div class="radio-option" data-household="yes">
              <input type="radio" id="householdYes" name="householdOthers" value="yes" required />
              <label for="householdYes">Yes</label>
            </div>
            <div class="radio-option" data-household="no">
              <input type="radio" id="householdNo" name="householdOthers" value="no" required />
              <label for="householdNo">No</label>
            </div>
          </div>
        </div>

        <div id="siblingsWrap" class="hidden">
          <div class="siblings-notice">
            <strong>Important:</strong> All household members will be scheduled in the same 3-hour block. You'll select the start time for the block.
          </div>
          <div id="siblingsList"></div>
          <button type="button" class="btn btn-secondary" id="addSiblingBtn">+ Add Household Member</button>
        </div>
      </div>

      <div class="form-section">
        <h2>Appointment Type</h2>
        <div class="form-group">
          <label>Select your preferred appointment type <span class="required">*</span></label>
          <div class="radio-group">
            <div class="radio-option" data-type="telehealth">
              <input type="radio" id="telehealth" name="appointmentType" value="telehealth" required />
              <label for="telehealth">Telehealth (Video Call)</label>
            </div>
            <div class="radio-option" data-type="inperson">
              <input type="radio" id="inperson" name="appointmentType" value="inperson" required />
              <label for="inperson">In-Person Visit</label>
            </div>
          </div>
        </div>
      </div>

      <div id="inPersonDetails" class="form-section hidden">
        <h2>In-Person Visit Details</h2>
        <div class="form-group">
          <label for="address">Service Address <span class="required">*</span></label>
          <input type="text" id="address" name="address" placeholder="Full street address" />
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="unit">Apartment/Unit Number</label>
            <input type="text" id="unit" name="unit" placeholder="Apt, Suite, Unit #" />
          </div>
          <div class="form-group">
            <label for="parking">Parking Instructions</label>
            <input type="text" id="parking" name="parking" placeholder="Where to park" />
          </div>
        </div>
        <div class="form-group">
          <label for="entryNotes">Gate/Entry Notes</label>
          <textarea id="entryNotes" name="entryNotes" placeholder="Gate codes, building access details, etc."></textarea>
        </div>
        <div class="form-group">
          <label for="safetyConsiderations">Safety Considerations</label>
          <textarea id="safetyConsiderations" name="safetyConsiderations" placeholder="Any safety issues our clinician should know about"></textarea>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="arrivalWindow" name="arrivalWindow" />
          <label for="arrivalWindow">I understand the clinician will arrive within a 10-15 minute window around the start time</label>
        </div>
      </div>

      <div class="form-section">
        <h2>Select Appointment Time</h2>
        <div class="form-group">
          <button type="button" class="btn btn-secondary" id="loadSlotsBtn">Load Available Times</button>
        </div>
        <div id="timeSlots" class="time-slots"></div>
      </div>

      <div class="form-section">
        <h2>Additional Information</h2>
        <div class="form-group">
          <label for="alternateAvailability">Alternate Availability (Optional)</label>
          <textarea id="alternateAvailability" name="alternateAvailability" placeholder="If the available slots don't work, please describe your availability"></textarea>
        </div>
        <div class="form-group">
          <label for="additionalNotes">Additional Notes (Optional)</label>
          <textarea id="additionalNotes" name="additionalNotes" placeholder="Any other information you'd like us to know"></textarea>
        </div>
      </div>

      <div class="form-section">
        <h2>Consent & Acknowledgments</h2>
        <div class="checkbox-group">
          <input type="checkbox" id="consent" name="consent" required />
          <label for="consent">I consent to receive appointment reminders via text and email <span class="required">*</span></label>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="emergency" name="emergency" required />
          <label for="emergency">I confirm that I am not currently experiencing a medical or mental health emergency <span class="required">*</span></label>
        </div>
      </div>

      <div class="button-group">
        <button type="button" class="btn btn-secondary" id="clearFormBtn">Clear Form</button>
        <button type="submit" class="btn btn-primary" id="submitBtn">
          Book Appointment
          <span class="loading-spinner hidden" id="submitSpinner"></span>
        </button>
      </div>
    </form>
  </div>

  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
      <div class="spinner"></div>
      <p>Processing your request...</p>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    var CONFIG = {
      GET_SLOTS_URL: 'https://sw-function-b6c4h9cnexhbh4g3.canadacentral-01.azurewebsites.net/api/Calender',
      BOOK_APPOINTMENT_URL: 'https://sw-function-b6c4h9cnexhbh4g3.canadacentral-01.azurewebsites.net/api/CreateEvent',
      GET_SLOTS_KEY: '',
      BOOK_APPOINTMENT_KEY: '',
      TIMEZONE: 'Central Standard Time',
      SLOT_MINUTES: 20,
      SIBLING_BLOCK_MINUTES: 180
    };

    // Global selection
    var selectedSlot = null;
    var availableSlots = [];

    function withKey(url, key) {
      if (!key) return url;
      try { 
        var u = new URL(url); 
        u.searchParams.set('code', key); 
        return u.toString(); 
      }
      catch(e) { 
        var sep = url.indexOf('?')>=0 ? '&' : '?'; 
        return url + sep + 'code=' + encodeURIComponent(key); 
      }
    }
    
    function isSiblingFlow(){
      var val = document.querySelector('input[name="householdOthers"]:checked');
      return val && val.value === 'yes';
    }

    function addSiblingRow(){
      var list = document.getElementById('siblingsList');
      var div = document.createElement('div');
      div.className = 'sibling-card';
      div.innerHTML = `
        <div class="sibling-row">
          <div class="form-group">
            <label>Name <span class="required">*</span></label>
            <input type="text" name="siblingName[]" required />
          </div>
          <div class="form-group">
            <label>Age Group <span class="required">*</span></label>
            <select name="siblingUnder18[]" required>
              <option value="no">18 or over</option>
              <option value="yes">Under 18</option>
            </select>
          </div>
          <div class="form-group">
            <label>Guardian same as main?</label>
            <div class="checkbox-group">
              <input type="checkbox" name="siblingGuardianSame[]" checked />
              <label>Yes</label>
            </div>
          </div>
        </div>
        <div class="sibling-guardian hidden">
          <div class="form-row">
            <div class="form-group">
              <label>Guardian Name <span class="required">*</span></label>
              <input type="text" name="siblingGuardianName[]" />
            </div>
            <div class="form-group">
              <label>Guardian Phone <span class="required">*</span></label>
              <input type="tel" name="siblingGuardianPhone[]" placeholder="123-456-7890" />
            </div>
          </div>
          <div class="form-group">
            <label>Guardian Email <span class="required">*</span></label>
            <input type="email" name="siblingGuardianEmail[]" />
          </div>
        </div>
        <button type="button" class="btn btn-secondary sibling-remove">Remove</button>
      `;
      list.appendChild(div);
      applySiblingGuardianRules(div);
    }

    function applySiblingGuardianRules(card){
      var under18 = card.querySelector('select[name="siblingUnder18[]"]').value === 'yes';
      var same = card.querySelector('input[name="siblingGuardianSame[]"]').checked;
      var box = card.querySelector('.sibling-guardian');

      if (under18 && !same) {
        box.classList.remove('hidden');
        ['siblingGuardianName[]','siblingGuardianPhone[]','siblingGuardianEmail[]'].forEach(n=>{
          var el = card.querySelector(`[name="${n}"]`); 
          if (el) el.required = true;
        });
      } else {
        box.classList.add('hidden');
        ['siblingGuardianName[]','siblingGuardianPhone[]','siblingGuardianEmail[]'].forEach(n=>{
          var el = card.querySelector(`[name="${n}"]`); 
          if (el) el.required = false;
        });
      }
    }

    function collectSiblingsPayload(){
      var out = [];
      document.querySelectorAll('.sibling-card').forEach(card=>{
        var name = (card.querySelector('[name="siblingName[]"]')?.value||'').trim();
        var under18 = (card.querySelector('[name="siblingUnder18[]"]')?.value||'no') === 'yes';
        var guardianSame = card.querySelector('[name="siblingGuardianSame[]"]')?.checked;

        var g = null;
        if (under18 && !guardianSame) {
          g = {
            name:  (card.querySelector('[name="siblingGuardianName[]"]')?.value||'').trim(),
            phone: (card.querySelector('[name="siblingGuardianPhone[]"]')?.value||'').trim(),
            email: (card.querySelector('[name="siblingGuardianEmail[]"]')?.value||'').trim()
          };
        }
        out.push({ name, under18, guardianSame, guardian: g });
      });
      return out;
    }

    document.addEventListener('DOMContentLoaded', function () {
      // Household radios styling + show/hide siblings
      document.querySelectorAll('.radio-option[data-household]').forEach(function(card){
        card.addEventListener('click', function(){
          var val = this.getAttribute('data-household');
          var radio = document.getElementById(val === 'yes' ? 'householdYes' : 'householdNo');
          if (radio) radio.checked = true;

          document.querySelectorAll('.radio-option[data-household]').forEach(c => c.classList.remove('selected'));
          this.classList.add('selected');

          var wrap = document.getElementById('siblingsWrap');
          if (val === 'yes') { 
            wrap.classList.remove('hidden'); 
            if (!document.querySelector('.sibling-card')) addSiblingRow(); 
            // Reload slots if already loaded to show 3-hour blocks
            if (availableSlots.length > 0) {
              displayAvailableSlots(availableSlots);
            }
          }
          else { 
            wrap.classList.add('hidden'); 
            document.getElementById('siblingsList').innerHTML='';
            // Reload slots to show 20-minute blocks
            if (availableSlots.length > 0) {
              displayAvailableSlots(availableSlots);
            } 
          }
        });
      });

      // Add sibling button
      document.getElementById('addSiblingBtn')?.addEventListener('click', addSiblingRow);

      // Delegate changes for under18 / guardian-same toggles
      document.getElementById('siblingsList').addEventListener('change', function(e){
        var card = e.target.closest('.sibling-card'); 
        if(!card) return;

        if (e.target.name === 'siblingUnder18[]' || e.target.name === 'siblingGuardianSame[]') {
          applySiblingGuardianRules(card);
        }
      });

      // Delegate remove
      document.getElementById('siblingsList').addEventListener('click', function(e){
        if (e.target.classList.contains('sibling-remove')) {
          e.preventDefault();
          var card = e.target.closest('.sibling-card');
          if (card) card.remove();
        }
      });

      // Handle Over 18 selection
      document.querySelectorAll('.radio-option[data-over18]').forEach(function(card){
        card.addEventListener('click', function(){
          var val = this.getAttribute('data-over18');
          var radio = document.getElementById(val === 'yes' ? 'over18Yes' : 'over18No');
          if (radio) radio.checked = true;

          document.querySelectorAll('.radio-option[data-over18]').forEach(c => c.classList.remove('selected'));
          this.classList.add('selected');

          const guardianSection = document.getElementById('guardianInfo');
          if (val === 'no') {
            guardianSection.classList.remove('hidden');
            document.getElementById('guardianName').required = true;
            document.getElementById('guardianPhone').required = true;
            document.getElementById('guardianEmail').required = true;
          } else {
            guardianSection.classList.add('hidden');
            document.getElementById('guardianName').required = false;
            document.getElementById('guardianPhone').required = false;
            document.getElementById('guardianEmail').required = false;
          }
        });
      });

      document.getElementById('bookingForm').addEventListener('submit', handleSubmit);
      document.getElementById('loadSlotsBtn').addEventListener('click', loadAvailableSlots);
      document.getElementById('clearFormBtn').addEventListener('click', clearForm);

      // Appointment Type cards
      var typeCards = document.querySelectorAll('.radio-option[data-type]');
      typeCards.forEach(function(card){
        card.addEventListener('click', function(){
          selectAppointmentType(this.getAttribute('data-type'));
        });
      });

      // Phone number formatting
      document.getElementById('phone').addEventListener('input', function (e) {
        var v = e.target.value.replace(/\D/g,'').slice(0,10);
        if (v.length>6) e.target.value = v.slice(0,3)+'-'+v.slice(3,6)+'-'+v.slice(6);
        else if (v.length>3) e.target.value = v.slice(0,3)+'-'+v.slice(3);
        else e.target.value = v;
      });

      document.getElementById('guardianPhone').addEventListener('input', function (e) {
        var v = e.target.value.replace(/\D/g,'').slice(0,10);
        if (v.length>6) e.target.value = v.slice(0,3)+'-'+v.slice(3,6)+'-'+v.slice(6);
        else if (v.length>3) e.target.value = v.slice(0,3)+'-'+v.slice(3);
        else e.target.value = v;
      });
    });

    function generateUUID(){ 
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){ 
        var r=Math.random()*16|0, v=c==='x'?r:(r&0x3)|0x8; 
        return v.toString(16).toUpperCase(); 
      }); 
    }

    function selectAppointmentType(type){
      var radio = document.getElementById(type === 'telehealth' ? 'telehealth' : 'inperson');
      if (radio) radio.checked = true;

      var cards = document.querySelectorAll('.radio-option[data-type]');
      for (var i = 0; i < cards.length; i++) cards[i].classList.remove('selected');
      var chosen = document.querySelector('.radio-option[data-type="' + type + '"]');
      if (chosen) chosen.classList.add('selected');

      // Always hide in-person details
      var inPerson = document.getElementById('inPersonDetails');
      if (inPerson) inPerson.classList.add('hidden');

      var addr = document.getElementById('address');
      var arrival = document.getElementById('arrivalWindow');
      if (addr) addr.required = false;
      if (arrival) arrival.required = false;
    }

    function parseSlotString(slotStr){
      // slotStr like: "09 Sep 2025, 9:00 AM - 5:00 PM"
      var parts = slotStr.split(', ');
      var datePart = parts[0];
      var timePart = parts[1];
      var dt = datePart.split(' ');
      var day = parseInt(dt[0],10), mon = dt[1], year = parseInt(dt[2],10);
      var monthMap = {Jan:1,Feb:2,Mar:3,Apr:4,May:5,Jun:6,Jul:7,Aug:8,Sep:9,Oct:10,Nov:11,Dec:12};
      var monthNum = monthMap[mon];
      var range = timePart.split(' - ');
      return {
        date: new Date(year, monthNum-1, day),
        y: year, m: monthNum, d: day,
        dateStr: datePart,
        startTimeStr: range[0],
        endTimeStr: range[1],
        originalString: slotStr
      };
    }

    function convertTo24Hour(timeStr){
      var t=timeStr.trim().split(' ');
      var hm=t[0].split(':'), h=parseInt(hm[0],10), m=parseInt(hm[1],10), p=t[1];
      if(p==='PM'&&h!==12)h+=12;
      if(p==='AM'&&h===12)h=0;
      return {hours:h, minutes:m};
    }

    function p2(n){return (n<10?'0':'')+n;}

    function ymdhms(y,m,d,h,mi){ 
      return y+'-'+p2(m)+'-'+p2(d)+'T'+p2(h)+':'+p2(mi)+':00'; 
    }

    function dowForYMD(y,m,d){
      var days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      var idx = new Date(Date.UTC(y, m-1, d)).getUTCDay();
      return days[idx];
    }

    function hmToMinutes(h,m){ return h*60+m; }
    function minutesToHM(total){ return {hour: Math.floor(total/60), minute: total%60}; }

    function addMinutesToHM(h, m, delta){
      var total = h*60 + m + delta;
      return { hour: Math.floor(total/60), minute: total%60 };
    }

    function t12fmt(h, m){
      function p2(n){return (n<10?'0':'')+n;}
      var ap=h>=12?'PM':'AM';
      var hh=h%12===0?12:(h%12);
      return hh + ':' + p2(m) + ' ' + ap;
    }

    async function loadAvailableSlots(){
      var overlay=document.getElementById('loadingOverlay'); 
      overlay.classList.add('active');
      var url = withKey(CONFIG.GET_SLOTS_URL, CONFIG.GET_SLOTS_KEY);
      try{
        var resp = await fetch(url, { method:'GET', headers:{'Accept':'application/json'} });
        var text = await resp.text();
        console.log('[GET /Calender]', resp.status, text);
        if(!resp.ok) throw new Error('Failed to load slots ('+resp.status+')');
        var data = text? JSON.parse(text):{};
        var list = Array.isArray(data)? data
                  : (Array.isArray(data.free_slots)? data.free_slots
                  : (Array.isArray(data.freeSlots)? data.freeSlots
                  : (Array.isArray(data.slots)? data.slots : [])));
        availableSlots = list.map(parseSlotString);
        displayAvailableSlots(availableSlots);
      }catch(e){
        console.error(e);
        showError('Failed to load available appointment times. Please try again.');
      }
      finally{ 
        overlay.classList.remove('active'); 
      }
    }

    function displayAvailableSlots(slots){
      const container = document.getElementById('timeSlots');
      container.innerHTML='';

      if(!slots || !slots.length){
        container.innerHTML = '<p>No available slots returned by the server. Please check back later.</p>';
        return;
      }

      selectedSlot = null;
      const isSiblings = isSiblingFlow();
      const DURATION = isSiblings ? CONFIG.SIBLING_BLOCK_MINUTES : CONFIG.SLOT_MINUTES;

      for (let i = 0; i < slots.length; i++) {
        const s = slots[i];

        const card = document.createElement('div');
        card.className = 'time-slot';

        const header = document.createElement('div');
        header.className = 'date';
        header.textContent = `${dowForYMD(s.y, s.m, s.d)} ${s.dateStr}`;

        const sub = document.createElement('div');
        sub.className = 'range';
        sub.textContent = `Available: ${s.startTimeStr} - ${s.endTimeStr}`;

        const grid = document.createElement('div');
        grid.className = 'slot-grid';

        // Calculate available chips
        const chips = [];
        const start24 = convertTo24Hour(s.startTimeStr);
        const end24 = convertTo24Hour(s.endTimeStr);
        const startMin = hmToMinutes(start24.hours, start24.minutes);
        const endMin = hmToMinutes(end24.hours, end24.minutes);

        if (isSiblings) {
          // For siblings: show start times for 3-hour blocks
          for (let m = startMin; m + DURATION <= endMin; m += CONFIG.SLOT_MINUTES) {
            const startHM = minutesToHM(m);
            chips.push({
              start: { hour: startHM.hour, minute: startHM.minute },
              label: t12fmt(startHM.hour, startHM.minute)
            });
          }
        } else {
          // For regular: show 20-minute slots with range
          for (let m = startMin; m + DURATION <= endMin; m += DURATION) {
            const startHM = minutesToHM(m);
            const endHM = minutesToHM(m + DURATION);
            chips.push({
              start: { hour: startHM.hour, minute: startHM.minute },
              label: t12fmt(startHM.hour, startHM.minute) + '–' + t12fmt(endHM.hour, endHM.minute)
            });
          }
        }

        if (chips.length === 0) {
          const emptyMsg = document.createElement('div');
          emptyMsg.style.color = 'var(--gray-medium)';
          emptyMsg.textContent = isSiblings
            ? 'No 3-hour blocks available in this window.'
            : 'No slots available in this window.';
          grid.appendChild(emptyMsg);
        } else {
          chips.forEach((ch) => {
            const chipEl = document.createElement('div');
            chipEl.className = 'slot-chip';
            chipEl.setAttribute('role','button');
            chipEl.setAttribute('tabindex','0');
            chipEl.textContent = ch.label;

            chipEl.addEventListener('click', () => {
              document.querySelectorAll('.slot-chip').forEach(el => el.classList.remove('selected'));
              chipEl.classList.add('selected');

              selectedSlot = {
                y: s.y, 
                m: s.m, 
                d: s.d,
                dateStr: s.dateStr,
                start: { hour: ch.start.hour, minute: ch.start.minute },
                durationMinutes: DURATION,
                display: ch.label
              };

              console.log('[SELECTED]', selectedSlot);
            });

            chipEl.addEventListener('keydown', (ev) => {
              if (ev.key === 'Enter' || ev.key === ' ') { 
                ev.preventDefault(); 
                chipEl.click(); 
              }
            });

            grid.appendChild(chipEl);
          });
        }

        card.appendChild(header);
        card.appendChild(sub);
        card.appendChild(grid);
        container.appendChild(card);
      }
    }

    function humanTimeDisplayYMD(y,m,d,start,end){
      var mons=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      function p2(n){return (n<10?'0':'')+n;}
      function t12fmt(h,mn){
        var ap=h>=12?'pm':'am';
        var hh=h%12===0?12:h%12;
        return hh+(mn?':'+p2(mn):'')+ap;
      }
      return d+' '+mons[m-1]+' '+y+', '+t12fmt(start.hour,start.minute)+'–'+t12fmt(end.hour,end.minute);
    }

    function validateForm(){
      hideMessages();

      if(!selectedSlot){
        showError('Please choose a start time.');
        return false;
      }

      var appt = document.querySelector('input[name="appointmentType"]:checked');
      if(!appt){ 
        showError('Please select an appointment type'); 
        return false; 
      }

      var email=document.getElementById('email').value.trim();
      if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){
        showError('Please enter a valid email address');
        return false;
      }
       
      var dob = new Date(document.getElementById('dob').value);
      if (isNaN(dob)) {
        showError('Please enter a valid Date of Birth');
        return false;
      }
      
      var today = new Date();
      var age = today.getFullYear() - dob.getFullYear();
      var m = today.getMonth() - dob.getMonth();
      if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) {
        age--;
      }
      
      var over18Choice = document.querySelector('input[name="over18"]:checked');
      if (!over18Choice) {
        showError('Please select whether the client is over 18');
        return false;
      }
      
      if ((age >= 18 && over18Choice.value === 'no') || (age < 18 && over18Choice.value === 'yes')) {
        showError('The DOB and Over-18 selection do not match.');
        return false;
      }

      if(!document.getElementById('consent').checked){
        showError('Please consent to receive appointment reminders');
        return false;
      }
      
      if(!document.getElementById('emergency').checked){
        showError('Please confirm you are not experiencing an emergency');
        return false;
      }
       
      if (isSiblingFlow()) {
        var sibs = document.querySelectorAll('.sibling-card');
        if (sibs.length === 0) {
          showError('Please add at least one household member.');
          return false;
        }
        
        for (var i=0;i<sibs.length;i++){
          var card = sibs[i];
          var name = (card.querySelector('[name="siblingName[]"]')?.value||'').trim();
          if (!name) { 
            showError('Please enter a name for each household member.'); 
            return false; 
          }
          var under18 = (card.querySelector('[name="siblingUnder18[]"]')?.value||'no') === 'yes';
          var same = card.querySelector('[name="siblingGuardianSame[]"]')?.checked;
          if (under18 && !same) {
            var gn = (card.querySelector('[name="siblingGuardianName[]"]')?.value||'').trim();
            var gp = (card.querySelector('[name="siblingGuardianPhone[]"]')?.value||'').trim();
            var ge = (card.querySelector('[name="siblingGuardianEmail[]"]')?.value||'').trim();
            if (!gn || !gp || !ge) { 
              showError('Please complete guardian info for under-18 household members whose guardian differs.'); 
              return false; 
            }
          }
        }
      }

      return true;
    }

    async function handleSubmit(e){
      e.preventDefault();
      if(!validateForm()) return;

      var btn=document.getElementById('submitBtn'), spin=document.getElementById('submitSpinner');
      btn.disabled=true; 
      spin.classList.remove('hidden');

      try{
        var form=new FormData(e.target);
        var first=String(form.get('firstName')||'').trim(),
            last =String(form.get('lastName')||'').trim(),
            email=String(form.get('email')||'').trim(),
            phone=String(form.get('phone')||'').trim(),
            apptType=String(form.get('appointmentType')||'').trim();
            
        var dob = String(form.get('dob') || '').trim();
        var over18Choice = String(form.get('over18') || '').trim();
        var guardianName = String(form.get('guardianName') || '').trim();
        var guardianPhone = String(form.get('guardianPhone') || '').trim();
        var guardianEmail = String(form.get('guardianEmail') || '').trim();

        var st = { hour: selectedSlot.start.hour, minute: selectedSlot.start.minute };
        var duration = selectedSlot.durationMinutes || (isSiblingFlow() ? CONFIG.SIBLING_BLOCK_MINUTES : CONFIG.SLOT_MINUTES);
        var endHM = addMinutesToHM(st.hour, st.minute, duration);

        // Build dateTime strings
        var startDT = ymdhms(selectedSlot.y, selectedSlot.m, selectedSlot.d, st.hour, st.minute);
        var endDT   = ymdhms(selectedSlot.y, selectedSlot.m, selectedSlot.d, endHM.hour, endHM.minute);

        var subjectBase = (apptType==='telehealth'?'Telehealth':'In-person')+' appointment';
        if (isSiblingFlow()) subjectBase = 'Household intake (3-hour block)';

        var body='Appointment scheduled for '+apptType+' with '+first+' '+last+' on '
               + humanTimeDisplayYMD(selectedSlot.y, selectedSlot.m, selectedSlot.d, st, endHM)
               + '. Contact: '+phone+'.';

        var alt=String(form.get('alternateAvailability')||''),
            notes=String(form.get('additionalNotes')||'');

        if(alt)  body+=' Alternate availability: '+alt+'.';
        if(notes)body+=' Additional notes: '+notes+'.';
        body += ' Date of Birth: ' + dob + '.';
        body += ' Over 18: ' + (over18Choice === 'yes' ? 'Yes' : 'No') + '.';

        if (over18Choice === 'no') {
          body += ' Guardian: ' + guardianName +
                  ' (Phone: ' + guardianPhone +
                  ', Email: ' + guardianEmail + ').';
        }

        // Collect siblings info
        var householdPayload = null;
        if (isSiblingFlow()) {
          var siblings = collectSiblingsPayload();
          householdPayload = { 
            hasSiblings: true, 
            householdBlockMinutes: duration, 
            siblings: siblings 
          };
          
          body += ' Household members: ' + siblings.map(s => {
            var tag = s.under18 ? 'Under 18' : '18+';
            var g = (s.under18 && !s.guardianSame && s.guardian) ? (' (guardian: '+s.guardian.name+')' ) : '';
            return s.name + ' ['+tag+']' + g;
          }).join('; ') + '.';
        }

        var payload={
          subject: subjectBase,
          body: body,
          start: { dateTime: startDT, timeZone: CONFIG.TIMEZONE },
          end:   { dateTime: endDT,   timeZone: CONFIG.TIMEZONE },
          expectedDate: selectedSlot.y + '-' + p2(selectedSlot.m) + '-' + p2(selectedSlot.d),
          location:{ displayName: apptType==='telehealth'?'video':'in-person' },
          attendees:[{ address: email, name: first+' '+last, type:'required' }],
          allowNewTimeProposals:true,
          transactionId: generateUUID(),
          dob: dob,
          over18: over18Choice,
          guardian: over18Choice === 'no' ? {
            name: guardianName,
            phone: guardianPhone,
            email: guardianEmail
          } : null,
          household: householdPayload
        };

        console.log('[BOOK payload]', payload);

        var url=withKey(CONFIG.BOOK_APPOINTMENT_URL, CONFIG.BOOK_APPOINTMENT_KEY);
        var resp=await fetch(url,{
          method:'POST',
          headers:{'Content-Type':'application/json','Accept':'application/json'},
          body: JSON.stringify(payload)
        });

        if(!resp.ok){
          var t=''; 
          try{ t=await resp.text(); }catch(_){}
          throw new Error('Failed to book ('+resp.status+') '+t);
        }

        showSuccess();
        setTimeout(clearForm, 1500);
      }catch(err){
        console.error(err);
        showError('There was an error booking your appointment. Please try again or call us directly.');
      }
      finally{
        btn.disabled=false; 
        spin.classList.add('hidden');
      }
    }

    function clearForm(){
      document.getElementById('bookingForm').reset();
      document.getElementById('guardianInfo').classList.add('hidden');
      document.getElementById('siblingsWrap').classList.add('hidden');
      document.getElementById('siblingsList').innerHTML='';
      document.getElementById('inPersonDetails').classList.add('hidden');
      document.getElementById('timeSlots').innerHTML='';
      selectedSlot=null;
      availableSlots = [];
      hideMessages();
      var allChips = document.querySelectorAll('.slot-chip');
      for (var k=0;k<allChips.length;k++) allChips[k].classList.remove('selected');
      var cards=document.querySelectorAll('.radio-option');
      for(var i=0;i<cards.length;i++) cards[i].classList.remove('selected');
    }

    function showSuccess(){ 
      hideMessages(); 
      var el=document.getElementById('successMessage'); 
      el.style.display='block'; 
      setTimeout(function(){ el.style.display='none'; }, 5000); 
    }
    
    function showError(msg){ 
      hideMessages(); 
      var el=document.getElementById('errorMessage'); 
      el.textContent=msg; 
      el.style.display='block'; 
      setTimeout(function(){ el.style.display='none'; }, 6000); 
    }
    
    function hideMessages(){ 
      document.getElementById('successMessage').style.display='none'; 
      document.getElementById('errorMessage').style.display='none'; 
    }
  </script>
</body>
</html>