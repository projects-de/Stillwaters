<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Still Waters Counseling - Book Your Appointment</title>
  <!-- Single-file build | v2025-09-06_clean -->
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --primary-color: #2c5282;
      --secondary-color: #4299e1;
      --accent-color: #63b3ed;
      --success-color: #48bb78;
      --danger-color: #f56565;
      --light-bg: #f7fafc;
      --white: #ffffff;
      --gray-light: #e2e8f0;
      --gray-medium: #718096;
      --gray-dark: #2d3748;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      line-height: 1.6;
    }

    .container { background: var(--white); border-radius: 20px; box-shadow: var(--shadow-lg); max-width: 900px; width: 100%; overflow: hidden; animation: slideIn 0.5s ease-out; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(30px);} to { opacity: 1; transform: translateY(0);} }

    .header { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: var(--white); padding: 40px 30px; text-align: center; }
    .header h1 { font-size: 2.5rem; margin-bottom: 10px; font-weight: 300; letter-spacing: -1px; }
    .header p { font-size: 1.1rem; opacity: 0.95; }

    .emergency-notice { background: var(--danger-color); color: var(--white); padding: 15px 30px; text-align: center; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 10px; }
    .emergency-notice svg { width: 24px; height: 24px; fill: currentColor; }

    .form-container { padding: 40px 30px; }
    .form-section { margin-bottom: 35px; animation: fadeIn 0.5s ease-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .form-section h2 { color: var(--gray-dark); font-size: 1.5rem; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid var(--gray-light); font-weight: 600; }

    .form-group { margin-bottom: 20px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

    label { display: block; color: var(--gray-dark); font-weight: 500; margin-bottom: 8px; font-size: 0.95rem; }
    .required { color: var(--danger-color); }

    input[type="text"], input[type="email"], input[type="tel"], input[type="date"], input[type="time"], select, textarea { width: 100%; padding: 12px 15px; border: 2px solid var(--gray-light); border-radius: 10px; font-size: 1rem; transition: all 0.3s ease; background: var(--white); }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--secondary-color); box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1); }
    textarea { resize: vertical; min-height: 100px; }

    .radio-group { display: flex; gap: 30px; margin-top: 10px; }
    .radio-option { display: flex; align-items: center; cursor: pointer; padding: 15px 25px; border: 2px solid var(--gray-light); border-radius: 10px; transition: all 0.3s ease; flex: 1; background: var(--white); }
    .radio-option:hover { border-color: var(--secondary-color); background: var(--light-bg); }
    .radio-option input[type="radio"] { margin-right: 10px; width: 20px; height: 20px; cursor: pointer; }
    .radio-option.selected { border-color: var(--secondary-color); background: linear-gradient(135deg, rgba(66, 153, 225, 0.1), rgba(99, 179, 237, 0.1)); }

    .checkbox-group { display: flex; align-items: flex-start; margin: 20px 0; }
    .checkbox-group input[type="checkbox"] { margin-right: 10px; margin-top: 5px; width: 20px; height: 20px; cursor: pointer; }
    .checkbox-group label { cursor: pointer; margin-bottom: 0; flex: 1; }

    .time-slots { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-top: 15px; }
    .time-slot { padding: 15px; border: 2px solid var(--gray-light); border-radius: 10px; cursor: pointer; transition: all 0.3s ease; background: var(--white); }
    .time-slot:hover { border-color: var(--secondary-color); transform: translateY(-2px); box-shadow: var(--shadow); }
    .time-slot.selected { background: var(--secondary-color); color: var(--white); border-color: var(--secondary-color); }
    .time-slot .date { font-weight: 600; font-size: 1rem; margin-bottom: 5px; }
    .time-slot .time { font-size: 0.9rem; opacity: 0.9; }

    .hidden { display: none !important; }

    .button-group { display: flex; gap: 15px; margin-top: 40px; justify-content: center; }
    .btn { padding: 15px 40px; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px; }
    .btn-primary { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: var(--white); box-shadow: 0 4px 15px rgba(66, 153, 225, 0.3); }
    .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(66, 153, 225, 0.4); }
    .btn-secondary { background: var(--white); color: var(--primary-color); border: 2px solid var(--primary-color); }
    .btn-secondary:hover { background: var(--light-bg); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .loading-spinner { width: 20px; height: 20px; border: 3px solid var(--white); border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; margin-left: 10px; display: inline-block; vertical-align: middle; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .success-message { background: var(--success-color); color: var(--white); padding: 20px; border-radius: 10px; text-align: center; margin: 20px 0; display: none; animation: slideDown 0.5s ease-out; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-20px);} to { opacity: 1; transform: translateY(0);} }
    .error-message { background: var(--danger-color); color: var(--white); padding: 15px; border-radius: 10px; text-align: center; margin: 20px 0; display: none; }

    .time-picker { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; padding: 15px; background: var(--light-bg); border-radius: 10px; }
    .time-picker label { font-size: 0.9rem; color: var(--gray-medium); }

    @media (max-width: 768px) {
      .header h1 { font-size: 2rem; }
      .form-row { grid-template-columns: 1fr; }
      .radio-group { flex-direction: column; }
      .time-slots { grid-template-columns: 1fr; }
      .button-group { flex-direction: column; }
      .btn { width: 100%; }
      .time-picker { grid-template-columns: 1fr; }
    }

    .loading-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 9999; }
    .loading-overlay.active { display: flex; }
    .loading-content { background: var(--white); padding: 30px; border-radius: 15px; text-align: center; box-shadow: var(--shadow-lg); }
    .loading-content .spinner { width: 50px; height: 50px; border: 5px solid var(--gray-light); border-top-color: var(--secondary-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Still Waters Counseling</h1>
      <p>Schedule Your Intake Appointment</p>
    </div>

    <div class="emergency-notice">
      <svg viewBox="0 0 24 24"><path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/></svg>
      <span>If you are experiencing an emergency, please dial 911 immediately</span>
    </div>

    <form id="bookingForm" class="form-container" novalidate>
      <div id="successMessage" class="success-message">Appointment booked successfully! You'll receive a confirmation soon.</div>
      <div id="errorMessage" class="error-message">There was an error booking your appointment. Please try again.</div>

      <div class="form-section">
        <h2>Client Information</h2>
        <div class="form-row">
          <div class="form-group">
            <label for="firstName">First Name <span class="required">*</span></label>
            <input type="text" id="firstName" name="firstName" required />
          </div>
          <div class="form-group">
            <label for="lastName">Last Name <span class="required">*</span></label>
            <input type="text" id="lastName" name="lastName" required />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="email">Email Address <span class="required">*</span></label>
            <input type="email" id="email" name="email" required />
          </div>
          <div class="form-group">
            <label for="phone">Phone Number <span class="required">*</span></label>
            <input type="tel" id="phone" name="phone" required placeholder="123-456-7890" />
          </div>
        </div>
      </div>

      <div class="form-section">
        <h2>Appointment Type</h2>
        <div class="form-group">
          <label>Select your preferred appointment type <span class="required">*</span></label>
          <div class="radio-group">
            <div class="radio-option" data-type="telehealth">
              <input type="radio" id="telehealth" name="appointmentType" value="telehealth" required />
              <label for="telehealth">Telehealth (Video Call)</label>
            </div>
            <div class="radio-option" data-type="inperson">
              <input type="radio" id="inperson" name="appointmentType" value="inperson" required />
              <label for="inperson">In-Person Visit</label>
            </div>
          </div>
        </div>
      </div>

      <div id="inPersonDetails" class="form-section hidden">
        <h2>In-Person Visit Details</h2>
        <div class="form-group">
          <label for="address">Service Address <span class="required">*</span></label>
          <input type="text" id="address" name="address" placeholder="Full street address" />
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="unit">Apartment/Unit Number</label>
            <input type="text" id="unit" name="unit" placeholder="Apt, Suite, Unit #" />
          </div>
          <div class="form-group">
            <label for="parking">Parking Instructions</label>
            <input type="text" id="parking" name="parking" placeholder="Where to park" />
          </div>
        </div>
        <div class="form-group">
          <label for="entryNotes">Gate/Entry Notes</label>
          <textarea id="entryNotes" name="entryNotes" placeholder="Gate codes, building access details, etc."></textarea>
        </div>
        <div class="form-group">
          <label for="safetyConsiderations">Safety Considerations</label>
          <textarea id="safetyConsiderations" name="safetyConsiderations" placeholder="Any safety issues our clinician should know about"></textarea>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="arrivalWindow" name="arrivalWindow" />
          <label for="arrivalWindow">I understand the clinician will arrive within a 10-15 minute window around the start time</label>
        </div>
      </div>

      <div class="form-section">
        <h2>Select Appointment Time</h2>
        <div class="form-group">
          <button type="button" class="btn btn-secondary" id="loadSlotsBtn">Load Available Times</button>
        </div>
        <div id="timeSlots" class="time-slots"></div>

        <div id="timePickerSection" class="form-group hidden">
          <div class="time-picker">
            <div>
              <label for="startTime">Preferred Start Time <span class="required">*</span></label>
              <select id="startTime" name="startTime">
                <option value="">Select start time</option>
              </select>
            </div>
            <div>
              <label for="endTime">Preferred End Time <span class="required">*</span></label>
              <select id="endTime" name="endTime">
                <option value="">Select end time</option>
              </select>
            </div>
          </div>
          <small style="color: var(--gray-medium); margin-top: 10px; display: block;">Select your preferred 2-hour window within the available time slot</small>
        </div>
      </div>

      <div class="form-section">
        <h2>Additional Information</h2>
        <div class="form-group">
          <label for="alternateAvailability">Alternate Availability (Optional)</label>
          <textarea id="alternateAvailability" name="alternateAvailability" placeholder="If the available slots don't work, please describe your availability"></textarea>
        </div>
        <div class="form-group">
          <label for="additionalNotes">Additional Notes (Optional)</label>
          <textarea id="additionalNotes" name="additionalNotes" placeholder="Any other information you'd like us to know"></textarea>
        </div>
      </div>

      <div class="form-section">
        <h2>Consent & Acknowledgments</h2>
        <div class="checkbox-group">
          <input type="checkbox" id="consent" name="consent" required />
          <label for="consent">I consent to receive appointment reminders via text and email <span class="required">*</span></label>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="emergency" name="emergency" required />
          <label for="emergency">I confirm that I am not currently experiencing a medical or mental health emergency <span class="required">*</span></label>
        </div>
      </div>

      <div class="button-group">
        <button type="button" class="btn btn-secondary" id="clearFormBtn">Clear Form</button>
        <button type="submit" class="btn btn-primary" id="submitBtn">
          Book Appointment
          <span class="loading-spinner hidden" id="submitSpinner"></span>
        </button>
      </div>
    </form>
  </div>

  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
      <div class="spinner"></div>
      <p>Processing your request...</p>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    var CONFIG = {
      GET_SLOTS_URL: 'https://sw-function-b6c4h9cnexhbh4g3.canadacentral-01.azurewebsites.net/api/Calender',
      BOOK_APPOINTMENT_URL: 'https://sw-function-b6c4h9cnexhbh4g3.canadacentral-01.azurewebsites.net/api/CreateEvent',
      GET_SLOTS_KEY: '',           // leave blank for Anonymous
      BOOK_APPOINTMENT_KEY: '',    // put CreateEvent key here if protected
      TIMEZONE: 'Pacific Standard Time'
    };

    function withKey(url, key) {
      if (!key) return url;
      try { var u = new URL(url); u.searchParams.set('code', key); return u.toString(); }
      catch(e) { var sep = url.indexOf('?')>=0 ? '&' : '?'; return url + sep + 'code=' + encodeURIComponent(key); }
    }

    var selectedSlot = null;
    var selectedDate = null;
    var availableSlots = [];

    document.addEventListener('DOMContentLoaded', function () {
      document.getElementById('bookingForm').addEventListener('submit', handleSubmit);
      document.getElementById('loadSlotsBtn').addEventListener('click', loadAvailableSlots);
      document.getElementById('clearFormBtn').addEventListener('click', clearForm);

      var typeCards = document.querySelectorAll('.radio-option');
      for (var i=0;i<typeCards.length;i++) typeCards[i].addEventListener('click', function(){ selectAppointmentType(this.getAttribute('data-type')); });

      document.getElementById('phone').addEventListener('input', function (e) {
        var v = e.target.value.replace(/\D/g,'').slice(0,10);
        if (v.length>6) e.target.value = v.slice(0,3)+'-'+v.slice(3,6)+'-'+v.slice(6);
        else if (v.length>3) e.target.value = v.slice(0,3)+'-'+v.slice(3);
        else e.target.value = v;
      });

      document.getElementById('startTime').addEventListener('change', updateEndTimeOptions);
    });

    function generateUUID(){ return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){ var r=Math.random()*16|0, v=c==='x'?r:(r&0x3)|0x8; return v.toString(16).toUpperCase(); }); }

    function selectAppointmentType(type){
      var radio = document.getElementById(type==='telehealth'?'telehealth':'inperson');
      if (radio) radio.checked = true;
      var cards = document.querySelectorAll('.radio-option');
      for (var i=0;i<cards.length;i++) cards[i].classList.remove('selected');
      var chosen = document.querySelector('.radio-option[data-type="'+type+'"]');
      if (chosen) chosen.classList.add('selected');
      var inPerson = document.getElementById('inPersonDetails');
      if (type==='inperson'){ inPerson.classList.remove('hidden'); document.getElementById('address').required=true; document.getElementById('arrivalWindow').required=true; }
      else { inPerson.classList.add('hidden'); document.getElementById('address').required=false; document.getElementById('arrivalWindow').required=false; }
    }

    function parseSlotString(slotStr){
      var parts = slotStr.split(', ');
      var datePart = parts[0];
      var timePart = parts[1];
      var dt = datePart.split(' ');
      var day = parseInt(dt[0],10); var mon = dt[1]; var year = parseInt(dt[2],10);
      var monthMap = {Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11};
      var range = timePart.split(' - ');
      var startTimeStr = range[0]; var endTimeStr = range[1];
      return { date: new Date(year, monthMap[mon], day), dateStr: datePart, startTimeStr: startTimeStr, endTimeStr: endTimeStr, originalString: slotStr };
    }

    function convertTo24Hour(timeStr){ var t=timeStr.trim().split(' '), hm=t[0].split(':'), h=parseInt(hm[0],10), m=parseInt(hm[1],10), p=t[1]; if(p==='PM'&&h!==12)h+=12; if(p==='AM'&&h===12)h=0; return {hours:h, minutes:m}; }
    function p2(n){return (n<10?'0':'')+n;}
    function formatDateTimeForAPI(date,hour,minute){ return date.getFullYear()+'-'+p2(date.getMonth()+1)+'-'+p2(date.getDate())+'T'+p2(hour)+':'+p2(minute)+':00'; }
    function humanTimeDisplay(date, start, end){ var mons=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']; function t12(h,m){ var ap=h>=12?'pm':'am'; var hh=h%12===0?12:h%12; return hh+(m?':'+p2(m):'')+ap; } return date.getDate()+' '+mons[date.getMonth()]+' '+date.getFullYear()+', '+t12(start.hour,start.minute)+'–'+t12(end.hour,end.minute); }

    async function loadAvailableSlots(){
      var overlay=document.getElementById('loadingOverlay'); overlay.classList.add('active');
      var url = withKey(CONFIG.GET_SLOTS_URL, CONFIG.GET_SLOTS_KEY);
      try{
        var resp = await fetch(url, { method:'GET', headers:{'Accept':'application/json'} });
        var text = await resp.text();
        console.log('[GET /Calender]', resp.status, text);
        if(!resp.ok) throw new Error('Failed to load slots ('+resp.status+')');
        var data = text? JSON.parse(text):{};
        var list = Array.isArray(data)? data : (Array.isArray(data.free_slots)? data.free_slots : (Array.isArray(data.freeSlots)? data.freeSlots : (Array.isArray(data.slots)? data.slots : [])));
        availableSlots = list.map(parseSlotString);
        displayAvailableSlots(availableSlots);
      }catch(e){ console.error(e); showError('Failed to load available appointment times. Please try again.'); }
      finally{ overlay.classList.remove('active'); }
    }

    function displayAvailableSlots(slots){
      var c=document.getElementById('timeSlots'); c.innerHTML='';
      if(!slots||!slots.length){ c.innerHTML='<p>No available slots returned by the server. Please check back later.</p>'; return; }
      for(var i=0;i<slots.length;i++){
        var s=slots[i]; var el=document.createElement('div'); el.className='time-slot'; el.setAttribute('data-slot-index', String(i));
        el.innerHTML='<div class="date">'+s.dateStr+'</div><div class="time">'+s.startTimeStr+' - '+s.endTimeStr+'</div>';
        (function(slot, idx){ el.addEventListener('click', function(){ selectTimeSlot(slot, idx); }); })(s, i);
        c.appendChild(el);
      }
    }

    function generateTimeOptions(startHour, endHour){ var out=[]; for(var h=startHour; h<=endHour; h++){ for(var m=0;m<60;m+=30){ if(h===endHour && m>0) break; var disp=h>12?h-12:(h===0?12:h); var ap=h>=12?'PM':'AM'; out.push({display: disp+':'+p2(m)+' '+ap, hour:h, minute:m}); } } return out; }

    function selectTimeSlot(slot, index){
      var cards=document.querySelectorAll('.time-slot'); for(var i=0;i<cards.length;i++) cards[i].classList.remove('selected');
      var chosen=document.querySelector('[data-slot-index="'+index+'"];');
      if(!chosen){ chosen=document.querySelector('[data-slot-index="'+index+'"]'); }
      if(chosen) chosen.classList.add('selected');
      selectedSlot=slot; selectedDate=slot.date; document.getElementById('timePickerSection').classList.remove('hidden');
      var start=convertTo24Hour(slot.startTimeStr), end=convertTo24Hour(slot.endTimeStr), lastStart=end.hours-2;
      var startSel=document.getElementById('startTime'); startSel.innerHTML='<option value="">Select start time</option>';
      var opts=generateTimeOptions(start.hours, lastStart);
      for(var j=0;j<opts.length;j++){ var o=opts[j]; var op=document.createElement('option'); op.value=JSON.stringify(o); op.textContent=o.display; startSel.appendChild(op);} 
      document.getElementById('endTime').innerHTML='<option value="">Select end time</option>';
    }

    function updateEndTimeOptions(){ var s=document.getElementById('startTime').value; var endSel=document.getElementById('endTime'); if(!s){ endSel.innerHTML='<option value="">Select end time</option>'; return; } var st=JSON.parse(s); var eh=st.hour+2, em=st.minute; var disp= (eh>12?eh-12:(eh===0?12:eh))+':'+p2(em)+' '+(eh>=12?'PM':'AM'); endSel.innerHTML=''; var op=document.createElement('option'); op.value=JSON.stringify({hour:eh,minute:em,display:disp}); op.textContent=disp; op.selected=true; endSel.appendChild(op); }

    function validateForm(){ hideMessages(); if(!selectedSlot){ showError('Please select an appointment date'); return false; } if(!document.getElementById('startTime').value || !document.getElementById('endTime').value){ showError('Please select your preferred appointment times'); return false; } var appt=document.querySelector('input[name="appointmentType"]:checked'); if(!appt){ showError('Please select an appointment type'); return false; } if(appt.value==='inperson'){ if(!document.getElementById('address').value.trim()){ showError('Please provide the service address for in-person visit'); return false; } if(!document.getElementById('arrivalWindow').checked){ showError('Please acknowledge the 10-15 minute arrival window'); return false; } } if(!document.getElementById('consent').checked){ showError('Please consent to receive appointment reminders'); return false; } if(!document.getElementById('emergency').checked){ showError('Please confirm you are not experiencing an emergency'); return false; } var email=document.getElementById('email').value.trim(); if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ showError('Please enter a valid email address'); return false; } return true; }

    async function handleSubmit(e){
      e.preventDefault(); if(!validateForm()) return;
      var btn=document.getElementById('submitBtn'), spin=document.getElementById('submitSpinner'); btn.disabled=true; spin.classList.remove('hidden');
      try{
        var form=new FormData(e.target);
        var first=String(form.get('firstName')||'').trim(), last=String(form.get('lastName')||'').trim(), email=String(form.get('email')||'').trim(), phone=String(form.get('phone')||'').trim();
        var apptType=String(form.get('appointmentType')||'').trim();
        var st=JSON.parse(document.getElementById('startTime').value), et=JSON.parse(document.getElementById('endTime').value);
        var startDT=formatDateTimeForAPI(selectedDate, st.hour, st.minute), endDT=formatDateTimeForAPI(selectedDate, et.hour, et.minute);
        var subject=(apptType==='telehealth'?'Telehealth':'In-person')+' appointment';
        var body='Appointment scheduled for '+apptType+' with '+first+' on '+humanTimeDisplay(selectedDate, st, et)+'. Contact: '+phone+'.';
        if(apptType==='inperson'){
          var addr=String(form.get('address')||''), unit=String(form.get('unit')||''), entry=String(form.get('entryNotes')||''), park=String(form.get('parking')||''), safety=String(form.get('safetyConsiderations')||'');
          var ack=document.getElementById('arrivalWindow').checked?'Yes':'No';
          body += ' Address: '+addr+(unit?(', '+unit):'')+'.'; if(entry) body+=' Entry notes: '+entry+'.'; if(park) body+=' Parking: '+park+'.'; if(safety) body+=' Safety considerations: '+safety+'.'; body+=' Arrival window acknowledged: '+ack+'.';
        }
        var alt=String(form.get('alternateAvailability')||''), notes=String(form.get('additionalNotes')||''); if(alt) body+=' Alternate availability: '+alt+'.'; if(notes) body+=' Additional notes: '+notes+'.';
        var payload={ start:startDT, end:endDT, subject:subject, body:body, timeZone:CONFIG.TIMEZONE, location:{ displayName: apptType==='telehealth'?'video':'in-person' }, attendees:[{ address: email, name: first+' '+last, type:'required' }], allowNewTimeProposals:true, transactionId: generateUUID() };
        var url=withKey(CONFIG.BOOK_APPOINTMENT_URL, CONFIG.BOOK_APPOINTMENT_KEY);
        var resp=await fetch(url,{ method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json'}, body: JSON.stringify(payload) });
        if(!resp.ok){ var t=''; try{ t=await resp.text(); }catch(_){} throw new Error('Failed to book ('+resp.status+') '+t); }
        showSuccess(); setTimeout(clearForm, 1500);
      }catch(err){ console.error(err); showError('There was an error booking your appointment. Please try again or call us directly.'); }
      finally{ btn.disabled=false; spin.classList.add('hidden'); }
    }

    function clearForm(){ document.getElementById('bookingForm').reset(); document.getElementById('inPersonDetails').classList.add('hidden'); document.getElementById('timePickerSection').classList.add('hidden'); document.getElementById('timeSlots').innerHTML=''; var cards=document.querySelectorAll('.radio-option'); for(var i=0;i<cards.length;i++) cards[i].classList.remove('selected'); selectedSlot=null; selectedDate=null; hideMessages(); }
    function showSuccess(){ hideMessages(); var el=document.getElementById('successMessage'); el.style.display='block'; setTimeout(function(){ el.style.display='none'; }, 5000); }
    function showError(msg){ hideMessages(); var el=document.getElementById('errorMessage'); el.textContent=msg; el.style.display='block'; setTimeout(function(){ el.style.display='none'; }, 6000); }
    function hideMessages(){ document.getElementById('successMessage').style.display='none'; document.getElementById('errorMessage').style.display='none'; }
  </script>
</body>
</html>