<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Still Waters Counseling - Book Your Appointment</title>

  <style>
    /* --- Reset & Tokens --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root{
      /* Palette */
      --primary: #4f46e5;
      --primary-700:#4338ca;
      --secondary:#06b6d4;
      --accent:  #38bdf8;
      --success: #10b981;
      --danger:  #ef4444;

      /* Neutrals */
      --bg:      #f6f7fb;
      --card:    #ffffff;
      --muted:   #6b7280;
      --text:    #0f172a;
      --text-soft:#334155;
      --border:  #e5e7eb;

      /* Elevation */
      --shadow:  0 8px 24px rgba(2, 6, 23, .08);
      --shadow-lg: 0 18px 40px rgba(2, 6, 23, .12);

      /* Focus ring */
      --ring: rgba(79, 70, 229, .45);
      --ring-strong: rgba(6, 182, 212, .45);

      /* Radii */
      --r-lg: 20px;
      --r-xl: 24px;
      --r-full: 9999px;

      /* Transitions */
      --t-fast: .15s ease;
      --t-med: .25s ease;

      /* Slot sizing */
      --chip-min: 120px;
    }

    @media (prefers-color-scheme: dark){
      :root{
        --bg:      #0b1220;
        --card:    #0f172a;
        --text:    #e5e7eb;
        --text-soft:#cbd5e1;
        --border:  #1f2937;
        --shadow:  0 8px 24px rgba(0,0,0,.5);
        --shadow-lg: 0 18px 50px rgba(0,0,0,.55);
        --ring: rgba(56, 189, 248, .5);
        --ring-strong: rgba(99, 102, 241, .55);
      }
    }

    /* --- Page --- */
    body{
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
      padding: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(79,70,229,.14), transparent 60%),
        radial-gradient(800px 500px at 90% 10%, rgba(6,182,212,.16), transparent 55%),
        linear-gradient(180deg, var(--bg), var(--bg));
    }

    .container{
      width: 100%;
      max-width: 1100px;
      background: linear-gradient(0deg, rgba(255,255,255,.6), rgba(255,255,255,.6)) , var(--card);
      backdrop-filter: saturate(120%) blur(6px);
      border: 1px solid var(--border);
      border-radius: var(--r-xl);
      box-shadow: var(--shadow-lg);
      overflow: hidden;
      animation: slideIn .4s ease-out both;
    }
    @keyframes slideIn{ from{ opacity:0; transform: translateY(18px);} to{ opacity:1; transform: translateY(0);} }

    /* --- Header --- */
    .header{
      padding: 40px 32px;
      color: #fff;
      background:
        radial-gradient(800px 200px at 20% -20%, rgba(56,189,248,.35), transparent 60%),
        linear-gradient(135deg, var(--primary), var(--secondary));
    }
    .header h1{
      font-size: clamp(1.8rem, 2.6vw, 2.6rem);
      font-weight: 700;
      letter-spacing: -0.02em;
      margin-bottom: 8px;
    }
    .header p{ font-size: 1.05rem; opacity: .95; }

    /* --- Emergency banner --- */
    .emergency-notice{
      display: flex; align-items: center; justify-content: center; gap: 10px;
      padding: 14px 18px; color: #fff;
      background: linear-gradient(135deg, #f43f5e, #ef4444);
      border-bottom: 1px solid rgba(255,255,255,.25);
      font-weight: 600;
    }
    .emergency-notice svg{ width: 22px; height: 22px; }

    /* --- Shared form styles --- */
    .form-container{ padding: 32px; }
    .form-section{ margin-bottom: 22px; }
    .form-section h3{ font-size: 1.05rem; font-weight: 800; color: var(--text); margin-bottom: 12px; }
    .form-group{ margin-bottom: 14px; }
    .form-row{ display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }

    label{
      display: block;
      color: var(--text-soft);
      font-weight: 600;
      margin-bottom: 8px;
      font-size: .95rem;
    }
    .required{ color: var(--danger); }

    input[type="text"],
    input[type="email"],
    input[type="tel"],
    input[type="date"],
    textarea{
      width: 100%;
      appearance: none;
      background: var(--card);
      color: var(--text);
      border: 1.5px solid var(--border);
      border-radius: 12px;
      padding: 12px 14px;
      font-size: 1rem;
      transition: border-color var(--t-fast), box-shadow var(--t-fast), background var(--t-fast), transform var(--t-fast);
    }
    textarea{ min-height: 110px; resize: vertical; }
    input:hover, textarea:hover{ border-color: color-mix(in oklab, var(--primary) 25%, var(--border)); }
    input:focus, textarea:focus{
      outline: none; border-color: var(--primary); box-shadow: 0 0 0 4px var(--ring);
    }

    .radio-group{ display:flex; gap:14px; flex-wrap:wrap; margin-top: 8px; }
    .radio-option{
      display:flex; align-items:center; gap:10px;
      background: var(--card);
      border: 1.5px solid var(--border);
      border-radius: 12px;
      padding: 12px 16px;
      cursor: pointer;
      transition: transform var(--t-fast), box-shadow var(--t-fast), border-color var(--t-fast), background var(--t-fast);
      user-select: none;
    }
    .radio-option:hover{ transform: translateY(-1px); border-color: var(--primary); box-shadow: var(--shadow); }
    .radio-option input[type="radio"]{ width: 18px; height: 18px; }

    .checkbox-group{ display:flex; align-items:flex-start; gap:10px; margin: 10px 0; }
    .checkbox-group input[type="checkbox"]{ width:18px; height:18px; margin-top: 3px; cursor: pointer; }

    /* --- Time slots (shared visual) --- */
    .time-slots{ display: grid; grid-template-columns: 1fr; gap: 16px; margin-top: 14px; }
    .time-slot{
      background: var(--card);
      border: 1.5px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      box-shadow: var(--shadow);
    }
    .time-slot .date{ font-weight: 800; font-size: 1rem; color: var(--text); margin-bottom: 6px; }
    .time-slot .range{ color: var(--muted); font-size: .95rem; margin-bottom: 12px; }
    .slot-grid{ display: grid; grid-template-columns: repeat(auto-fill, minmax(var(--chip-min), 1fr)); gap: 10px; }
    .slot-chip{
      padding: 10px 12px; text-align: center; border-radius: var(--r-full);
      background: linear-gradient(180deg, #ffffff, #fafafa);
      color: var(--text); border: 1.5px solid var(--border);
      font-weight: 600; font-size: .95rem; cursor: pointer;
      transition: transform var(--t-fast), box-shadow var(--t-fast), border-color var(--t-fast), background var(--t-fast), color var(--t-fast);
    }
    .slot-chip:hover{ transform: translateY(-1px); border-color: var(--primary); box-shadow: var(--shadow); }

    /* --- Two-Flow Layout --- */
    .flow-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 22px;
      margin-top: 6px;
    }
    .flow-card{
      background: var(--card);
      border: 1.5px solid var(--border);
      border-radius: 16px;
      padding: 18px;
      box-shadow: var(--shadow);
    }
    .flow-title{
      font-weight: 900;
      color: var(--text);
      margin-bottom: 4px;
      font-size: 1.1rem;
      letter-spacing: .2px;
    }
    .flow-intro{ color: var(--muted); font-size: .95rem; margin-bottom: 12px; }
    .flow-toggle{
      display:flex; gap:10px; align-items:flex-start;
      background: color-mix(in oklab, var(--accent) 10%, #fff);
      border: 1px dashed color-mix(in oklab, var(--accent) 40%, #fff);
      padding: 12px; border-radius: 12px; margin-bottom: 14px;
    }
    .flow-toggle input[type="checkbox"]{ margin-top: 2px; }
    .flow-section{ margin-bottom: 18px; }

    /* Individuals list (re-using sibling card visuals) */
    .person-card{
      background: var(--card);
      border: 1.5px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      box-shadow: var(--shadow);
      margin-bottom: 12px;
    }
    .person-header{ display:flex; justify-content: space-between; align-items:center; margin-bottom: 10px; }
    .person-title{ font-weight: 700; color: var(--text); }

    /* Buttons */
    .button-group{ display:flex; gap: 12px; justify-content:center; margin-top: 24px; flex-wrap: wrap; }
    .btn{
      border: 0; border-radius: 12px;
      padding: 14px 22px;
      font-size: 1rem; font-weight: 800; letter-spacing: .02em;
      cursor: pointer;
      transition: transform var(--t-med), box-shadow var(--t-med), opacity var(--t-fast);
    }
    .btn-primary{
      color:#fff;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      box-shadow: 0 10px 28px rgba(79,70,229,.35);
    }
    .btn-primary:hover{ transform: translateY(-2px); box-shadow: 0 16px 40px rgba(79,70,229,.45); }
    .btn-secondary{
      color: var(--primary);
      background: linear-gradient(180deg, #ffffff, #fafafa);
      border: 1.5px solid color-mix(in oklab, var(--primary) 22%, var(--border));
    }
    .btn-secondary:hover{ transform: translateY(-2px); box-shadow: var(--shadow); }
    .btn-pill{ border-radius: var(--r-full); padding: 10px 16px; font-weight: 800; }

    /* Alerts (for when wired up) */
    .success-message,
    .error-message{
      display:none;
      border-radius: 12px;
      padding: 14px 16px;
      font-weight: 700;
      margin: 14px 0;
      box-shadow: var(--shadow);
    }
    .success-message{ background: color-mix(in oklab, var(--success) 18%, #ecfdf5); color: #065f46; border: 1.5px solid color-mix(in oklab, var(--success) 40%, #ffffff); }
    .error-message{ background: color-mix(in oklab, var(--danger) 18%, #fef2f2); color: #7f1d1d; border: 1.5px solid color-mix(in oklab, var(--danger) 40%, #ffffff); }

    /* Confirmation card (for when wired up) */
    .confirm-card{
      display:none;
      background: color-mix(in oklab, var(--success) 10%, #fff);
      border: 1.5px solid color-mix(in oklab, var(--success) 30%, #fff);
      border-radius: 16px;
      padding: 18px;
      box-shadow: var(--shadow);
      margin: 16px 0;
    }
    .confirm-card.visible{ display:block; }
    .confirm-card h3{ font-size:1.15rem; font-weight:800; margin-bottom:8px; color:#065f46; }
    .confirm-row{ display:flex; gap:10px; align-items:flex-start; margin:6px 0; color:#064e3b; }
    .confirm-row b{ min-width:130px; display:inline-block; color:#065f46; }
    .confirm-actions{ display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; }
    .confirm-actions .btn{ padding:10px 16px; font-size:.95rem; }

    /* Responsive */
    @media (max-width: 900px){
      .flow-grid{ grid-template-columns: 1fr; }
      .form-row{ grid-template-columns: 1fr; }
      .btn{ width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>Still Waters Counseling</h1>
      <p>Schedule Your Intake Appointment</p>
    </div>

    <!-- Emergency banner -->
    <div class="emergency-notice">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/></svg>
      <span>If you are experiencing an emergency, please dial 911 immediately</span>
    </div>

    <!-- Form -->
    <form id="bookingForm" class="form-container" novalidate>
      <!-- Alerts (will show after wiring) -->
      <div id="successMessage" class="success-message">Appointment booked successfully! You'll receive a confirmation soon.</div>
      <div id="errorMessage" class="error-message">There was an error booking your appointment. Please try again.</div>

      <!-- Confirmation (will show after wiring) -->
      <div id="confirmationCard" class="confirm-card" aria-live="polite">
        <h3>You're booked! 🎉</h3>
        <div class="confirm-row"><b>Date & time</b><span id="confWhen">—</span></div>
        <div class="confirm-row"><b>Counselor</b><span id="confCounselor">—</span></div>
        <div class="confirm-row" id="confTeleRow" style="display:none;"><b>Telehealth</b>
          <span><a id="confTeleLink" href="#" target="_blank" rel="noopener">Join video session</a></span>
        </div>
        <div class="confirm-row" id="confInPersonRow" style="display:none;"><b>Visit info</b>
          <span id="confVisitText">We’ll send directions and arrival details via email/text.</span>
        </div>
        <div class="confirm-actions">
          <a id="confOutlookLink" class="btn btn-secondary btn-pill" href="#" target="_blank" rel="noopener">Open in Outlook</a>
          <button id="confBookAnother" type="button" class="btn btn-primary btn-pill">Book another</button>
        </div>
      </div>

      <!-- TWO FLOWS -->
      <div class="flow-grid">
        <!-- LEFT: Individual (Self) -->
        <div class="flow-card" id="flowSelf">
          <div class="flow-title">Individual (18+)</div>
          <div class="flow-intro">For adults scheduling for themselves.</div>

          <!-- Flow toggle -->
          <div class="flow-toggle">
            <input type="checkbox" id="selfConfirm18"/>
            <label for="selfConfirm18">I am an individual seeking services and confirm that I am over the age of 18 <span class="required">*</span></label>
          </div>

          <!-- Your information -->
          <div class="flow-section">
            <h3>Your Information</h3>
            <div class="form-row">
              <div class="form-group">
                <label for="selfFirstName">First Name <span class="required">*</span></label>
                <input type="text" id="selfFirstName" />
              </div>
              <div class="form-group">
                <label for="selfLastName">Last Name <span class="required">*</span></label>
                <input type="text" id="selfLastName" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="selfEmail">Email Address <span class="required">*</span></label>
                <input type="email" id="selfEmail" />
              </div>
              <div class="form-group">
                <label for="selfPhone">Phone Number <span class="required">*</span></label>
                <input type="tel" id="selfPhone" placeholder="123-456-7890" />
              </div>
            </div>
            <div class="form-group">
              <label for="selfDob">BirthDate <span class="required">*</span></label>
              <input type="date" id="selfDob" />
            </div>
          </div>

          <!-- Appointment Type -->
          <div class="flow-section">
            <h3>Preferred Appointment Type <span class="required">*</span></h3>
            <div class="radio-group">
              <label class="radio-option">
                <input type="radio" name="apptTypeSelf" value="home" />
                <span>At Home – In Person</span>
              </label>
              <label class="radio-option">
                <input type="radio" name="apptTypeSelf" value="office" />
                <span>At Office – In Person</span>
              </label>
            </div>
          </div>

          <!-- Available Slots -->
          <div class="flow-section">
            <h3>Available Slots</h3>
            <div class="form-group">
              <button type="button" class="btn btn-secondary btn-pill" id="loadSlotsSelfBtn">Load Available Times</button>
            </div>
            <div id="timeSlotsSelf" class="time-slots"></div>
          </div>

          <!-- Additional Info -->
          <div class="flow-section">
            <h3>Additional Information</h3>
            <div class="form-group">
              <label for="selfAltAvailability">Alternate Availability (Optional)</label>
              <textarea id="selfAltAvailability" placeholder="If the available slots don't work, describe your availability"></textarea>
            </div>
            <div class="form-group">
              <label for="selfNotes">Additional Notes (Optional)</label>
              <textarea id="selfNotes" placeholder="Any other information you'd like us to know"></textarea>
            </div>
          </div>

          <!-- Consent -->
          <div class="flow-section">
            <h3>Consent &amp; Acknowledgments</h3>
            <label class="checkbox-group">
              <input type="checkbox" id="selfConsent"/>
              <span>I consent to receive appointment reminders via text and email <span class="required">*</span></span>
            </label>
            <label class="checkbox-group">
              <input type="checkbox" id="selfEmergency"/>
              <span>I confirm that I am not currently experiencing a medical or mental health emergency <span class="required">*</span></span>
            </label>
          </div>
        </div>

        <!-- RIGHT: Parent / Guardian -->
        <div class="flow-card" id="flowGuardian">
          <div class="flow-title">Parent or Guardian (18+)</div>
          <div class="flow-intro">For adults scheduling for one or more individuals.</div>

          <!-- Flow toggle -->
          <div class="flow-toggle">
            <input type="checkbox" id="guardianConfirm18"/>
            <label for="guardianConfirm18">I am parent or guardian of an individual(s) seeking services and confirm I am over the age of 18 <span class="required">*</span></label>
          </div>

          <!-- Guardian info -->
          <div class="flow-section">
            <h3>Parent/Guardian Information</h3>
            <div class="form-row">
              <div class="form-group">
                <label for="guardFirstName">First Name (Parent or Guardian) <span class="required">*</span></label>
                <input type="text" id="guardFirstName" />
              </div>
              <div class="form-group">
                <label for="guardLastName">Last Name (Parent or Guardian) <span class="required">*</span></label>
                <input type="text" id="guardLastName" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="guardEmail">Email Address (Parent or Guardian) <span class="required">*</span></label>
                <input type="email" id="guardEmail" />
              </div>
              <div class="form-group">
                <label for="guardPhone">Phone Number (Parent or Guardian) <span class="required">*</span></label>
                <input type="tel" id="guardPhone" placeholder="123-456-7890" />
              </div>
            </div>
          </div>

          <!-- Individuals seeking services -->
          <div class="flow-section">
            <h3><b>Individuals Seeking Services</b></h3>

            <!-- One individual row to start -->
            <div id="individualsList">
              <div class="person-card">
                <div class="person-header">
                  <span class="person-title">Individual</span>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label>First Name <span class="required">*</span></label>
                    <input type="text" />
                  </div>
                  <div class="form-group">
                    <label>Last Name <span class="required">*</span></label>
                    <input type="text" />
                  </div>
                </div>
                <div class="form-group">
                  <label>BirthDate <span class="required">*</span></label>
                  <input type="date" />
                </div>
              </div>
            </div>

            <button type="button" class="btn btn-secondary btn-pill" id="addIndividualBtn">+ Individuals</button>
          </div>

          <!-- Appointment Type -->
          <div class="flow-section">
            <h3>Preferred Appointment Type <span class="required">*</span></h3>
            <div class="radio-group">
              <label class="radio-option">
                <input type="radio" name="apptTypeGuardian" value="home" />
                <span>At Home – In Person</span>
              </label>
              <label class="radio-option">
                <input type="radio" name="apptTypeGuardian" value="office" />
                <span>At Office – In Person</span>
              </label>
            </div>
          </div>

          <!-- Available Slots -->
          <div class="flow-section">
            <h3>Available Slots</h3>
            <div class="form-group">
              <button type="button" class="btn btn-secondary btn-pill" id="loadSlotsGuardianBtn">Load Available Times (3-hour blocks)</button>
            </div>
            <div id="timeSlotsGuardian" class="time-slots"></div>
          </div>

          <!-- Additional Info -->
          <div class="flow-section">
            <h3>Additional Information</h3>
            <div class="form-group">
              <label for="guardAltAvailability">Alternate Availability (Optional)</label>
              <textarea id="guardAltAvailability" placeholder="If the available slots don't work, describe your availability"></textarea>
            </div>
            <div class="form-group">
              <label for="guardNotes">Additional Notes (Optional)</label>
              <textarea id="guardNotes" placeholder="Any other information you'd like us to know"></textarea>
            </div>
          </div>

          <!-- Consent -->
          <div class="flow-section">
            <h3>Consent &amp; Acknowledgments</h3>
            <label class="checkbox-group">
              <input type="checkbox" id="guardConsent"/>
              <span>I consent to receive appointment reminders via text and email <span class="required">*</span></span>
            </label>
            <label class="checkbox-group">
              <input type="checkbox" id="guardEmergency"/>
              <span>I confirm that I am not currently experiencing a medical or mental health emergency <span class="required">*</span></span>
            </label>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="button-group">
        <button type="button" class="btn btn-secondary">Clear Form</button>
        <button type="submit" class="btn btn-primary">Book Appointment</button>
      </div>
    </form>
  </div>



<script>
/* ===== CONFIG ===== */
const CONFIG = {
  GET_SLOTS_URL: 'https://sw-function-b6c4h9cnexhbh4g3.canadacentral-01.azurewebsites.net/api/Calender',
  BOOK_APPOINTMENT_URL: 'https://sw-function-b6c4h9cnexhbh4g3.canadacentral-01.azurewebsites.net/api/CreateEvent',
  GET_SLOTS_KEY: '',
  BOOK_APPOINTMENT_KEY: '',
  TIMEZONE: 'Central Standard Time',
  SLOT_MINUTES: 20,
  HOUSEHOLD_BLOCK_MINUTES: 180
};

/* ===== State ===== */
let selectedSlot = { self: null, guardian: null };
let availableSlots = [];

/* ===== Utilities ===== */
function withKey(url, key) {
  if (!key) return url;
  try { const u = new URL(url); u.searchParams.set('code', key); return u.toString(); }
  catch { return url + (url.includes('?')?'&':'?') + 'code=' + encodeURIComponent(key); }
}
function p2(n){ return (n<10?'0':'')+n; }
function hmToMinutes(h,m){ return h*60+m; }
function minutesToHM(total){ return { hour: Math.floor(total/60), minute: total%60 }; }
function addMinutesToHM(h, m, delta){ return minutesToHM(h*60 + m + delta); }
function t12fmt(h, m){ const ap=h>=12?'PM':'AM'; const hh=h%12===0?12:(h%12); return hh + ':' + p2(m) + ' ' + ap; }
function convertTo24Hour(timeStr){
  const t=timeStr.trim().split(' '), hm=t[0].split(':'), p=t[1];
  let h=parseInt(hm[0],10), m=parseInt(hm[1],10);
  if(p==='PM'&&h!==12)h+=12; if(p==='AM'&&h===12)h=0; return {hours:h, minutes:m};
}
function parseSlotString(slotStr){
  // e.g. "12 Sep 2025, 02:25 PM - 02:40 PM"
  const [datePart, timePart] = slotStr.split(', ');
  const [dayStr, monStr, yearStr] = datePart.split(' ');
  const monthMap = {Jan:1,Feb:2,Mar:3,Apr:4,May:5,Jun:6,Jul:7,Aug:8,Sep:9,Oct:10,Nov:11,Dec:12};
  const monthNum = monthMap[monStr];
  const day = parseInt(dayStr,10), year = parseInt(yearStr,10);
  const [startStr, endStr] = timePart.split(' - ');
  const start24 = convertTo24Hour(startStr), end24 = convertTo24Hour(endStr);
  return {
    y: year, m: monthNum, d: day, dateStr: datePart,
    startTimeStr: startStr, endTimeStr: endStr,
    startMin: hmToMinutes(start24.hours, start24.minutes),
    endMin: hmToMinutes(end24.hours, end24.minutes),
    dateKey: `${year}-${p2(monthNum)}-${p2(day)}`
  };
}
function groupByDate(slots){
  const map = {};
  slots.forEach(s => {
    const key = s.dateKey ?? `${s.y}-${p2(s.m)}-${p2(s.d)}`;
    if (!map[key]) map[key] = { y: s.y, m: s.m, d: s.d, dateStr: s.dateStr, windows: [] };
    map[key].windows.push({
      startMin: s.startMin, endMin: s.endMin,
      startStr: s.startTimeStr, endStr: s.endTimeStr
    });
  });
  return map;
}
function windowsToText(windows){
  return windows.map(w => {
    const s = minutesToHM(w.startMin), e = minutesToHM(w.endMin);
    return t12fmt(s.hour, s.minute) + ' - ' + t12fmt(e.hour, e.minute);
  }).join(', ');
}
function localDow(y,m,d){ return ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][new Date(y, m-1, d).getDay()]; }
function ymdhms(y,m,d,h,mi){ return y+'-'+p2(m)+'-'+p2(d)+'T'+p2(h)+':'+p2(mi)+':00'; }
function humanTimeDisplayYMD(y,m,d,start,end){
  const mons=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const apS = start.hour>=12?'pm':'am', apE = end.hour>=12?'pm':'am';
  const hhS = start.hour%12===0?12:start.hour%12, hhE = end.hour%12===0?12:end.hour%12;
  return `${d} ${mons[m-1]} ${y}, ${hhS}:${p2(start.minute)}${apS}–${hhE}:${p2(end.minute)}${apE}`;
}
function generateUUID(){
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{
    const r=Math.random()*16|0, v=c==='x'?r:(r&0x3)|0x8; return v.toString(16).toUpperCase();
  });
}
function calcAgeFromDOBStr(dobStr){
  const d = new Date(dobStr); if (isNaN(d)) return null;
  const t = new Date(); let a = t.getFullYear() - d.getFullYear();
  const m = t.getMonth() - d.getMonth(); if (m < 0 || (m === 0 && t.getDate() < d.getDate())) a--; return a;
}

/* ===== Visual select helper (no CSS needed) ===== */
function applyChipSelectedStyle(chip, scope){
  scope.querySelectorAll('.slot-chip').forEach(el=>{
    el.classList.remove('selected');
    el.style.background=''; el.style.color=''; el.style.borderColor=''; el.style.boxShadow='';
  });
  chip.classList.add('selected');
  chip.style.background = 'linear-gradient(135deg, var(--primary), var(--secondary))';
  chip.style.color = '#fff';
  chip.style.borderColor = 'transparent';
  chip.style.boxShadow = '0 8px 26px rgba(79,70,229,.35)';
}

/* ===== Slots UI Builders ===== */
/* NORMAL (SELF) — one chip per API slot */
function displayNormalSlots(slots, containerId, slotKey){
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  selectedSlot[slotKey] = null;

  if (!slots || !slots.length){
    container.innerHTML = '<p>No available slots returned by the server. Please check back later.</p>'; return;
  }
  if (typeof slots[0] === 'string' || !('startMin' in slots[0])) {
    try { slots = slots.map(parseSlotString); }
    catch { container.innerHTML = '<p>Could not parse slots from server.</p>'; return; }
  }

  const byDate = groupByDate(slots);
  const keys = Object.keys(byDate).sort();
  if (!keys.length){ container.innerHTML = '<p>No available windows returned by the server.</p>'; return; }

  keys.forEach(key => {
    const dayData = byDate[key];

    const card = document.createElement('div');
    card.className = 'time-slot';

    const header = document.createElement('div');
    header.className = 'date';
    header.textContent = localDow(dayData.y, dayData.m, dayData.d) + ' ' + dayData.dateStr;

    const sub = document.createElement('div');
    sub.className = 'range';
    sub.textContent = 'Available: ' + windowsToText(dayData.windows);

    const grid = document.createElement('div');
    grid.className = 'slot-grid';

    dayData.windows.forEach(w => {
      const startHM = minutesToHM(w.startMin);
      const endHM   = minutesToHM(w.endMin);
      const chip = document.createElement('div');
      chip.className = 'slot-chip';
      chip.setAttribute('role','button'); chip.setAttribute('tabindex','0');
      chip.textContent = t12fmt(startHM.hour, startHM.minute) + '–' + t12fmt(endHM.hour, endHM.minute);

      chip.addEventListener('click', () => {
        applyChipSelectedStyle(chip, grid);
        selectedSlot[slotKey] = {
          y: dayData.y, m: dayData.m, d: dayData.d,
          dateStr: dayData.dateStr,
          start: { hour: startHM.hour, minute: startHM.minute },
          durationMinutes: (w.endMin - w.startMin)
        };
      });
      chip.addEventListener('keydown', ev => {
        if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); chip.click(); }
      });

      grid.appendChild(chip);
    });

    if (!grid.children.length){
      const empty = document.createElement('div');
      empty.style.color = 'var(--muted)';
      empty.textContent = 'No start times within today\'s windows.';
      grid.appendChild(empty);
    }

    card.appendChild(header);
    card.appendChild(sub);
    card.appendChild(grid);
    container.appendChild(card);
  });
}

/* GUARDIAN (3-hour block) — step possible starts within windows */
function displayHouseholdSlots(slots, containerId){
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  selectedSlot.guardian = null;

  if (!slots || !slots.length){
    container.innerHTML = '<p>No available slots returned by the server. Please check back later.</p>'; return;
  }
  if (typeof slots[0] === 'string' || !('startMin' in slots[0])) {
    try { slots = slots.map(parseSlotString); }
    catch { container.innerHTML = '<p>Could not parse slots from server.</p>'; return; }
  }

  const byDate = groupByDate(slots);
  const keys = Object.keys(byDate).sort();
  if (!keys.length){ container.innerHTML = '<p>No available windows returned by the server.</p>'; return; }

  keys.forEach(key => {
    const dayData = byDate[key];

    const card = document.createElement('div');
    card.className = 'time-slot';

    const header = document.createElement('div');
    header.className = 'date';
    header.textContent = localDow(dayData.y, dayData.m, dayData.d) + ' ' + dayData.dateStr;

    const sub = document.createElement('div');
    sub.className = 'range';
    sub.textContent = 'Available window(s): ' + windowsToText(dayData.windows);

    const grid = document.createElement('div');
    grid.className = 'slot-grid';

    const emittedStarts = new Set();
    const need = CONFIG.HOUSEHOLD_BLOCK_MINUTES;

    dayData.windows.forEach(w => {
      if ((w.endMin - w.startMin) < need) return;
      for (let m = w.startMin; m + need <= w.endMin; m += CONFIG.SLOT_MINUTES) {
        if (emittedStarts.has(m)) continue;
        emittedStarts.add(m);

        const startHM = minutesToHM(m);
        const chip = document.createElement('div');
        chip.className = 'slot-chip';
        chip.setAttribute('role','button'); chip.setAttribute('tabindex','0');
        chip.textContent = t12fmt(startHM.hour, startHM.minute); // start only

        chip.addEventListener('click', () => {
          applyChipSelectedStyle(chip, grid);
          selectedSlot.guardian = {
            y: dayData.y, m: dayData.m, d: dayData.d,
            dateStr: dayData.dateStr,
            start: { hour: startHM.hour, minute: startHM.minute },
            durationMinutes: need
          };
        });
        chip.addEventListener('keydown', ev => {
          if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); chip.click(); }
        });

        grid.appendChild(chip);
      }
    });

    if (!grid.children.length){
      const empty = document.createElement('div');
      empty.style.color = 'var(--muted)';
      empty.textContent = 'No 3-hour start times fit within today\'s windows.';
      grid.appendChild(empty);
    }

    card.appendChild(header);
    card.appendChild(sub);
    card.appendChild(grid);
    container.appendChild(card);
  });
}

/* ===== Fetch + Load Slots ===== */
async function loadAvailableSlots(mode){
  try{
    const url = withKey(CONFIG.GET_SLOTS_URL, CONFIG.GET_SLOTS_KEY);
    const resp = await fetch(url, { method:'GET', headers:{'Accept':'application/json'} });
    const text = await resp.text();
    if(!resp.ok) throw new Error('Failed to load slots ('+resp.status+') ' + text);
    const data = text ? JSON.parse(text) : {};
    const list = Array.isArray(data) ? data
              : (Array.isArray(data.free_slots)? data.free_slots
              : (Array.isArray(data.freeSlots)? data.freeSlots
              : (Array.isArray(data.slots)? data.slots : [])));
    availableSlots = list;

    if (mode === 'guardian'){
      displayHouseholdSlots(availableSlots, 'timeSlotsGuardian');
    } else {
      displayNormalSlots(availableSlots, 'timeSlotsSelf', 'self');
    }
  }catch(err){
    console.error(err);
    showError('Failed to load available appointment times. Please try again.');
  }
}

/* ===== Individuals (guardian flow) ===== */
function addIndividualCard(){
  const list = document.getElementById('individualsList');
  const div = document.createElement('div');
  div.className = 'person-card';
  div.innerHTML = `
    <div class="person-header">
      <span class="person-title">Individual</span>
      <button type="button" class="btn-remove" aria-label="Remove individual">Remove</button>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>First Name <span class="required">*</span></label>
        <input type="text" />
      </div>
      <div class="form-group">
        <label>Last Name <span class="required">*</span></label>
        <input type="text" />
      </div>
    </div>
    <div class="form-group">
      <label>BirthDate <span class="required">*</span></label>
      <input type="date" />
    </div>
  `;
  div.querySelector('.btn-remove').addEventListener('click', () => div.remove());
  list.appendChild(div);
}
function collectIndividuals(){
  const rows = Array.from(document.querySelectorAll('#individualsList .person-card'));
  return rows.map(row => {
    const inputs = row.querySelectorAll('input');
    const first = (inputs[0]?.value || '').trim();
    const last  = (inputs[1]?.value || '').trim();
    const dob   = (inputs[2]?.value || '').trim();
    const age = calcAgeFromDOBStr(dob);
    return { first, last, dob, age, under18: (age!==null ? age < 18 : null) };
  });
}

/* ===== Validation & Alerts ===== */
function showSuccess(){ hideMessages(); const el = document.getElementById('successMessage'); if (!el) return; el.style.display='block'; setTimeout(()=>{ el.style.display='none'; }, 5000); }
function showError(msg){ hideMessages(); const el = document.getElementById('errorMessage'); if (!el) return; el.textContent = msg || 'Something went wrong.'; el.style.display='block'; setTimeout(()=>{ el.style.display='none'; }, 6000); }
function hideMessages(){ const s=document.getElementById('successMessage'); const e=document.getElementById('errorMessage'); if (s) s.style.display='none'; if (e) e.style.display='none'; }

function validateSelfFlow(){
  if (!document.getElementById('selfConfirm18').checked){ showError('Please confirm you are an individual 18+.'); return false; }
  const first = (document.getElementById('selfFirstName').value||'').trim();
  const last  = (document.getElementById('selfLastName').value||'').trim();
  const email = (document.getElementById('selfEmail').value||'').trim();
  const phone = (document.getElementById('selfPhone').value||'').trim();
  const dob   = (document.getElementById('selfDob').value||'').trim();
  if (!first || !last){ showError('Please enter your first and last name.'); return false; }
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ showError('Please enter a valid email.'); return false; }
  if (!phone){ showError('Please enter your phone number.'); return false; }
  if (!dob){ showError('Please select your birth date.'); return false; }
  const age = calcAgeFromDOBStr(dob);
  if (age===null || age < 18){ showError('This flow is for individuals 18+.'); return false; }
  const appt = document.querySelector('input[name="apptTypeSelf"]:checked');
  if (!appt){ showError('Please select a preferred appointment type.'); return false; }
  if (!selectedSlot.self){ showError('Please choose an available time.'); return false; }
  if (!document.getElementById('selfConsent').checked){ showError('Please consent to reminders.'); return false; }
  if (!document.getElementById('selfEmergency').checked){ showError('Please confirm you are not experiencing an emergency.'); return false; }
  return true;
}
function validateGuardianFlow(){
  if (!document.getElementById('guardianConfirm18').checked){ showError('Please confirm you are a parent/guardian 18+.'); return false; }
  const gf = (document.getElementById('guardFirstName').value||'').trim();
  const gl = (document.getElementById('guardLastName').value||'').trim();
  const ge = (document.getElementById('guardEmail').value||'').trim();
  const gp = (document.getElementById('guardPhone').value||'').trim();
  if (!gf || !gl){ showError('Please enter parent/guardian name.'); return false; }
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(ge)){ showError('Please enter a valid parent/guardian email.'); return false; }
  if (!gp){ showError('Please enter parent/guardian phone.'); return false; }
  const people = collectIndividuals();
  if (people.length === 0){ showError('Please add at least one individual.'); return false; }
  for (const p of people){ if (!p.first || !p.last || !p.dob){ showError('Please complete each individual’s first name, last name, and DOB.'); return false; } }
  const appt = document.querySelector('input[name="apptTypeGuardian"]:checked');
  if (!appt){ showError('Please select a preferred appointment type.'); return false; }
  if (!selectedSlot.guardian){ showError('Please choose a 3-hour start time.'); return false; }
  if (!document.getElementById('guardConsent').checked){ showError('Please consent to reminders.'); return false; }
  if (!document.getElementById('guardEmergency').checked){ showError('Please confirm you are not experiencing an emergency.'); return false; }
  return true;
}

/* ===== Confirmation Card ===== */
function showConfirmation(opts){
  const card = document.getElementById('confirmationCard'); if (!card) return;
  document.getElementById('confWhen').textContent = opts.whenText || '—';
  document.getElementById('confCounselor').textContent = opts.counselor || 'Assigned counselor';
  document.getElementById('confTeleRow').style.display = 'none';
  document.getElementById('confInPersonRow').style.display = '';
  // Outlook button removed entirely per request (also removed on DOMContentLoaded)
  card.classList.add('visible');
  card.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

/* ===== Submit ===== */
async function handleSubmit(e){
  e.preventDefault();
  hideMessages();

  const selfChecked = document.getElementById('selfConfirm18').checked;
  const guardChecked = document.getElementById('guardianConfirm18').checked;

  if (!selfChecked && !guardChecked){ showError('Please choose a flow: Individual (18+) or Parent/Guardian (18+).'); return; }
  if (selfChecked && guardChecked){ showError('Please use one flow at a time. Uncheck one of the confirmations.'); return; }

  try{
    if (selfChecked){
      if (!validateSelfFlow()) return;

      const first = document.getElementById('selfFirstName').value.trim();
      const last  = document.getElementById('selfLastName').value.trim();
      const email = document.getElementById('selfEmail').value.trim();
      const phone = document.getElementById('selfPhone').value.trim();
      const dob   = document.getElementById('selfDob').value.trim();
      const appt  = document.querySelector('input[name="apptTypeSelf"]:checked').value; // home|office
      const alt   = (document.getElementById('selfAltAvailability').value||'').trim();
      const notes = (document.getElementById('selfNotes').value||'').trim();

      const st = selectedSlot.self.start;
      const dur = selectedSlot.self.durationMinutes;
      const endHM = addMinutesToHM(st.hour, st.minute, dur);
      const startDT = ymdhms(selectedSlot.self.y, selectedSlot.self.m, selectedSlot.self.d, st.hour, st.minute);
      const endDT   = ymdhms(selectedSlot.self.y, selectedSlot.self.m, selectedSlot.self.d, endHM.hour, endHM.minute);

      const subject = (appt==='home'?'In-person (Home)':'In-person (Office)') + ' appointment';
      let body = `Appointment scheduled (${appt==='home'?'home in-person':'office in-person'}) for ${first} ${last} on ${humanTimeDisplayYMD(selectedSlot.self.y, selectedSlot.self.m, selectedSlot.self.d, st, endHM)}. Contact: ${phone}.`;
      if (alt) body += ` Alternate availability: ${alt}.`;
      if (notes) body += ` Additional notes: ${notes}.`;
      body += ` Date of Birth: ${dob}. Over 18: Yes.`;

      const payload = {
        subject, body,
        start: { dateTime: startDT, timeZone: CONFIG.TIMEZONE },
        end:   { dateTime: endDT,   timeZone: CONFIG.TIMEZONE },
        expectedDate: `${selectedSlot.self.y}-${p2(selectedSlot.self.m)}-${p2(selectedSlot.self.d)}`,
        location: { displayName: appt==='home' ? 'in-person-home' : 'in-person-office' },
      attendees: [{ address: email, name: `${first} ${last}`, type:'required' }],
        allowNewTimeProposals: true,
        transactionId: generateUUID(),
        dob, over18: 'yes', guardian: null, household: null
      };

      const resp = await fetch(withKey(CONFIG.BOOK_APPOINTMENT_URL, CONFIG.BOOK_APPOINTMENT_KEY), {
        method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json'},
        body: JSON.stringify(payload)
      });
      const result = await resp.json().catch(()=> ({}));
      if (!resp.ok || !result.ok || !result.id) {
        throw new Error(`Booking failed (${resp.status}) ${result.error || ''}`);
      }

      // compute details BEFORE clearing
      const whenText = humanTimeDisplayYMD(selectedSlot.self.y, selectedSlot.self.m, selectedSlot.self.d, st, endHM);
      const counselor = (result?.raw?.organizer?.emailAddress?.name) || (result?.raw?.organizer?.emailAddress?.address) || 'Assigned counselor';

      showSuccess();
      clearForm();                 // ✅ clear the form immediately after success
      showConfirmation({ whenText, counselor }); // show confirmation card

    } else {
      if (!validateGuardianFlow()) return;

      const gf = document.getElementById('guardFirstName').value.trim();
      const gl = document.getElementById('guardLastName').value.trim();
      const ge = document.getElementById('guardEmail').value.trim();
      const gp = document.getElementById('guardPhone').value.trim();
      const people = collectIndividuals();
      const appt   = document.querySelector('input[name="apptTypeGuardian"]:checked').value; // home|office
      const alt    = (document.getElementById('guardAltAvailability').value||'').trim();
      const notes  = (document.getElementById('guardNotes').value||'').trim();

      const st = selectedSlot.guardian.start;
      const dur = selectedSlot.guardian.durationMinutes;
      const endHM = addMinutesToHM(st.hour, st.minute, dur);
      const startDT = ymdhms(selectedSlot.guardian.y, selectedSlot.guardian.m, selectedSlot.guardian.d, st.hour, st.minute);
      const endDT   = ymdhms(selectedSlot.guardian.y, selectedSlot.guardian.m, selectedSlot.guardian.d, endHM.hour, endHM.minute);

      const subject = 'Household intake (3-hour block)';
      let body = `Household intake (${appt==='home'?'home in-person':'office in-person'}) booked by ${gf} ${gl} on ${humanTimeDisplayYMD(selectedSlot.guardian.y, selectedSlot.guardian.m, selectedSlot.guardian.d, st, endHM)}. Contact: ${gp}.`;
      body += ' Individuals: ' + people.map(p => `${p.first} ${p.last} [DOB: ${p.dob}${p.under18===null?'':`, ${p.under18?'Under 18':'18+'}`}]`).join('; ') + '.';
      if (alt) body += ` Alternate availability: ${alt}.`;
      if (notes) body += ` Additional notes: ${notes}.`;

      const household = {
        hasSiblings: true, householdBlockMinutes: dur,
        under18Guardian: { sameAsMain: true, details: { name: `${gf} ${gl}`, phone: gp, email: ge } },
        siblings: people.map(p => ({
          name: `${p.first} ${p.last}`, dob: p.dob, under18: p.under18,
          needsAssessment: true, guardianSame: true,
          guardian: { name: `${gf} ${gl}`, phone: gp, email: ge }
        }))
      };

      const payload = {
        subject, body,
        start: { dateTime: startDT, timeZone: CONFIG.TIMEZONE },
        end:   { dateTime: endDT,   timeZone: CONFIG.TIMEZONE },
        expectedDate: `${selectedSlot.guardian.y}-${p2(selectedSlot.guardian.m)}-${p2(selectedSlot.guardian.d)}`,
        location: { displayName: appt==='home' ? 'in-person-home' : 'in-person-office' },
        attendees: [{ address: ge, name: `${gf} ${gl}`, type:'required' }],
        allowNewTimeProposals: true,
        transactionId: generateUUID(),
        dob: null, over18: 'yes', guardian: { name: `${gf} ${gl}`, phone: gp, email: ge }, household
      };

      const resp = await fetch(withKey(CONFIG.BOOK_APPOINTMENT_URL, CONFIG.BOOK_APPOINTMENT_KEY), {
        method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json'},
        body: JSON.stringify(payload)
      });
      const result = await resp.json().catch(()=> ({}));
      if (!resp.ok || !result.ok || !result.id) {
        throw new Error(`Booking failed (${resp.status}) ${result.error || ''}`);
      }

      const whenText = humanTimeDisplayYMD(selectedSlot.guardian.y, selectedSlot.guardian.m, selectedSlot.guardian.d, st, endHM);
      const counselor = (result?.raw?.organizer?.emailAddress?.name) || (result?.raw?.organizer?.emailAddress?.address) || 'Assigned counselor';

      showSuccess();
      clearForm();                 // ✅ clear immediately after success
      showConfirmation({ whenText, counselor });
    }
  }catch(err){
    console.error(err);
    showError('There was an error booking your appointment. Please try again or contact us.');
  }
}

/* ===== Clear ===== */
function clearForm(){
  const form = document.getElementById('bookingForm'); if (form) form.reset();

  selectedSlot.self = null; selectedSlot.guardian = null;

  const tsSelf = document.getElementById('timeSlotsSelf'); if (tsSelf) tsSelf.innerHTML = '';
  const tsG = document.getElementById('timeSlotsGuardian'); if (tsG) tsG.innerHTML = '';

  // Reset individuals list to a single blank card
  const list = document.getElementById('individualsList');
  if (list){
    list.innerHTML = '';
    addIndividualCard();
  }

  // Clear any chip visual states
  document.querySelectorAll('.slot-chip').forEach(el=>{
    el.classList.remove('selected');
    el.style.background=''; el.style.color=''; el.style.borderColor=''; el.style.boxShadow='';
  });

  hideMessages();
}

/* ===== Wiring ===== */
document.addEventListener('DOMContentLoaded', () => {
  // Remove "Open in Outlook" button entirely
  document.getElementById('confOutlookLink')?.remove();

  // "Book another" should hide card and scroll to top
  document.getElementById('confBookAnother')?.addEventListener('click', () => {
    document.getElementById('confirmationCard')?.classList.remove('visible');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  // Mutually exclusive flow toggles
  const selfC = document.getElementById('selfConfirm18');
  const guardC = document.getElementById('guardianConfirm18');
  if (selfC && guardC){
    selfC.addEventListener('change', ()=>{ if (selfC.checked) guardC.checked = false; });
    guardC.addEventListener('change', ()=>{ if (guardC.checked) selfC.checked = false; });
  }

  // Load Slots buttons
  document.getElementById('loadSlotsSelfBtn')?.addEventListener('click', ()=> loadAvailableSlots('self'));
  document.getElementById('loadSlotsGuardianBtn')?.addEventListener('click', ()=> loadAvailableSlots('guardian'));

  // Add individual
  document.getElementById('addIndividualBtn')?.addEventListener('click', addIndividualCard);

  // Ensure first person card has a remove button if missing
  (function ensureFirstPersonRemove(){
    const firstCard = document.querySelector('#individualsList .person-card');
    if (firstCard && !firstCard.querySelector('.btn-remove')){
      const header = firstCard.querySelector('.person-header');
      const btn = document.createElement('button');
      btn.type='button'; btn.className='btn-remove'; btn.textContent='Remove';
      btn.addEventListener('click', ()=> firstCard.remove());
      header?.appendChild(btn);
    }
  })();

  // Phone masks
  function wirePhoneMask(id){
    const el = document.getElementById(id); if (!el) return;
    el.addEventListener('input', e => {
      let v = e.target.value.replace(/\D/g,'').slice(0,10);
      if (v.length>6) e.target.value = v.slice(0,3)+'-'+v.slice(3,6)+'-'+v.slice(6);
      else if (v.length>3) e.target.value = v.slice(0,3)+'-'+v.slice(3);
      else e.target.value = v;
    });
  }
  wirePhoneMask('selfPhone'); wirePhoneMask('guardPhone');

  // Clear + Submit
  document.querySelector('.button-group .btn.btn-secondary')?.addEventListener('click', clearForm);
  document.getElementById('bookingForm')?.addEventListener('submit', handleSubmit);
});
</script>


</body>
</html>