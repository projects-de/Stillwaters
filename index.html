<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Still Waters Counseling - Book Your Appointment</title>
  <link rel="icon" type="image/x-icon" href="./favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="./favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="./favicon-16x16.png">
  <link rel="manifest" href="./site.webmanifest">

  <style>
    /* --- Reset & Tokens --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root{
      /* Palette */
      --primary: #4f46e5;
      --primary-700:#4338ca;
      --secondary:#06b6d4;
      --accent:   #38bdf8;
      --success: #10b981;
      --danger:  #ef4444;

      /* Neutrals */
      --bg:      #f6f7fb;
      --card:    #ffffff;
      --muted:   #6b7280;
      --text:    #0f172a;
      --text-soft:#334155;
      --border:  #e5e7eb;

      /* Elevation */
      --shadow:  0 8px 24px rgba(2, 6, 23, .08);
      --shadow-lg: 0 18px 40px rgba(2, 6, 23, .12);

      /* Focus ring */
      --ring: rgba(79, 70, 229, .45);
      --ring-strong: rgba(6, 182, 212, .45);

      /* Radii */
      --r-lg: 20px;
      --r-xl: 24px;
      --r-full: 9999px;

      /* Transitions */
      --t-fast: .15s ease;
      --t-med: .25s ease;

      /* Slot sizing */
      --chip-min: 120px;
    }

    @media (prefers-color-scheme: dark){
      :root{
        --bg:      #0b1220;
        --card:    #0f172a;
        --text:    #e5e7eb;
        --text-soft:#cbd5e1;
        --border:  #1f2937;
        --shadow:  0 8px 24px rgba(0,0,0,.5);
        --shadow-lg: 0 18px 50px rgba(0,0,0,.55);
        --ring: rgba(56, 189, 248, .5);
        --ring-strong: rgba(99, 102, 241, .55);
      }
    }

    /* --- Page --- */
    body{
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
      padding: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(79,70,229,.14), transparent 60%),
        radial-gradient(800px 500px at 90% 10%, rgba(6,182,212,.16), transparent 55%),
        linear-gradient(180deg, var(--bg), var(--bg));
    }

    .container{
      width: 100%;
      max-width: 1100px;
      background: linear-gradient(0deg, rgba(255,255,255,.6), rgba(255,255,255,.6)) , var(--card);
      backdrop-filter: saturate(120%) blur(6px);
      border: 1px solid var(--border);
      border-radius: var(--r-xl);
      box-shadow: var(--shadow-lg);
      overflow: hidden;
      animation: slideIn .4s ease-out both;
    }
    @keyframes slideIn{ from{ opacity:0; transform: translateY(18px);} to{ opacity:1; transform: translateY(0);} }

    /* --- Header --- */
    .header{
      padding:40px 32px;
      color:#fff;
      background:linear-gradient(135deg, var(--primary), var(--secondary));
      text-align:center;
    }

    .header img.logo{
      max-width:100px;
      height:auto;
      display:block;
      margin:0 auto 16px auto;
      filter: drop-shadow(0 3px 6px rgba(0,0,0,0.2));
    }

    .header .call-line{
      font-size:1rem;
      margin-top:10px;
      color:#e0eaff;
      font-weight:600;
    }
    .header h1{
      font-size: clamp(1.8rem, 2.6vw, 2.6rem);
      font-weight: 700;
      letter-spacing: -0.02em;
      margin-bottom: 8px;
    }
    .header p{ font-size: 1.05rem; opacity: .95; }

    /* --- Emergency banner --- */
    .emergency-notice{
      display: flex; align-items: center; justify-content: center; gap: 10px;
      padding: 14px 18px; color: #fff;
      background: linear-gradient(135deg, #f43f5e, #ef4444);
      border-bottom: 1px solid rgba(255,255,255,.25);
      font-weight: 600;
    }
    .emergency-notice svg{ width: 22px; height: 22px; fill: currentColor; }

    /* --- Flow Selection Section --- */
    .flow-selection{
      padding: 32px;
      text-align: center;
    }
    .flow-selection h2{
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--text);
      margin-bottom: 24px;
    }
    .flow-options{
      display: flex;
      flex-direction: column;
      gap: 16px;
      max-width: 600px;
      margin: 0 auto;
    }
    .flow-option-card{
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      cursor: pointer;
      transition: all var(--t-med);
      display: flex;
      align-items: center;
      gap: 14px;
    }
    .flow-option-card:hover{
      border-color: var(--primary);
      box-shadow: var(--shadow);
      transform: translateY(-2px);
    }
    .flow-option-card.selected{
      border-color: var(--primary);
      background: linear-gradient(135deg, rgba(79,70,229,.08), rgba(6,182,212,.08));
      box-shadow: var(--shadow);
    }
    .flow-option-card input[type="radio"]{
      width: 22px;
      height: 22px;
      cursor: pointer;
    }
    .flow-option-label{
      flex: 1;
      text-align: left;
      font-weight: 600;
      font-size: 1.05rem;
      color: var(--text);
      cursor: pointer;
    }

    /* --- Shared form styles --- */
    .form-container{ padding: 32px; display: none; }
    .form-container.visible{ display: block; }
    .form-section{ margin-bottom: 22px; }
    .form-section h3{ font-size: 1.05rem; font-weight: 800; color: var(--text); margin-bottom: 12px; }
    .form-group{ margin-bottom: 14px; }
    .form-row{ display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }

    label{
      display: block;
      color: var(--text-soft);
      font-weight: 600;
      margin-bottom: 8px;
      font-size: .95rem;
    }
    .required{ color: var(--danger); }

    input[type="text"],
    input[type="email"],
    input[type="tel"],
    input[type="date"],
    textarea{
      width: 100%;
      appearance: none;
      background: var(--card);
      color: var(--text);
      border: 1.5px solid var(--border);
      border-radius: 12px;
      padding: 12px 14px;
      font-size: 1rem;
      transition: border-color var(--t-fast), box-shadow var(--t-fast), background var(--t-fast), transform var(--t-fast);
    }
    textarea{ min-height: 110px; resize: vertical; }
    input:hover, textarea:hover{ border-color: color-mix(in oklab, var(--primary) 25%, var(--border)); }
    input:focus, textarea:focus{
      outline: none; border-color: var(--primary); box-shadow: 0 0 0 4px var(--ring);
    }

    .radio-group{ display:flex; gap:14px; flex-wrap:wrap; margin-top: 8px; }
    .radio-option{
      display:flex; align-items:center; gap:10px;
      background: var(--card);
      border: 1.5px solid var(--border);
      border-radius: 12px;
      padding: 12px 16px;
      cursor: pointer;
      transition: transform var(--t-fast), box-shadow var(--t-fast), border-color var(--t-fast), background var(--t-fast);
      user-select: none;
    }
    .radio-option:hover{ transform: translateY(-1px); border-color: var(--primary); box-shadow: var(--shadow); }
    .radio-option input[type="radio"]{ width: 18px; height: 18px; }

    .checkbox-group{ display:flex; align-items:flex-start; gap:10px; margin: 10px 0; }
    .checkbox-group input[type="checkbox"]{ width:18px; height:18px; margin-top: 3px; cursor: pointer; }

    /* --- Time slots (shared visual) --- */
    .time-slots{ display: grid; grid-template-columns: 1fr; gap: 16px; margin-top: 14px; }
    .time-slot{
      background: var(--card);
      border: 1.5px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      box-shadow: var(--shadow);
    }
    .time-slot .date{ font-weight: 800; font-size: 1rem; color: var(--text); margin-bottom: 6px; }
    .time-slot .range{ color: var(--muted); font-size: .95rem; margin-bottom: 12px; }
    .slot-grid{ display: grid; grid-template-columns: repeat(auto-fill, minmax(var(--chip-min), 1fr)); gap: 10px; }
    .slot-chip{
      padding: 10px 12px; text-align: center; border-radius: var(--r-full);
      background: linear-gradient(180deg, #ffffff, #fafafa);
      color: var(--text); border: 1.5px solid var(--border);
      font-weight: 600; font-size: .95rem; cursor: pointer;
      transition: transform var(--t-fast), box-shadow var(--t-fast), border-color var(--t-fast), background var(--t-fast), color var(--t-fast);
    }
    .slot-chip:hover{ transform: translateY(-1px); border-color: var(--primary); box-shadow: var(--shadow); }

    /* --- Single flow card (centered) --- */
    .single-flow-card{
      max-width: 800px;
      margin: 0 auto;
      background: var(--card);
      border: 1.5px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      box-shadow: var(--shadow);
    }
    .flow-title{
      font-weight: 900;
      color: var(--text);
      margin-bottom: 8px;
      font-size: 1.3rem;
      letter-spacing: .2px;
      text-align: center;
    }
    .flow-intro{ color: var(--muted); font-size: .95rem; margin-bottom: 20px; text-align: center; }

    /* Individuals list (re-using sibling card visuals) */
    .person-card{
      background: var(--card);
      border: 1.5px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      box-shadow: var(--shadow);
      margin-bottom: 12px;
    }
    .person-header{ display:flex; justify-content: space-between; align-items:center; margin-bottom: 10px; }
    .person-title{ font-weight: 700; color: var(--text); }

    /* Buttons */
    .button-group{ display:flex; gap: 12px; justify-content:center; margin-top: 24px; flex-wrap: wrap; }
    .btn{
      border: 0; border-radius: 12px;
      padding: 14px 22px;
      font-size: 1rem; font-weight: 800; letter-spacing: .02em;
      cursor: pointer;
      transition: transform var(--t-med), box-shadow var(--t-med), opacity var(--t-fast);
    }
    .btn-primary{
      color:#fff;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      box-shadow: 0 10px 28px rgba(79,70,229,.35);
    }
    .btn-primary:hover{ transform: translateY(-2px); box-shadow: 0 16px 40px rgba(79,70,229,.45); }
    .btn-secondary{
      color: var(--primary);
      background: linear-gradient(180deg, #ffffff, #fafafa);
      border: 1.5px solid color-mix(in oklab, var(--primary) 22%, var(--border));
    }
    .btn-secondary:hover{ transform: translateY(-2px); box-shadow: var(--shadow); }
    .btn-pill{ border-radius: var(--r-full); padding: 10px 16px; font-weight: 800; }
    .btn-remove{
      background: transparent;
      border: 1.5px solid var(--danger);
      color: var(--danger);
      border-radius: 8px;
      padding: 6px 12px;
      font-size: .85rem;
      font-weight: 700;
      cursor: pointer;
      transition: all var(--t-fast);
    }
    .btn-remove:hover{
      background: var(--danger);
      color: white;
    }

    /* Alerts */
    .success-message,
    .error-message{
      display:none;
      border-radius: 12px;
      padding: 14px 16px;
      font-weight: 700;
      margin: 14px 0;
      box-shadow: var(--shadow);
    }
    .success-message{ background: color-mix(in oklab, var(--success) 18%, #ecfdf5); color: #065f46; border: 1.5px solid color-mix(in oklab, var(--success) 40%, #ffffff); }
    .error-message{ background: color-mix(in oklab, var(--danger) 18%, #fef2f2); color: #7f1d1d; border: 1.5px solid color-mix(in oklab, var(--danger) 40%, #ffffff); }

    /* Confirmation card */
    .confirm-card{
      display:none;
      background: color-mix(in oklab, var(--success) 10%, #fff);
      border: 1.5px solid color-mix(in oklab, var(--success) 30%, #fff);
      border-radius: 16px;
      padding: 24px;
      box-shadow: var(--shadow);
      margin: 16px auto;
      max-width: 600px;
      text-align: center;
    }
    .confirm-card.visible{ display:block; }
    .confirm-card h3{ font-size:1.4rem; font-weight:800; margin-bottom:16px; color:#065f46; }
    .confirm-row{ display:flex; gap:10px; align-items:flex-start; margin:10px 0; color:#064e3b; justify-content: center; }
    .confirm-row b{ min-width:130px; display:inline-block; color:#065f46; text-align: right; }
    .confirm-actions{ display:flex; gap:10px; margin-top:16px; flex-wrap:wrap; justify-content: center; }
    .confirm-actions .btn{ padding:12px 20px; font-size:.95rem; }

    /* Responsive */
    @media (max-width: 900px){
      .form-row{ grid-template-columns: 1fr; }
      .btn{ width: 100%; }
    }

    /* Loading helpers */
    .spinner{
      width: 28px; height: 28px;
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin .8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .loading-box{
      display:flex; align-items:center; justify-content:center; gap:10px;
      color: var(--text-soft);
      padding: 18px;
      border: 1.5px dashed var(--border);
      border-radius: 12px;
      background: linear-gradient(180deg, #ffffff, #fafafa);
    }

    .btn[disabled]{
      opacity:.7; cursor:not-allowed; transform:none !important; box-shadow:none !important;
    }

    /* Full-screen overlay for submit */
    .loading-overlay{
      position: fixed; inset: 0;
      display: none; align-items: center; justify-content: center;
      background: rgba(15,23,42,.28); backdrop-filter: blur(2px);
      z-index: 9999;
    }
    .loading-overlay.active{ display: flex; }
    .loading-card{
      display:flex; align-items:center; gap:12px;
      background: var(--card);
      border: 1.5px solid var(--border);
      box-shadow: var(--shadow-lg);
      border-radius: 14px; padding: 16px 18px;
    }
    .loading-card .spinner{ width:24px; height:24px; border-width:3px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Still Waters Professional Counseling Services, Inc.</h1>
      <h2>Schedule Your Intake Appointment</h2>
      <div class="call-line">
        If you prefer to make your appointment by speaking to a Still Water's employee call:<br>
        <strong>706-955-9224</strong>
    </div>
    </div>

    <div class="emergency-notice">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/></svg>
      <span>If you are experiencing an emergency, please dial 911 immediately</span>
    </div>

    <div id="flowSelection" class="flow-selection">
      <h2>Please select which applies to you:</h2>
      <div class="flow-options">
        <label class="flow-option-card" id="selfOptionCard">
          <input type="radio" name="flowType" value="self" id="flowTypeSelf">
          <span class="flow-option-label">I am an individual seeking services and confirm that I am over the age of 18 <span class="required">*</span></span>
        </label>
        <label class="flow-option-card" id="guardianOptionCard">
          <input type="radio" name="flowType" value="guardian" id="flowTypeGuardian">
          <span class="flow-option-label">I am parent or guardian of an individual(s) seeking services and confirm I am over the age of 18 <span class="required">*</span></span>
        </label>
      </div>
    </div>

    <form id="bookingForm" class="form-container" novalidate>
      <div id="successMessage" class="success-message">Appointment booked successfully! You'll receive a confirmation soon.</div>
      <div id="errorMessage" class="error-message">There was an error booking your appointment. Please try again.</div>

      <div id="confirmationCard" class="confirm-card" aria-live="polite">
        <h3>✅ Your Appointment Has Been Submitted!</h3>
        <div class="confirm-row"><b>Date & time</b><span id="confWhen">—</span></div>
        <div class="confirm-row"><b>Counselor</b><span id="confCounselor">—</span></div>
        <div class="confirm-row" id="confInPersonRow"><b>Visit info</b>
          <span id="confVisitText">We'll send directions and arrival details via email/text.</span>
        </div>
        <div class="confirm-actions">
          <button id="confBookAnother" type="button" class="btn btn-primary btn-pill">Book Another Appointment</button>
        </div>
      </div>

      <div id="flowSelf" class="single-flow-card" style="display:none;">
        <div class="flow-title">Individual (18+) Appointment</div>
        <div class="flow-intro">Complete the form below to schedule your appointment.</div>

        <div class="form-section">
          <h3>Your Information</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="selfFirstName">First Name <span class="required">*</span></label>
              <input type="text" id="selfFirstName" />
            </div>
            <div class="form-group">
              <label for="selfLastName">Last Name <span class="required">*</span></label>
              <input type="text" id="selfLastName" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="selfEmail">Email Address</label>
              <input type="email" id="selfEmail" />
            </div>
            <div class="form-group">
              <label for="selfPhone">Phone Number <span class="required">*</span></label>
              <input type="tel" id="selfPhone" placeholder="123-456-7890" />
            </div>
          </div>
          <div class="form-group">
            <label for="selfDob">BirthDate <span class="required">*</span></label>
            <input type="date" id="selfDob" />
          </div>
        </div>

        <div class="form-section">
          <h3>Preferred Appointment Type <span class="required">*</span></h3>
          <div class="radio-group">
            <label class="radio-option">
              <input type="radio" name="apptTypeSelf" value="home" />
              <span>At Home – In Person</span>
            </label>
            <label class="radio-option">
              <input type="radio" name="apptTypeSelf" value="office" />
              <span>At Office – In Person</span>
            </label>
          </div>
        </div>

        <div class="form-section">
          <h3>Available Slots</h3>
          <div class="form-group">
            <button type="button" class="btn btn-secondary btn-pill" id="loadSlotsSelfBtn">Load Available Times</button>
          </div>
          <div id="timeSlotsSelf" class="time-slots"></div>
        </div>

        <div class="form-section">
          <h3>Additional Information</h3>
          <div class="form-group">
            <label for="selfAltAvailability">Alternate Availability (Optional)</label>
            <textarea id="selfAltAvailability" placeholder="If the available slots don't work, describe your availability"></textarea>
          </div>
          <div class="form-group">
            <label for="selfNotes">Additional Notes (Optional)</label>
            <textarea id="selfNotes" placeholder="Any other information you'd like us to know"></textarea>
          </div>
        </div>

        <div class="form-section">
          <h3>Consent &amp; Acknowledgments</h3>
          <label class="checkbox-group">
            <input type="checkbox" id="selfConsent"/>
            <span>I consent to receive appointment reminders via text and email <span class="required">*</span></span>
          </label>
          <label class="checkbox-group">
            <input type="checkbox" id="selfEmergency"/>
            <span>I confirm that I am not currently experiencing a medical or mental health emergency <span class="required">*</span></span>
          </label>
        </div>

        <div class="button-group">
          <button type="button" class="btn btn-secondary" id="clearSelfBtn">Clear Form</button>
          <button type="submit" class="btn btn-primary">Book Appointment</button>
        </div>
      </div>
      
      <div id="flowGuardian" class="single-flow-card" style="display:none;">
          <div class="flow-title">Parent/Guardian (Household) Appointment</div>
          <div class="flow-intro">Complete the form below to schedule your household intake appointment.</div>
  
          <div class="form-section">
            <h3>Your (Parent/Guardian) Information</h3>
            <div class="form-row">
              <div class="form-group">
                <label for="guardFirstName">First Name <span class="required">*</span></label>
                <input type="text" id="guardFirstName" />
              </div>
              <div class="form-group">
                <label for="guardLastName">Last Name <span class="required">*</span></label>
                <input type="text" id="guardLastName" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="guardEmail">Email Address</label>
                <input type="email" id="guardEmail" />
              </div>
              <div class="form-group">
                <label for="guardPhone">Phone Number <span class="required">*</span></label>
                <input type="tel" id="guardPhone" placeholder="123-456-7890" />
              </div>
            </div>
          </div>
  
          <div class="form-section">
            <h3>Individual(s) Seeking Services</h3>
            <p class="flow-intro" style="font-size: .9rem; margin-bottom: 12px;">Please add one card for each individual (child or adult) in your household who is seeking services.</p>
            <div id="individualsList">
              <div class="person-card">
                <div class="person-header">
                  <span class="person-title">Individual</span>
                  <button type="button" class="btn-remove">Remove</button>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label>First Name <span class="required">*</span></label>
                    <input type="text" />
                  </div>
                  <div class="form-group">
                    <label>Last Name <span class="required">*</span></label>
                    <input type="text" />
                  </div>
                </div>
                <div class="form-group">
                  <label>BirthDate <span class="required">*</span></label>
                  <input type="date" />
                </div>
              </div>
            </div>
            <div class="button-group" style="justify-content: flex-start; margin-top: 16px;">
              <button type="button" class="btn btn-secondary btn-pill" id="addIndividualBtn" style="width: auto; padding-left: 18px; padding-right: 18px;">+ Add Another Individual</button>
            </div>
          </div>
  
          <div class="form-section">
            <h3>Preferred Appointment Type <span class="required">*</span></h3>
            <div class="radio-group">
              <label class="radio-option">
                <input type="radio" name="apptTypeGuardian" value="home" />
                <span>At Home – In Person</span>
              </label>
              <label class="radio-option">
                <input type="radio" name="apptTypeGuardian" value="office" />
                <span>At Office – In Person</span>
              </label>
            </div>
          </div>
  
          <div class="form-section">
            <h3>Available Slots (3-Hour Blocks)</h3>
            <div class="form-group">
              <button type="button" class="btn btn-secondary btn-pill" id="loadSlotsGuardianBtn">Load Available Times</button>
            </div>
            <div id="timeSlotsGuardian" class="time-slots"></div>
          </div>
  
          <div class="form-section">
            <h3>Additional Information</h3>
            <div class="form-group">
              <label for="guardAltAvailability">Alternate Availability (Optional)</label>
              <textarea id="guardAltAvailability" placeholder="If the available slots don't work, describe your availability"></textarea>
            </div>
            <div class="form-group">
              <label for="guardNotes">Additional Notes (Optional)</label>
              <textarea id="guardNotes" placeholder="Any other information you'd like us to know"></textarea>
            </div>
          </div>
  
          <div class="form-section">
            <h3>Consent &amp; Acknowledgments</h3>
            <label class="checkbox-group">
              <input type="checkbox" id="guardConsent"/> 
              <span>I consent to receive appointment reminders via text and email <span class="required">*</span></span>
            </label>
            <label class="checkbox-group">
              <input type="checkbox" id="guardEmergency"/>
              <span>I confirm that I am not currently experiencing a medical or mental health emergency <span class="required">*</span></span>
            </label>
          </div>
  
          <div class="button-group">
            <button type="button" class="btn btn-secondary" id="clearGuardianBtn">Clear Form</button>
            <button type="submit" class="btn btn-primary">Book Appointment</button>
          </div>
      </div>
      </form>
  </div>

<script>
/* ===== CONFIG ===== */
const CONFIG = {
  GET_SLOTS_URL: 'https://sw-function-b6c4h9cnexhbh4g3.canadacentral-01.azurewebsites.net/api/Calender',
  BOOK_APPOINTMENT_URL: 'https://sw-function-b6c4h9cnexhbh4g3.canadacentral-01.azurewebsites.net/api/CreateEvent',
  GET_SLOTS_KEY: '',
  BOOK_APPOINTMENT_KEY: '',
  TIMEZONE: 'Central Standard Time',
  SLOT_MINUTES: 20,
  HOUSEHOLD_BLOCK_MINUTES: 180
};

/* ===== State ===== */
let selectedSlot = { self: null, guardian: null };
let availableSlots = [];
let selectedDate = { self: null, guardian: null };
let activeFlow = null;

/* ===== Utilities ===== */
function withKey(url, key) {
  if (!key) return url;
  try { const u = new URL(url); u.searchParams.set('code', key); return u.toString(); }
  catch { return url + (url.includes('?')?'&':'?') + 'code=' + encodeURIComponent(key); }
}
function p2(n){ return (n<10?'0':'')+n; }
function hmToMinutes(h,m){ return h*60+m; }
function minutesToHM(total){ return { hour: Math.floor(total/60), minute: total%60 }; }
function addMinutesToHM(h, m, delta){ return minutesToHM(h*60 + m + delta); }
function t12fmt(h, m){ const ap=h>=12?'PM':'AM'; const hh=h%12===0?12:(h%12); return hh + ':' + p2(m) + ' ' + ap; }
function convertTo24Hour(timeStr){
  const t=timeStr.trim().split(' '), hm=t[0].split(':'), p=t[1];
  let h=parseInt(hm[0],10), m=parseInt(hm[1],10);
  if(p==='PM'&&h!==12)h+=12; if(p==='AM'&&h===12)h=0; return {hours:h, minutes:m};
}

/* ===== Loading helpers ===== */
function showSlotsLoading(containerId){
  const c = document.getElementById(containerId);
  if (!c) return;
  c.innerHTML = `
    <div class="loading-box" role="status" aria-live="polite">
      <div class="spinner" aria-hidden="true"></div>
      <span>Loading available times…</span>
    </div>`;
}

function setButtonLoading(btn, on, txt='Loading…'){
  if (!btn) return;
  if (on){
    if (!btn.dataset._label) btn.dataset._label = btn.textContent;
    btn.disabled = true; btn.textContent = txt;
  }else{
    btn.disabled = false; btn.textContent = btn.dataset._label || btn.textContent;
    delete btn.dataset._label;
  }
}

let _overlayEl = null;
function ensureOverlay(){
  if (_overlayEl) return _overlayEl;
  _overlayEl = document.createElement('div');
  _overlayEl.id = 'globalLoading';
  _overlayEl.className = 'loading-overlay';
  _overlayEl.setAttribute('aria-live','polite');
  _overlayEl.innerHTML = `
    <div class="loading-card">
      <div class="spinner" aria-hidden="true"></div>
      <span id="globalLoadingText">Working…</span>
    </div>`;
  document.body.appendChild(_overlayEl);
  return _overlayEl;
}
function setGlobalLoading(on, text){
  const ov = ensureOverlay();
  const label = ov.querySelector('#globalLoadingText');
  if (text) label.textContent = text;
  ov.classList.toggle('active', !!on);
}

function parseSlotString(slotStr){
  const [datePart, timePart] = slotStr.split(', ');
  const [dayStr, monStr, yearStr] = datePart.split(' ');
  const monthMap = {Jan:1,Feb:2,Mar:3,Apr:4,May:5,Jun:6,Jul:7,Aug:8,Sep:9,Oct:10,Nov:11,Dec:12};
  const monthNum = monthMap[monStr];
  const day = parseInt(dayStr,10), year = parseInt(yearStr,10);
  const [startStr, endStr] = timePart.split(' - ');
  const start24 = convertTo24Hour(startStr), end24 = convertTo24Hour(endStr);
  return {
    y: year, m: monthNum, d: day, dateStr: datePart,
    startTimeStr: startStr, endTimeStr: endStr,
    startMin: hmToMinutes(start24.hours, start24.minutes),
    endMin: hmToMinutes(end24.hours, end24.minutes),
    dateKey: `${year}-${p2(monthNum)}-${p2(day)}`
  };
}
function groupByDate(slots){
  const map = {};
  slots.forEach(s => {
    const key = s.dateKey ?? `${s.y}-${p2(s.m)}-${p2(s.d)}`;
    if (!map[key]) map[key] = { y: s.y, m: s.m, d: s.d, dateStr: s.dateStr, windows: [] };
    map[key].windows.push({
      startMin: s.startMin, endMin: s.endMin,
      startStr: s.startTimeStr, endStr: s.endTimeStr
    });
  });
  return map;
}
function localDow(y,m,d){ return ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][new Date(y, m-1, d).getDay()]; }
function ymdhms(y,m,d,h,mi){ return y+'-'+p2(m)+'-'+p2(d)+'T'+p2(h)+':'+p2(mi)+':00'; }
function humanTimeDisplayYMD(y,m,d,start,end){
  const mons=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const apS = start.hour>=12?'pm':'am', apE = end.hour>=12?'pm':'am';
  const hhS = start.hour%12===0?12:start.hour%12, hhE = end.hour%12===0?12:end.hour%12;
  return `${d} ${mons[m-1]} ${y}, ${hhS}:${p2(start.minute)}${apS}–${hhE}:${p2(end.minute)}${apE}`;
}
function generateUUID(){
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{
    const r=Math.random()*16|0, v=c==='x'?r:(r&0x3)|0x8; return v.toString(16).toUpperCase();
  });
}
function calcAgeFromDOBStr(dobStr){
  const d = new Date(dobStr); if (isNaN(d)) return null;
  const t = new Date(); let a = t.getFullYear() - d.getFullYear();
  const m = t.getMonth() - d.getUTCMonth(); if (m < 0 || (m === 0 && t.getDate() < d.getUTCDate())) a--; return a;
}

/* ===== Visual select helper ===== */
function applyChipSelectedStyle(chip, scope){
  scope.querySelectorAll('.slot-chip').forEach(el=>{
    el.classList.remove('selected');
    el.style.background=''; el.style.color=''; el.style.borderColor=''; el.style.boxShadow='';
  });
  chip.classList.add('selected');
  chip.style.background = 'linear-gradient(135deg, var(--primary), var(--secondary))';
  chip.style.color = '#fff';
  chip.style.borderColor = 'transparent';
  chip.style.boxShadow = '0 8px 26px rgba(79,70,229,.35)';
}

/* ===== Slots UI Builders ===== */
function displayNormalSlots(slots, containerId, flow){
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  selectedSlot[flow] = null;

  if (!slots || !slots.length){
    container.innerHTML = '<p>No available slots returned by the server. Please check back later.</p>';
    return;
  }
  if (typeof slots[0] === 'string' || !('startMin' in slots[0])) {
    try { slots = slots.map(parseSlotString); }
    catch { container.innerHTML = '<p>Could not parse slots from server.</p>'; return; }
  }

  const byDate = groupByDate(slots);
  const keys = Object.keys(byDate).sort();
  if (!keys.length){ container.innerHTML = '<p>No available windows returned by the server.</p>'; return; }

  const dateWrap = document.createElement('div');
  dateWrap.className = 'time-slot';
  const dateHeader = document.createElement('div');
  dateHeader.className = 'date';
  dateHeader.textContent = 'Pick a date';
  const dateGrid = document.createElement('div');
  dateGrid.className = 'slot-grid';

  keys.forEach(key => {
    const d = byDate[key];
    const chip = document.createElement('button');
    chip.type = 'button';
    chip.className = 'slot-chip';
    chip.textContent = `${localDow(d.y, d.m, d.d)} ${d.dateStr}`;

    if (selectedDate[flow] === key) {
      applyChipSelectedStyle(chip, dateGrid);
    }

    chip.addEventListener('click', () => {
      selectedDate[flow] = key;
      applyChipSelectedStyle(chip, dateGrid);
      selectedSlot[flow] = null;
      renderTimesForDate(flow, byDate[key], timesHost, CONFIG.SLOT_MINUTES, CONFIG.SLOT_MINUTES);
    });

    dateGrid.appendChild(chip);
  });

  dateWrap.appendChild(dateHeader);
  dateWrap.appendChild(dateGrid);

  const timesHost = document.createElement('div');

  container.appendChild(dateWrap);
  container.appendChild(timesHost);

  if (selectedDate[flow] && byDate[selectedDate[flow]]) {
    renderTimesForDate(flow, byDate[selectedDate[flow]], timesHost, CONFIG.SLOT_MINUTES, CONFIG.SLOT_MINUTES);
  }
}

function displayHouseholdSlots(slots, containerId){
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  selectedSlot.guardian = null;

  if (!slots || !slots.length){
    container.innerHTML = '<p>No available slots returned by the server. Please check back later.</p>';
    return;
  }
  if (typeof slots[0] === 'string' || !('startMin' in slots[0])) {
    try { slots = slots.map(parseSlotString); }
    catch { container.innerHTML = '<p>Could not parse slots from server.</p>'; return; }
  }

  const byDate = groupByDate(slots);
  const keys = Object.keys(byDate).sort();
  if (!keys.length){ container.innerHTML = '<p>No available windows returned by the server.</p>'; return; }

  const dateWrap = document.createElement('div');
  dateWrap.className = 'time-slot';
  const dateHeader = document.createElement('div');
  dateHeader.className = 'date';
  dateHeader.textContent = 'Pick a date';
  const dateGrid = document.createElement('div');
  dateGrid.className = 'slot-grid';

  keys.forEach(key => {
    const d = byDate[key];
    const chip = document.createElement('button');
    chip.type = 'button';
    chip.className = 'slot-chip';
    chip.textContent = `${localDow(d.y, d.m, d.d)} ${d.dateStr}`;

    if (selectedDate.guardian === key) {
      applyChipSelectedStyle(chip, dateGrid);
    }

    chip.addEventListener('click', () => {
      selectedDate.guardian = key;
      applyChipSelectedStyle(chip, dateGrid);
      selectedSlot.guardian = null;
      renderTimesForDate('guardian', byDate[key], timesHost, CONFIG.HOUSEHOLD_BLOCK_MINUTES, CONFIG.SLOT_MINUTES);
    });

    dateGrid.appendChild(chip);
  });

  dateWrap.appendChild(dateHeader);
  dateWrap.appendChild(dateGrid);

  const timesHost = document.createElement('div');

  container.appendChild(dateWrap);
  container.appendChild(timesHost);

  if (selectedDate.guardian && byDate[selectedDate.guardian]) {
    renderTimesForDate('guardian', byDate[selectedDate.guardian], timesHost, CONFIG.HOUSEHOLD_BLOCK_MINUTES, CONFIG.SLOT_MINUTES);
  }
}

function renderTimesForDate(flow, dayData, host, needMinutes, stepMinutes){
  host.innerHTML = '';

  const card = document.createElement('div');
  card.className = 'time-slot';

  const header = document.createElement('div');
  header.className = 'date';
  header.textContent = `${localDow(dayData.y, dayData.m, dayData.d)} ${dayData.dateStr}`;

  const grid = document.createElement('div');
  grid.className = 'slot-grid';

  const emitted = new Set();
  dayData.windows.forEach(w => {
    for (let m = w.startMin; m + needMinutes <= w.endMin; m += stepMinutes){
      if (emitted.has(m)) continue;
      emitted.add(m);

      const startHM = minutesToHM(m);
      const chip = document.createElement('button');
      chip.type = 'button';
      chip.className = 'slot-chip';
      chip.textContent = t12fmt(startHM.hour, startHM.minute);

      chip.addEventListener('click', () => {
        applyChipSelectedStyle(chip, grid);
        const f = flow === 'guardian' ? 'guardian' : 'self';
        selectedSlot[f] = {
          y: dayData.y, m: dayData.m, d: dayData.d,
          dateStr: dayData.dateStr,
          start: { hour: startHM.hour, minute: startHM.minute },
          durationMinutes: needMinutes
        };
      });

      chip.addEventListener('keydown', ev => {
        if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); chip.click(); }
      });

      grid.appendChild(chip);
    }
  });

  if (!grid.children.length){
    const empty = document.createElement('div');
    empty.style.color = 'var(--muted)';
    empty.textContent = needMinutes >= 180
      ? 'No 3-hour start times fit within this date.'
      : `No ${needMinutes}-minute start times fit within this date.`;
    grid.appendChild(empty);
  }

  card.appendChild(header);
  card.appendChild(grid);
  host.appendChild(card);
}

/* ===== Fetch + Load Slots ===== */
async function loadAvailableSlots(mode){
  const button = mode === 'guardian'
    ? document.getElementById('loadSlotsGuardianBtn')
    : document.getElementById('loadSlotsSelfBtn');
  const containerId = mode === 'guardian' ? 'timeSlotsGuardian' : 'timeSlotsSelf';

  try{
    setButtonLoading(button, true, 'Loading…');
    showSlotsLoading(containerId);

    const url = withKey(CONFIG.GET_SLOTS_URL, CONFIG.GET_SLOTS_KEY);
    const resp = await fetch(url, { method:'GET', headers:{'Accept':'application/json'} });
    const text = await resp.text();
    if(!resp.ok) throw new Error('Failed to load slots ('+resp.status+') ' + text);
    const data = text ? JSON.parse(text) : {};
    const list = Array.isArray(data) ? data
             : (Array.isArray(data.free_slots)? data.free_slots
             : (Array.isArray(data.freeSlots)? data.freeSlots
             : (Array.isArray(data.slots)? data.slots : [])));
    availableSlots = list;

    if (mode === 'guardian'){
      displayHouseholdSlots(availableSlots, 'timeSlotsGuardian');
    } else {
      displayNormalSlots(availableSlots, 'timeSlotsSelf', 'self');
    }
  }catch(err){
    console.error(err);
    const c = document.getElementById(containerId);
    if (c) c.innerHTML = '<div class="loading-box">Could not load times. Please try again.</div>';
    showError('Failed to load available appointment times. Please try again.');
  }finally{
    setButtonLoading(button, false);
  }
}

/* ===== Individuals (guardian flow) ===== */
function addIndividualCard(){
  const list = document.getElementById('individualsList');
  const div = document.createElement('div');
  div.className = 'person-card';
  div.innerHTML = `
    <div class="person-header">
      <span class="person-title">Individual</span>
      <button type="button" class="btn-remove">Remove</button>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>First Name <span class="required">*</span></label>
        <input type="text" />
      </div>
      <div class="form-group">
        <label>Last Name <span class="required">*</span></label>
        <input type="text" />
      </div>
    </div>
    <div class="form-group">
      <label>BirthDate <span class="required">*</span></label>
      <input type="date" />
    </div>
  `;
  div.querySelector('.btn-remove').addEventListener('click', () => div.remove());
  list.appendChild(div);
}
function collectIndividuals(){
  const rows = Array.from(document.querySelectorAll('#individualsList .person-card'));
  return rows.map(row => {
    const inputs = row.querySelectorAll('input');
    const first = (inputs[0]?.value || '').trim();
    const last  = (inputs[1]?.value || '').trim();
    const dob   = (inputs[2]?.value || '').trim();
    const age = calcAgeFromDOBStr(dob);
    return { first, last, dob, age, under18: (age!==null ? age < 18 : null) };
  });
}

/* ===== Validation & Alerts ===== */
function showSuccess(){ 
  hideMessages(); 
  const el = document.getElementById('successMessage'); 
  if (!el) return; 
  el.style.display='block'; 
  setTimeout(()=>{ el.style.display='none'; }, 5000); 
}
function showError(msg){ 
  hideMessages(); 
  const el = document.getElementById('errorMessage'); 
  if (!el) return; 
  el.textContent = msg || 'Something went wrong.'; 
  el.style.display='block'; 
  el.scrollIntoView({ behavior: 'smooth', block: 'center' });
  setTimeout(()=>{ el.style.display='none'; }, 8000); 
}
function hideMessages(){ 
  const s=document.getElementById('successMessage'); 
  const e=document.getElementById('errorMessage'); 
  if (s) s.style.display='none'; 
  if (e) e.style.display='none'; 
}

function validateSelfFlow(){
  const first = (document.getElementById('selfFirstName').value||'').trim();
  const last  = (document.getElementById('selfLastName').value||'').trim();
  const email = (document.getElementById('selfEmail').value||'').trim();
  const phone = (document.getElementById('selfPhone').value||'').trim();
  const dob   = (document.getElementById('selfDob').value||'').trim();
  
  if (!first || !last){ 
    showError('Missing required field: Please enter your first and last name.'); 
    return false; 
  }
  if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ 
    showError('Invalid email: Please enter a valid email address or leave it blank.'); 
    return false; 
  }
  if (!phone){ 
    showError('Missing required field: Please enter your phone number.'); 
    return false; 
  }
  if (!dob){ 
    showError('Missing required field: Please select your birth date.'); 
    return false; 
  }
  const age = calcAgeFromDOBStr(dob);
  if (age===null || age < 18){ 
    showError('Age requirement: This flow is for individuals 18 and over.'); 
    return false; 
  }
  const appt = document.querySelector('input[name="apptTypeSelf"]:checked');
  if (!appt){ 
    showError('Missing required field: Please select a preferred appointment type (At Home or At Office).'); 
    return false; 
  }
  if (!selectedSlot.self){ 
    showError('Missing required field: Please choose an available time slot.'); 
    return false; 
  }
  if (!document.getElementById('selfConsent').checked){ 
    showError('Missing required field: Please consent to receive appointment reminders.'); 
    return false; 
  }
  if (!document.getElementById('selfEmergency').checked){ 
    showError('Missing required field: Please confirm you are not experiencing an emergency.'); 
    return false; 
  }
  return true;
}

function validateGuardianFlow(){
  const gf = (document.getElementById('guardFirstName').value||'').trim();
  const gl = (document.getElementById('guardLastName').value||'').trim();
  const ge = (document.getElementById('guardEmail').value||'').trim();
  const gp = (document.getElementById('guardPhone').value||'').trim();
  
  if (!gf || !gl){ 
    showError('Missing required field: Please enter parent/guardian first and last name.'); 
    return false; 
  }
  if (ge && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(ge)){ 
    showError('Invalid email: Please enter a valid parent/guardian email or leave it blank.'); 
    return false; 
  }
  if (!gp){ 
    showError('Missing required field: Please enter parent/guardian phone number.'); 
    return false; 
  }
  const people = collectIndividuals();
  if (people.length === 0){ 
    showError('Missing required field: Please add at least one individual seeking services.'); 
    return false; 
  }
  for (const p of people){ 
    if (!p.first || !p.last || !p.dob){ 
      showError('Missing required field: Please complete first name, last name, and birth date for all individuals.'); 
      return false; 
    } 
  }
  const appt = document.querySelector('input[name="apptTypeGuardian"]:checked');
  if (!appt){ 
    showError('Missing required field: Please select a preferred appointment type (At Home or At Office).'); 
    return false; 
  }
  if (!selectedSlot.guardian){ 
    showError('Missing required field: Please choose a 3-hour start time.'); 
    return false; 
  }
  if (!document.getElementById('guardConsent').checked){ 
    showError('Missing required field: Please consent to receive appointment reminders.'); 
    return false; 
  }
  if (!document.getElementById('guardEmergency').checked){ 
    showError('Missing required field: Please confirm you are not experiencing an emergency.'); 
    return false; 
  }
  return true;
}

/* ===== Confirmation Card ===== */
function showConfirmation(opts){
  const card = document.getElementById('confirmationCard'); 
  if (!card) return;
  
  document.getElementById('confWhen').textContent = opts.whenText || '—';
  document.getElementById('confCounselor').textContent = opts.counselor || 'Assigned counselor';
  document.getElementById('confInPersonRow').style.display = '';
  
  card.classList.add('visible');
  card.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

/* ===== Submit ===== */
async function handleSubmit(e){
  e.preventDefault();
  hideMessages();

  if (!activeFlow){ 
    showError('Please select whether you are an individual or parent/guardian at the top of the form.'); 
    return; 
  }

  try{
    if (activeFlow === 'self'){
      if (!validateSelfFlow()) return;

      const first = document.getElementById('selfFirstName').value.trim();
      const last  = document.getElementById('selfLastName').value.trim();
      const email = document.getElementById('selfEmail').value.trim();
      const phone = document.getElementById('selfPhone').value.trim();
      const dob   = document.getElementById('selfDob').value.trim();
      const appt  = document.querySelector('input[name="apptTypeSelf"]:checked').value;
      const alt   = (document.getElementById('selfAltAvailability').value||'').trim();
      const notes = (document.getElementById('selfNotes').value||'').trim();

      const st = selectedSlot.self.start;
      const dur = selectedSlot.self.durationMinutes;
      const endHM = addMinutesToHM(st.hour, st.minute, dur);
      const startDT = ymdhms(selectedSlot.self.y, selectedSlot.self.m, selectedSlot.self.d, st.hour, st.minute);
      const endDT   = ymdhms(selectedSlot.self.y, selectedSlot.self.m, selectedSlot.self.d, endHM.hour, endHM.minute);

      const subject = (appt==='home'?'In-person (Home)':'In-person (Office)') + ' appointment';
      let body = `Appointment scheduled (${appt==='home'?'home in-person':'office in-person'}) for ${first} ${last} on ${humanTimeDisplayYMD(selectedSlot.self.y, selectedSlot.self.m, selectedSlot.self.d, st, endHM)}. Contact: ${phone}.`;
      if (email) body += ` Email: ${email}.`;
      if (alt) body += ` Alternate availability: ${alt}.`;
      if (notes) body += ` Additional notes: ${notes}.`;
      body += ` Date of Birth: ${dob}. Over 18: Yes.`;

      const payload = {
        subject, body,
        start: { dateTime: startDT, timeZone: CONFIG.TIMEZONE },
        end:   { dateTime: endDT,   timeZone: CONFIG.TIMEZONE },
        expectedDate: `${selectedSlot.self.y}-${p2(selectedSlot.self.m)}-${p2(selectedSlot.self.d)}`,
        location: { displayName: appt==='home' ? 'in-person-home' : 'in-person-office' },
        attendees: email ? [{ address: email, name: `${first} ${last}`, type:'required' }] : [],
        allowNewTimeProposals: true,
        transactionId: generateUUID(),
        dob, over18: 'yes', guardian: null, household: null
      };
      
      setButtonLoading(document.querySelector('#flowSelf button[type="submit"]'), true, 'Booking…');
      setGlobalLoading(true, 'Booking your appointment…');

      const resp = await fetch(withKey(CONFIG.BOOK_APPOINTMENT_URL, CONFIG.BOOK_APPOINTMENT_KEY), {
        method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json'},
        body: JSON.stringify(payload)
      });
      const result = await resp.json().catch(()=> ({}));
      if (!resp.ok || !result.ok || !result.id) {
        throw new Error(`Booking failed (${resp.status}) ${result.error || ''}`);
      }

      const whenText = humanTimeDisplayYMD(selectedSlot.self.y, selectedSlot.self.m, selectedSlot.self.d, st, endHM);
      const counselor = (result?.raw?.organizer?.emailAddress?.name) || (result?.raw?.organizer?.emailAddress?.address) || 'Assigned counselor';

      showSuccess();
      hideFormShowConfirmation();
      showConfirmation({ whenText, counselor });

    } else {
      if (!validateGuardianFlow()) return;

      const gf = document.getElementById('guardFirstName').value.trim();
      const gl = document.getElementById('guardLastName').value.trim();
      const ge = document.getElementById('guardEmail').value.trim();
      const gp = document.getElementById('guardPhone').value.trim();
      const people = collectIndividuals();
      const appt   = document.querySelector('input[name="apptTypeGuardian"]:checked').value;
      const alt    = (document.getElementById('guardAltAvailability').value||'').trim();
      const notes  = (document.getElementById('guardNotes').value||'').trim();

      const st = selectedSlot.guardian.start;
      const dur = selectedSlot.guardian.durationMinutes;
      const endHM = addMinutesToHM(st.hour, st.minute, dur);
      const startDT = ymdhms(selectedSlot.guardian.y, selectedSlot.guardian.m, selectedSlot.guardian.d, st.hour, st.minute);
      const endDT   = ymdhms(selectedSlot.guardian.y, selectedSlot.guardian.m, selectedSlot.guardian.d, endHM.hour, endHM.minute);

      const subject = 'Household intake (3-hour block)';
      let body = `Household intake (${appt==='home'?'home in-person':'office in-person'}) booked by ${gf} ${gl} on ${humanTimeDisplayYMD(selectedSlot.guardian.y, selectedSlot.guardian.m, selectedSlot.guardian.d, st, endHM)}. Contact: ${gp}.`;
      if (ge) body += ` Email: ${ge}.`;
      body += ' Individuals: ' + people.map(p => `${p.first} ${p.last} [DOB: ${p.dob}${p.under18===null?'':`, ${p.under18?'Under 18':'18+'}`}]`).join('; ') + '.';
      if (alt) body += ` Alternate availability: ${alt}.`;
      if (notes) body += ` Additional notes: ${notes}.`;

      const household = {
        hasSiblings: true, householdBlockMinutes: dur,
        under18Guardian: { sameAsMain: true, details: { name: `${gf} ${gl}`, phone: gp, email: ge } },
        siblings: people.map(p => ({
          name: `${p.first} ${p.last}`, dob: p.dob, under18: p.under18,
          needsAssessment: true, guardianSame: true,
          guardian: { name: `${gf} ${gl}`, phone: gp, email: ge }
        }))
      };

      const payload = {
        subject, body,
        start: { dateTime: startDT, timeZone: CONFIG.TIMEZONE },
        end:   { dateTime: endDT,   timeZone: CONFIG.TIMEZONE },
        expectedDate: `${selectedSlot.guardian.y}-${p2(selectedSlot.guardian.m)}-${p2(selectedSlot.guardian.d)}`,
        location: { displayName: appt==='home' ? 'in-person-home' : 'in-person-office' },
        attendees: ge ? [{ address: ge, name: `${gf} ${gl}`, type:'required' }] : [],
        allowNewTimeProposals: true,
        transactionId: generateUUID(),
        dob: null, over18: 'yes', guardian: { name: `${gf} ${gl}`, phone: gp, email: ge }, household
      };
      
      setButtonLoading(document.querySelector('#flowGuardian button[type="submit"]'), true, 'Booking…');
      setGlobalLoading(true, 'Booking your appointment…');

      const resp = await fetch(withKey(CONFIG.BOOK_APPOINTMENT_URL, CONFIG.BOOK_APPOINTMENT_KEY), {
        method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json'},
        body: JSON.stringify(payload)
      });
      const result = await resp.json().catch(()=> ({}));
      if (!resp.ok || !result.ok || !result.id) {
        throw new Error(`Booking failed (${resp.status}) ${result.error || ''}`);
      }

      const whenText = humanTimeDisplayYMD(selectedSlot.guardian.y, selectedSlot.guardian.m, selectedSlot.guardian.d, st, endHM);
      const counselor = (result?.raw?.organizer?.emailAddress?.name) || (result?.raw?.organizer?.emailAddress?.address) || 'Assigned counselor';

      showSuccess();
      hideFormShowConfirmation();
      showConfirmation({ whenText, counselor });
    }
  }catch(err){
    console.error(err);
    showError('There was an error booking your appointment. Please try again or contact us at 706-955-9224.');
  }
  finally {
    if (activeFlow === 'self') {
        setButtonLoading(document.querySelector('#flowSelf button[type="submit"]'), false);
    } else if (activeFlow === 'guardian') {
        setButtonLoading(document.querySelector('#flowGuardian button[type="submit"]'), false);
    }
    setGlobalLoading(false);
  }
}

/* ===== Hide form and show only confirmation ===== */
function hideFormShowConfirmation(){
  document.getElementById('flowSelf')?.style.setProperty('display', 'none');
  document.getElementById('flowGuardian')?.style.setProperty('display', 'none');
}

/* ===== Clear ===== */
function clearForm(){
  const form = document.getElementById('bookingForm'); 
  if (form) form.reset();

  selectedSlot.self = null; 
  selectedSlot.guardian = null;
  selectedDate.self = null;
  selectedDate.guardian = null;
  
  const tsSelf = document.getElementById('timeSlotsSelf'); 
  if (tsSelf) tsSelf.innerHTML = '';
  const tsG = document.getElementById('timeSlotsGuardian'); 
  if (tsG) tsG.innerHTML = '';

  const list = document.getElementById('individualsList');
  if (list){
    list.innerHTML = '';
    addIndividualCard();
  }

  document.querySelectorAll('.slot-chip').forEach(el=>{
    el.classList.remove('selected');
    el.style.background=''; el.style.color=''; el.style.borderColor=''; el.style.boxShadow='';
  });

  hideMessages();
}

function resetToSelection(){
  clearForm();
  activeFlow = null;
  
  document.getElementById('flowSelection').style.display = 'block';
  document.getElementById('bookingForm').classList.remove('visible');
  document.getElementById('flowSelf').style.display = 'none';
  document.getElementById('flowGuardian').style.display = 'none';
  document.getElementById('confirmationCard').classList.remove('visible');
  
  document.getElementById('flowTypeSelf').checked = false;
  document.getElementById('flowTypeGuardian').checked = false;
  document.getElementById('selfOptionCard').classList.remove('selected');
  document.getElementById('guardianOptionCard').classList.remove('selected');
  
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

/* ===== Wiring ===== */
document.addEventListener('DOMContentLoaded', () => {
  
  // Flow selection handlers
  const selfRadio = document.getElementById('flowTypeSelf');
  const guardianRadio = document.getElementById('flowTypeGuardian');
  const selfCard = document.getElementById('selfOptionCard');
  const guardianCard = document.getElementById('guardianOptionCard');
  
  selfRadio.addEventListener('change', () => {
    if (selfRadio.checked) {
      activeFlow = 'self';
      selfCard.classList.add('selected');
      guardianCard.classList.remove('selected');
      
      setTimeout(() => {
        document.getElementById('flowSelection').style.display = 'none';
        document.getElementById('bookingForm').classList.add('visible');
        document.getElementById('flowSelf').style.display = 'block';
        document.getElementById('flowGuardian').style.display = 'none';
        document.getElementById('flowSelf').scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 300);
    }
  });
  
  guardianRadio.addEventListener('change', () => {
    if (guardianRadio.checked) {
      activeFlow = 'guardian';
      guardianCard.classList.add('selected');
      selfCard.classList.remove('selected');
      
      setTimeout(() => {
        document.getElementById('flowSelection').style.display = 'none';
        document.getElementById('bookingForm').classList.add('visible');
        document.getElementById('flowGuardian').style.display = 'block';
        document.getElementById('flowSelf').style.display = 'none';
        document.getElementById('flowGuardian').scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 300);
    }
  });
  
  // Make cards clickable
  selfCard.addEventListener('click', () => selfRadio.click());
  guardianCard.addEventListener('click', () => guardianRadio.click());

  // "Book another" button
  document.getElementById('confBookAnother')?.addEventListener('click', resetToSelection);

  // Load Slots buttons
  document.getElementById('loadSlotsSelfBtn')?.addEventListener('click', ()=> loadAvailableSlots('self'));
  document.getElementById('loadSlotsGuardianBtn')?.addEventListener('click', ()=> loadAvailableSlots('guardian'));

  // Add individual
  document.getElementById('addIndividualBtn')?.addEventListener('click', addIndividualCard);

  // Ensure first person card has remove button
  const firstCard = document.querySelector('#individualsList .person-card');
  if (firstCard) {
    const removeBtn = firstCard.querySelector('.btn-remove');
    if (removeBtn) {
      removeBtn.addEventListener('click', () => firstCard.remove());
    }
  }

  // Phone masks
  function wirePhoneMask(id){
    const el = document.getElementById(id); 
    if (!el) return;
    el.addEventListener('input', e => {
      let v = e.target.value.replace(/\D/g,'').slice(0,10);
      if (v.length>6) e.target.value = v.slice(0,3)+'-'+v.slice(3,6)+'-'+v.slice(6);
      else if (v.length>3) e.target.value = v.slice(0,3)+'-'+v.slice(3);
      else e.target.value = v;
    });
  }
  wirePhoneMask('selfPhone'); 
  wirePhoneMask('guardPhone');

  // Clear buttons
  document.getElementById('clearSelfBtn')?.addEventListener('click', clearForm);
  document.getElementById('clearGuardianBtn')?.addEventListener('click', clearForm);
  
  // Submit
  document.getElementById('bookingForm')?.addEventListener('submit', handleSubmit);
});
</script>

</body>
</html>