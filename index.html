<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Still Waters Counseling - Book Your Appointment</title>
  <!-- Single-file build | v2025-09-12_dual-load-buttons | Separate slot loading for individuals vs households -->
<style>
  /* --- Reset & Tokens --- */
  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root{
    /* Palette (pleasant blues/teals with warm accents) */
    --primary: #4f46e5;   /* indigo-600 */
    --primary-700:#4338ca;
    --secondary:#06b6d4;  /* cyan-500 */
    --accent:  #38bdf8;   /* sky-400 */
    --success: #10b981;   /* emerald-500 */
    --danger:  #ef4444;   /* red-500 */

    /* Neutrals */
    --bg:      #f6f7fb;
    --card:    #ffffff;
    --muted:   #6b7280;   /* gray-500 */
    --text:    #0f172a;   /* slate-900 */
    --text-soft:#334155;  /* slate-700 */
    --border:  #e5e7eb;   /* gray-200 */

    /* Elevation */
    --shadow:  0 8px 24px rgba(2, 6, 23, .08);
    --shadow-lg: 0 18px 40px rgba(2, 6, 23, .12);

    /* Focus ring */
    --ring: rgba(79, 70, 229, .45);
    --ring-strong: rgba(6, 182, 212, .45);

    /* Radii */
    --r-lg: 20px;
    --r-xl: 24px;
    --r-full: 9999px;

    /* Transitions */
    --t-fast: .15s ease;
    --t-med: .25s ease;

    /* Slot sizing */
    --chip-min: 120px;
  }

  @media (prefers-color-scheme: dark){
    :root{
      --bg:      #0b1220;
      --card:    #0f172a;
      --text:    #e5e7eb;
      --text-soft:#cbd5e1;
      --border:  #1f2937;
      --shadow:  0 8px 24px rgba(0,0,0,.5);
      --shadow-lg: 0 18px 50px rgba(0,0,0,.55);
      --ring: rgba(56, 189, 248, .5);
      --ring-strong: rgba(99, 102, 241, .55);
    }
  }

  /* --- Page --- */
  body{
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
    color: var(--text);
    line-height: 1.6;
    min-height: 100vh;
    padding: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    background:
      radial-gradient(1200px 600px at 10% -10%, rgba(79,70,229,.14), transparent 60%),
      radial-gradient(800px 500px at 90% 10%, rgba(6,182,212,.16), transparent 55%),
      linear-gradient(180deg, var(--bg), var(--bg));
  }

  .container{
    width: 100%;
    max-width: 960px;
    background: linear-gradient(0deg, rgba(255,255,255,.6), rgba(255,255,255,.6)) , var(--card);
    backdrop-filter: saturate(120%) blur(6px);
    border: 1px solid var(--border);
    border-radius: var(--r-xl);
    box-shadow: var(--shadow-lg);
    overflow: hidden;
    animation: slideIn .4s ease-out both;
  }

  @keyframes slideIn{ from{ opacity:0; transform: translateY(18px);} to{ opacity:1; transform: translateY(0);} }

  /* --- Header --- */
  .header{
    padding: 40px 32px;
    color: #fff;
    background:
      radial-gradient(800px 200px at 20% -20%, rgba(56,189,248,.35), transparent 60%),
      linear-gradient(135deg, var(--primary), var(--secondary));
  }
  .header h1{
    font-size: clamp(1.8rem, 2.6vw, 2.6rem);
    font-weight: 700;
    letter-spacing: -0.02em;
    margin-bottom: 8px;
  }
  .header p{
    font-size: 1.05rem;
    opacity: .95;
  }

  /* --- Emergency banner --- */
  .emergency-notice{
    display: flex; align-items: center; justify-content: center; gap: 10px;
    padding: 14px 18px;
    color: #fff;
    background: linear-gradient(135deg, #f43f5e, #ef4444);
    border-bottom: 1px solid rgba(255,255,255,.25);
    font-weight: 600;
  }
  .emergency-notice svg{ width: 22px; height: 22px; }

  /* --- Form layout --- */
  .form-container{ padding: 32px; }
  .form-section{ margin-bottom: 28px; animation: fadeIn .35s ease-out both; }
  @keyframes fadeIn{ from{opacity:0} to{opacity:1} }

  .form-section h2{
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 16px;
  }

  .form-group{ margin-bottom: 16px; }
  .form-row{ display: grid; grid-template-columns: 1fr 1fr; gap: 18px; }

  label{
    display: block;
    color: var(--text-soft);
    font-weight: 600;
    margin-bottom: 8px;
    font-size: .95rem;
  }
  .required{ color: var(--danger); }

  /* --- Inputs --- */
  input[type="text"],
  input[type="email"],
  input[type="tel"],
  input[type="date"],
  input[type="time"],
  select,
  textarea{
    width: 100%;
    appearance: none;
    background: var(--card);
    color: var(--text);
    border: 1.5px solid var(--border);
    border-radius: 12px;
    padding: 12px 14px;
    font-size: 1rem;
    transition: border-color var(--t-fast), box-shadow var(--t-fast), background var(--t-fast), transform var(--t-fast);
  }
  textarea{ min-height: 110px; resize: vertical; }

  input:hover, select:hover, textarea:hover{
    border-color: color-mix(in oklab, var(--primary) 25%, var(--border));
  }
  input:focus, select:focus, textarea:focus{
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 4px var(--ring);
  }
  input:focus-visible, select:focus-visible, textarea:focus-visible{ outline: none; }

  /* --- Choice groups --- */
  .radio-group{ display:flex; gap:14px; flex-wrap:wrap; margin-top: 8px; }
  .radio-option{
    display:flex; align-items:center; gap:10px;
    background: var(--card);
    border: 1.5px solid var(--border);
    border-radius: 12px;
    padding: 12px 16px;
    cursor: pointer;
    transition: transform var(--t-fast), box-shadow var(--t-fast), border-color var(--t-fast), background var(--t-fast);
    user-select: none;
  }
  .radio-option:hover{ transform: translateY(-1px); border-color: var(--primary); box-shadow: var(--shadow); }
  .radio-option.selected{
    border-color: var(--primary);
    background: linear-gradient(0deg, rgba(79,70,229,.06), rgba(6,182,212,.06));
    box-shadow: inset 0 0 0 1.5px color-mix(in oklab, var(--primary) 60%, transparent);
  }
  .radio-option input[type="radio"]{ width: 18px; height: 18px; }

  .checkbox-group{ display:flex; align-items:flex-start; gap:10px; margin: 14px 0; }
  .checkbox-group input[type="checkbox"]{ width:18px; height:18px; margin-top: 3px; cursor: pointer; }

  /* --- Slots --- */
  .time-slots{ display: grid; grid-template-columns: 1fr; gap: 16px; margin-top: 14px; }
  .time-slot{
    background: var(--card);
    border: 1.5px solid var(--border);
    border-radius: 16px;
    padding: 16px;
    box-shadow: var(--shadow);
  }
  .time-slot .date{ font-weight: 800; font-size: 1rem; color: var(--text); margin-bottom: 6px; }
  .time-slot .range{ color: var(--muted); font-size: .95rem; margin-bottom: 12px; }

  .slot-grid{ display: grid; grid-template-columns: repeat(auto-fill, minmax(var(--chip-min), 1fr)); gap: 10px; }
  .slot-chip{
    padding: 10px 12px;
    text-align: center;
    border-radius: var(--r-full);
    background: linear-gradient(180deg, #ffffff, #fafafa);
    color: var(--text);
    border: 1.5px solid var(--border);
    font-weight: 600;
    font-size: .95rem;
    cursor: pointer;
    transition: transform var(--t-fast), box-shadow var(--t-fast), border-color var(--t-fast), background var(--t-fast), color var(--t-fast);
  }
  .slot-chip:hover{ transform: translateY(-1px); border-color: var(--primary); box-shadow: var(--shadow); }
  .slot-chip:focus-visible{ outline: 0; box-shadow: 0 0 0 4px var(--ring-strong); }
  .slot-chip.selected{
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: #fff;
    border-color: transparent;
    box-shadow: 0 8px 26px rgba(79,70,229,.35);
  }

  .hidden{ display:none !important; }

  /* --- Sibling cards --- */
  .sibling-card{
    background: var(--card);
    border: 1.5px solid var(--border);
    border-radius: 14px;
    padding: 14px;
    box-shadow: var(--shadow);
  }
  .sibling-header{ display:flex; justify-content: space-between; align-items:center; margin-bottom: 12px; }
  .sibling-title{ font-weight: 700; color: var(--text); }
  .sibling-row{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 10px; }

  .sibling-guardian-toggle{ display:flex; align-items:center; gap:10px; margin-bottom: 10px; }
  .sibling-guardian-fields{
    background: color-mix(in oklab, var(--secondary) 6%, var(--card));
    border: 1.5px dashed color-mix(in oklab, var(--secondary) 40%, var(--border));
    border-radius: 12px;
    padding: 14px;
    margin-top: 8px;
  }

  .btn-remove{
    border: 0; border-radius: 10px;
    background: linear-gradient(135deg, #f43f5e, #ef4444);
    color:#fff; padding: 8px 14px; font-weight: 700; cursor:pointer;
    transition: transform var(--t-fast), box-shadow var(--t-fast), opacity var(--t-fast);
  }
  .btn-remove:hover{ transform: translateY(-1px); box-shadow: var(--shadow); }

  .siblings-notice{
    background: color-mix(in oklab, #fde68a 35%, #ffffff);
    border: 1px solid #facc15;
    color: #854d0e;
    padding: 12px; border-radius: 10px; margin-bottom: 12px;
  }

  .hint{ color: var(--muted); font-size: .95rem; margin-bottom: 8px; }

  /* --- Buttons --- */
  .button-group{ display:flex; gap: 12px; justify-content:center; margin-top: 28px; flex-wrap: wrap; }
  .btn{
    border: 0; border-radius: 12px;
    padding: 14px 28px;
    font-size: 1.05rem; font-weight: 800; letter-spacing: .02em;
    cursor: pointer;
    transition: transform var(--t-med), box-shadow var(--t-med), opacity var(--t-fast);
  }
  .btn:disabled{ opacity:.6; cursor:not-allowed; }

  .btn-primary{
    color:#fff;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    box-shadow: 0 10px 28px rgba(79,70,229,.35);
  }
  .btn-primary:hover:not(:disabled){ transform: translateY(-2px); box-shadow: 0 16px 40px rgba(79,70,229,.45); }
  .btn-primary:focus-visible{ outline: 0; box-shadow: 0 0 0 4px var(--ring-strong); }

  .btn-secondary{
    color: var(--primary);
    background: linear-gradient(180deg, #ffffff, #fafafa);
    border: 1.5px solid color-mix(in oklab, var(--primary) 22%, var(--border));
  }
  .btn-secondary:hover{ transform: translateY(-2px); box-shadow: var(--shadow); }

  /* --- Alerts --- */
  .success-message,
  .error-message{
    display:none;
    border-radius: 12px;
    padding: 14px 16px;
    font-weight: 700;
    margin: 14px 0;
    box-shadow: var(--shadow);
    animation: slideDown .35s ease-out both;
  }
  @keyframes slideDown{ from{opacity:0; transform: translateY(-6px)} to{opacity:1; transform: translateY(0)} }

  .success-message{ background: color-mix(in oklab, var(--success) 18%, #ecfdf5); color: #065f46; border: 1.5px solid color-mix(in oklab, var(--success) 40%, #ffffff); }
  .error-message{ background: color-mix(in oklab, var(--danger) 18%, #fef2f2); color: #7f1d1d; border: 1.5px solid color-mix(in oklab, var(--danger) 40%, #ffffff); }

  /* --- Loading overlay --- */
  .loading-overlay{ position: fixed; inset:0; background: rgba(2,6,23,.5); display:none; place-items:center; z-index: 9999; }
  .loading-overlay.active{ display:grid; }
  .loading-content{
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 24px;
    text-align:center;
    box-shadow: var(--shadow-lg);
    color: var(--text);
  }
  .loading-content .spinner{
    width: 52px; height:52px; border: 5px solid var(--border);
    border-top-color: var(--primary); border-radius: 50%;
    animation: spin 1s linear infinite; margin: 0 auto 14px;
  }
  @keyframes spin{ to{ transform: rotate(360deg); } }

  /* --- Utilities --- */
  .slot-buttons-container{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  .slot-type-label{ font-weight: 800; color: var(--text-soft); }

  /* --- Responsive --- */
  @media (max-width: 768px){
    .form-row{ grid-template-columns: 1fr; }
    .button-group{ flex-direction: column; }
    .btn{ width: 100%; }
    .slot-grid{ grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }
    .sibling-row{ grid-template-columns: 1fr; }
    .header{ padding: 28px 22px; }
    .form-container{ padding: 22px; }
  }
  /* --- Confirmation card --- */
.confirm-card{
  display:none;
  background: color-mix(in oklab, var(--success) 10%, #fff);
  border: 1.5px solid color-mix(in oklab, var(--success) 30%, #fff);
  border-radius: 16px;
  padding: 18px;
  box-shadow: var(--shadow);
  margin: 16px 0;
}
.confirm-card.visible{ display:block; }
.confirm-card h3{ font-size:1.15rem; font-weight:800; margin-bottom:8px; color:#065f46; }
.confirm-row{ display:flex; gap:10px; align-items:flex-start; margin:6px 0; color:#064e3b; }
.confirm-row b{ min-width:130px; display:inline-block; color:#065f46; }
.confirm-actions{ display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; }
.confirm-actions .btn{ padding:10px 16px; font-size:.95rem; }

</style>

</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Still Waters Counseling</h1>
      <p>Schedule Your Intake Appointment</p>
    </div>

    <div class="emergency-notice">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/></svg>
      <span>If you are experiencing an emergency, please dial 911 immediately</span>
    </div>

    <form id="bookingForm" class="form-container" novalidate>
      <div id="successMessage" class="success-message">Appointment booked successfully! You'll receive a confirmation soon.</div>
      <div id="errorMessage" class="error-message">There was an error booking your appointment. Please try again.</div>
      
      <div id="confirmationCard" class="confirm-card" aria-live="polite">
  <h3>You're booked! 🎉</h3>
  <div class="confirm-row"><b>Date & time</b><span id="confWhen">—</span></div>
  <div class="confirm-row"><b>Counselor</b><span id="confCounselor">—</span></div>
  <div class="confirm-row" id="confTeleRow" style="display:none;"><b>Telehealth</b>
    <span><a id="confTeleLink" href="#" target="_blank" rel="noopener">Join video session</a></span>
  </div>
  <div class="confirm-row" id="confInPersonRow" style="display:none;"><b>Visit info</b>
    <span id="confVisitText">We’ll send directions and arrival details via email/text.</span>
  </div>
  <div class="confirm-actions">
    <a id="confOutlookLink" class="btn btn-secondary" href="#" target="_blank" rel="noopener">Open in Outlook</a>
    <button id="confBookAnother" type="button" class="btn btn-primary">Book another</button>
  </div>
</div>


      <div class="form-section">
        <h2>Client Information</h2>
        <div class="form-row">
          <div class="form-group">
            <label for="firstName">First Name <span class="required">*</span></label>
            <input type="text" id="firstName" name="firstName" required />
          </div>
          <div class="form-group">
            <label for="lastName">Last Name <span class="required">*</span></label>
            <input type="text" id="lastName" name="lastName" required />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="email">Email Address <span class="required">*</span></label>
            <input type="email" id="email" name="email" required />
          </div>
          <div class="form-group">
            <label for="phone">Phone Number <span class="required">*</span></label>
            <input type="tel" id="phone" name="phone" required placeholder="123-456-7890" />
          </div>
        </div>
      </div>

      <div class="form-section">
        <h2>Age Verification</h2>
        <div class="form-row">
          <div class="form-group">
            <label for="dob">Date of Birth <span class="required">*</span></label>
            <input type="date" id="dob" name="dob" required />
          </div>
          <div class="form-group">
            <label>Is the person receiving services over 18? <span class="required">*</span></label>
            <div class="radio-group">
              <div class="radio-option" data-over18="yes">
                <input type="radio" id="over18Yes" name="over18" value="yes" required />
                <label for="over18Yes">Yes</label>
              </div>
              <div class="radio-option" data-over18="no">
                <input type="radio" id="over18No" name="over18" value="no" required />
                <label for="over18No">No</label>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div id="guardianInfo" class="form-section hidden">
        <h2>Guardian Information</h2>
        <div class="form-row">
          <div class="form-group">
            <label for="guardianName">Guardian Name <span class="required">*</span></label>
            <input type="text" id="guardianName" name="guardianName" />
          </div>
          <div class="form-group">
            <label for="guardianPhone">Guardian Phone <span class="required">*</span></label>
            <input type="tel" id="guardianPhone" name="guardianPhone" placeholder="123-456-7890" />
          </div>
        </div>
        <div class="form-group">
          <label for="guardianEmail">Guardian Email <span class="required">*</span></label>
          <input type="email" id="guardianEmail" name="guardianEmail" />
        </div>
      </div>

      <!-- Siblings / Household Section -->
      <div class="form-section">
        <h2>Household / Siblings</h2>

        <div class="form-group">
          <label>Are there others in your household receiving services? <span class="required">*</span></label>
          <div class="radio-group">
            <div class="radio-option" data-household="yes">
              <input type="radio" id="householdYes" name="householdOthers" value="yes" required />
              <label for="householdYes">Yes</label>
            </div>
            <div class="radio-option" data-household="no">
              <input type="radio" id="householdNo" name="householdOthers" value="no" required />
              <label for="householdNo">No</label>
            </div>
          </div>
        </div>

        <div id="siblingsWrap" class="hidden">
         <div class="siblings-notice">
  <strong>Important:</strong> All household members will be scheduled in the same 3-hour block. You'll select the start time for the block.
</div>

<div id="siblingsList"></div>
<button type="button" class="btn btn-secondary" id="addSiblingBtn">+ Add Household Member</button>

<!-- Household-level guardian (one guardian for all under-18 siblings) -->
<div class="sibling-guardian-toggle" style="margin-top:16px">
  <input type="checkbox" id="householdGuardianSame" checked />
  <label for="householdGuardianSame">
    Guardian for under-18 household members is the same as the main client's guardian
  </label>
</div>

<div id="householdGuardianFields" class="sibling-guardian-fields hidden">
  <div class="form-row">
    <div class="form-group">
      <label>Guardian Name <span class="required">*</span></label>
      <input type="text" id="householdGuardianName" />
    </div>
    <div class="form-group">
      <label>Guardian Phone <span class="required">*</span></label>
      <input type="tel" id="householdGuardianPhone" placeholder="123-456-7890" />
    </div>
  </div>
  <div class="form-group">
    <label>Guardian Email <span class="required">*</span></label>
    <input type="email" id="householdGuardianEmail" />
  </div>
</div>
      </div>

      <div class="form-section">
        <h2>Appointment Type</h2>
        <div class="form-group">
          <label>Select your preferred appointment type <span class="required">*</span></label>
          <div class="radio-group">
            <div class="radio-option" data-type="telehealth">
              <input type="radio" id="telehealth" name="appointmentType" value="telehealth" required />
              <label for="telehealth">Telehealth (Video Call)</label>
            </div>
            <div class="radio-option" data-type="inperson">
              <input type="radio" id="inperson" name="appointmentType" value="inperson" required />
              <label for="inperson">In-Person Visit</label>
            </div>
          </div>
        </div>
      </div>

      <div class="form-section">
        <h2>Select Appointment Time</h2>
        <div class="form-group">
          <div id="normalSlotsSection">
            <button type="button" class="btn btn-secondary" id="loadSlotsBtn">Load Available Times (20-minute slots)</button>
          </div>
          <div id="householdSlotsSection" class="hidden">
            <button type="button" class="btn btn-secondary" id="loadHouseholdSlotsBtn">Load Available Times (3-hour blocks)</button>
          </div>
        </div>
        <div id="timeSlots" class="time-slots"></div>
      </div>

      <div class="form-section">
        <h2>Additional Information</h2>
        <div class="form-group">
          <label for="alternateAvailability">Alternate Availability (Optional)</label>
          <textarea id="alternateAvailability" name="alternateAvailability" placeholder="If the available slots don't work, please describe your availability"></textarea>
        </div>
        <div class="form-group">
          <label for="additionalNotes">Additional Notes (Optional)</label>
          <textarea id="additionalNotes" name="additionalNotes" placeholder="Any other information you'd like us to know"></textarea>
        </div>
      </div>

      <div class="form-section">
        <h2>Consent & Acknowledgments</h2>
        <div class="checkbox-group">
          <input type="checkbox" id="consent" name="consent" required />
          <label for="consent">I consent to receive appointment reminders via text and email <span class="required">*</span></label>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="emergency" name="emergency" required />
          <label for="emergency">I confirm that I am not currently experiencing a medical or mental health emergency <span class="required">*</span></label>
        </div>
      </div>

      <div class="button-group">
        <button type="button" class="btn btn-secondary" id="clearFormBtn">Clear Form</button>
        <button type="submit" class="btn btn-primary" id="submitBtn">
          Book Appointment
          <span class="loading-spinner hidden" id="submitSpinner"></span>
        </button>
      </div>
    </form>
  </div>

  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
      <div class="spinner"></div>
      <p id="overlayMessage">Processing your request...</p>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    var CONFIG = {
      GET_SLOTS_URL: 'https://sw-function-b6c4h9cnexhbh4g3.canadacentral-01.azurewebsites.net/api/Calender',
      BOOK_APPOINTMENT_URL: 'https://sw-function-b6c4h9cnexhbh4g3.canadacentral-01.azurewebsites.net/api/CreateEvent',
      GET_SLOTS_KEY: '',
      BOOK_APPOINTMENT_KEY: '',
      TIMEZONE: 'Central Standard Time',
      SLOT_MINUTES: 20,
      SIBLING_BLOCK_MINUTES: 180
    };

    // Global variables
    var selectedSlot = null;
    var availableSlots = [];
    var currentSlotMode = 'normal'; // 'normal' or 'household'
    var siblingCounter = 0;

    function withKey(url, key) {
      if (!key) return url;
      try { 
        var u = new URL(url); 
        u.searchParams.set('code', key); 
        return u.toString(); 
      }
      catch(e) { 
        var sep = url.indexOf('?')>=0 ? '&' : '?'; 
        return url + sep + 'code=' + encodeURIComponent(key); 
      }
    }
    
    function isSiblingFlow(){
      var val = document.querySelector('input[name="householdOthers"]:checked');
      return val && val.value === 'yes';
    }

    function addSiblingRow(){
  siblingCounter++;
  var list = document.getElementById('siblingsList');
  var div = document.createElement('div');
  div.className = 'sibling-card';
  div.setAttribute('data-sibling-id', siblingCounter);

  div.innerHTML = `
    <div class="sibling-header">
      <span class="sibling-title">Household Member</span>
      <button type="button" class="btn-remove">Remove</button>
    </div>
    <div class="sibling-row">
      <div class="form-group">
        <label>Name <span class="required">*</span></label>
        <input type="text" name="siblingName[]" required />
      </div>
      <div class="form-group">
        <label>Age Group <span class="required">*</span></label>
        <select name="siblingUnder18[]" class="sibling-age-select" required>
          <option value="no">18 or over</option>
          <option value="yes">Under 18</option>
        </select>
      </div>
    </div>
  `;

  list.appendChild(div);
  div.querySelector('.btn-remove').addEventListener('click', () => div.remove());
}

    function setupSiblingCardListeners(card) {
// Age select change
var ageSelect = card.querySelector('.sibling-age-select');
ageSelect.addEventListener('change', function() {
updateSiblingGuardianVisibility(card);
});


// Guardian same checkbox change
var guardianCheck = card.querySelector('.guardian-same-check');
guardianCheck.addEventListener('change', function() {
updateSiblingGuardianVisibility(card);
});


// Remove button
var removeBtn = card.querySelector('.btn-remove');
removeBtn.addEventListener('click', function() {
card.remove();
});


// Phone formatting for guardian phone
var guardianPhone = card.querySelector('.sib-guardian-phone');
if (guardianPhone) {
guardianPhone.addEventListener('input', function(e) {
var v = e.target.value.replace(/\D/g,'').slice(0,10);
if (v.length>6) e.target.value = v.slice(0,3)+'-'+v.slice(3,6)+'-'+v.slice(6);
else if (v.length>3) e.target.value = v.slice(0,3)+'-'+v.slice(3);
else e.target.value = v;
});
}


// Initialize state based on defaults
updateSiblingGuardianVisibility(card);
}
   function updateSiblingGuardianVisibility(card) {
var ageSelect = card.querySelector('.sibling-age-select');
var guardianCheck = card.querySelector('.guardian-same-check');
var guardianFields = card.querySelector('.sibling-guardian-fields');


var isUnder18 = (ageSelect.value === 'yes');
var notSameGuardian = !guardianCheck.checked;


// Always SHOW the fields if guardian is NOT same as main, hide otherwise
if (notSameGuardian) {
guardianFields.classList.remove('hidden');
} else {
guardianFields.classList.add('hidden');
// Clear & un-require when hiding
['.sib-guardian-name', '.sib-guardian-phone', '.sib-guardian-email'].forEach(sel => {
var el = card.querySelector(sel);
if (el) { el.required = false; el.value = ''; }
});
}


// Required iff Under 18 AND guardian != main
var req = isUnder18 && notSameGuardian;
var gn = card.querySelector('.sib-guardian-name');
var gp = card.querySelector('.sib-guardian-phone');
var ge = card.querySelector('.sib-guardian-email');
if (gn) gn.required = req;
if (gp) gp.required = req;
if (ge) ge.required = req;
}
    function collectSiblingsPayload(){
  var out = [];
  document.querySelectorAll('.sibling-card').forEach(card => {
    var name = (card.querySelector('[name="siblingName[]"]')?.value||'').trim();
    var under18 = (card.querySelector('[name="siblingUnder18[]"]')?.value||'no') === 'yes';
    out.push({ name, under18 });
  });
  return out;
}

function setupHouseholdGuardianUI(){
  var chk = document.getElementById('householdGuardianSame');
  var wrap = document.getElementById('householdGuardianFields');

  function formatPhone(el){
    if (!el) return;
    el.addEventListener('input', function(e){
      var v = e.target.value.replace(/\D/g,'').slice(0,10);
      if (v.length>6) e.target.value = v.slice(0,3)+'-'+v.slice(3,6)+'-'+v.slice(6);
      else if (v.length>3) e.target.value = v.slice(0,3)+'-'+v.slice(3);
      else e.target.value = v;
    });
  }
  formatPhone(document.getElementById('householdGuardianPhone'));

  function refresh(){
    if (chk.checked){
      wrap.classList.add('hidden');
      ['householdGuardianName','householdGuardianPhone','householdGuardianEmail'].forEach(id=>{
        var el = document.getElementById(id);
        if (el){ el.required = false; el.value = ''; }
      });
    } else {
      wrap.classList.remove('hidden');
      ['householdGuardianName','householdGuardianPhone','householdGuardianEmail'].forEach(id=>{
        var el = document.getElementById(id);
        if (el) el.required = true;
      });
    }
  }

  chk.addEventListener('change', refresh);
  refresh();
}


    document.addEventListener('DOMContentLoaded', function () {
      // Household radios styling + show/hide siblings
      document.querySelectorAll('.radio-option[data-household]').forEach(function(card){
        card.addEventListener('click', function(){
          var val = this.getAttribute('data-household');
          var radio = document.getElementById(val === 'yes' ? 'householdYes' : 'householdNo');
          if (radio) radio.checked = true;

          document.querySelectorAll('.radio-option[data-household]').forEach(c => c.classList.remove('selected'));
          this.classList.add('selected');

          var wrap = document.getElementById('siblingsWrap');
          var normalSection = document.getElementById('normalSlotsSection');
          var householdSection = document.getElementById('householdSlotsSection');
          
          if (val === 'yes') { 
            wrap.classList.remove('hidden');
            normalSection.classList.add('hidden');
            householdSection.classList.remove('hidden');
            if (!document.querySelector('.sibling-card')) addSiblingRow();
            // Clear any loaded slots when switching
            document.getElementById('timeSlots').innerHTML = '';
            selectedSlot = null;
          } else { 
            wrap.classList.add('hidden');
            normalSection.classList.remove('hidden');
            householdSection.classList.add('hidden');
            document.getElementById('siblingsList').innerHTML='';
            // Clear any loaded slots when switching
            document.getElementById('timeSlots').innerHTML = '';
            selectedSlot = null;
          }
        });
      });

      // Add sibling button
      document.getElementById('addSiblingBtn')?.addEventListener('click', addSiblingRow);

      // Handle Over 18 selection
      document.querySelectorAll('.radio-option[data-over18]').forEach(function(card){
        card.addEventListener('click', function(){
          var val = this.getAttribute('data-over18');
          var radio = document.getElementById(val === 'yes' ? 'over18Yes' : 'over18No');
          if (radio) radio.checked = true;

          document.querySelectorAll('.radio-option[data-over18]').forEach(c => c.classList.remove('selected'));
          this.classList.add('selected');

          const guardianSection = document.getElementById('guardianInfo');
          if (val === 'no') {
            guardianSection.classList.remove('hidden');
            document.getElementById('guardianName').required = true;
            document.getElementById('guardianPhone').required = true;
            document.getElementById('guardianEmail').required = true;
          } else {
            guardianSection.classList.add('hidden');
            document.getElementById('guardianName').required = false;
            document.getElementById('guardianPhone').required = false;
            document.getElementById('guardianEmail').required = false;
          }
        });
      });

      document.getElementById('bookingForm').addEventListener('submit', handleSubmit);
      document.getElementById('loadSlotsBtn').addEventListener('click', function() {
        currentSlotMode = 'normal';
        loadAvailableSlots();
      });
      document.getElementById('loadHouseholdSlotsBtn').addEventListener('click', function() {
        currentSlotMode = 'household';
        loadAvailableSlots();
      });
      document.getElementById('clearFormBtn').addEventListener('click', clearForm);

      // Appointment Type cards
      var typeCards = document.querySelectorAll('.radio-option[data-type]');
      typeCards.forEach(function(card){
        card.addEventListener('click', function(){
          selectAppointmentType(this.getAttribute('data-type'));
        });
      });
     
      setupHouseholdGuardianUI();

      // Phone number formatting
      document.getElementById('phone').addEventListener('input', function (e) {
        var v = e.target.value.replace(/\D/g,'').slice(0,10);
        if (v.length>6) e.target.value = v.slice(0,3)+'-'+v.slice(3,6)+'-'+v.slice(6);
        else if (v.length>3) e.target.value = v.slice(0,3)+'-'+v.slice(3);
        else e.target.value = v;
      });

      document.getElementById('guardianPhone').addEventListener('input', function (e) {
        var v = e.target.value.replace(/\D/g,'').slice(0,10);
        if (v.length>6) e.target.value = v.slice(0,3)+'-'+v.slice(3,6)+'-'+v.slice(6);
        else if (v.length>3) e.target.value = v.slice(0,3)+'-'+v.slice(3);
        else e.target.value = v;
      });
    });

    function generateUUID(){ 
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){ 
        var r=Math.random()*16|0, v=c==='x'?r:(r&0x3)|0x8; 
        return v.toString(16).toUpperCase(); 
      }); 
    }

    function selectAppointmentType(type){
      var radio = document.getElementById(type === 'telehealth' ? 'telehealth' : 'inperson');
      if (radio) radio.checked = true;

      var cards = document.querySelectorAll('.radio-option[data-type]');
      for (var i = 0; i < cards.length; i++) cards[i].classList.remove('selected');
      var chosen = document.querySelector('.radio-option[data-type="' + type + '"]');
      if (chosen) chosen.classList.add('selected');
    }

    function parseSlotString(slotStr){
// Example: "12 Sep 2025, 02:25 PM - 02:40 PM"
const parts = slotStr.split(', ');
if (parts.length < 2) {
throw new Error('Unexpected slot format: ' + slotStr);
}


const datePart = parts[0]; // "12 Sep 2025"
const timePart = parts[1]; // "02:25 PM - 02:40 PM"


const [dayStr, monStr, yearStr] = datePart.split(' ');
const day = parseInt(dayStr, 10);
const year = parseInt(yearStr, 10);


const monthMap = {Jan:1,Feb:2,Mar:3,Apr:4,May:5,Jun:6,Jul:7,Aug:8,Sep:9,Oct:10,Nov:11,Dec:12};
const monthNum = monthMap[monStr];
if (!monthNum) {
throw new Error('Unknown month in slot: ' + slotStr);
}


const [startStr, endStr] = timePart.split(' - '); // ["02:25 PM","02:40 PM"]
const start24 = convertTo24Hour(startStr);
const end24 = convertTo24Hour(endStr);


const startMin = hmToMinutes(start24.hours, start24.minutes);
const endMin = hmToMinutes(end24.hours, end24.minutes);


const mm = String(monthNum).padStart(2, '0');
const dd = String(day).padStart(2, '0');


return {
y: year, m: monthNum, d: day,
dateStr: datePart,
startTimeStr: startStr,
endTimeStr: endStr,
startMin,
endMin,
dateKey: `${year}-${mm}-${dd}`
};
}

    function convertTo24Hour(timeStr){
      var t=timeStr.trim().split(' ');
      var hm=t[0].split(':'), h=parseInt(hm[0],10), m=parseInt(hm[1],10), p=t[1];
      if(p==='PM'&&h!==12)h+=12;
      if(p==='AM'&&h===12)h=0;
      return {hours:h, minutes:m};
    }

    function p2(n){return (n<10?'0':'')+n;}

    function ymdhms(y,m,d,h,mi){ 
      return y+'-'+p2(m)+'-'+p2(d)+'T'+p2(h)+':'+p2(mi)+':00'; 
    }

    function dowForYMD(y,m,d){
      var days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      var idx = new Date(Date.UTC(y, m-1, d)).getUTCDay();
      return days[idx];
    }

    function hmToMinutes(h,m){ return h*60+m; }
    function minutesToHM(total){ return {hour: Math.floor(total/60), minute: total%60}; }

    function addMinutesToHM(h, m, delta){
      var total = h*60 + m + delta;
      return { hour: Math.floor(total/60), minute: total%60 };
    }

    function t12fmt(h, m){
      function p2(n){return (n<10?'0':'')+n;}
      var ap=h>=12?'PM':'AM';
      var hh=h%12===0?12:(h%12);
      return hh + ':' + p2(m) + ' ' + ap;
    }

    async function loadAvailableSlots(){
      var overlay=document.getElementById('loadingOverlay'); 
      overlay.classList.add('active');
      var url = withKey(CONFIG.GET_SLOTS_URL, CONFIG.GET_SLOTS_KEY);
      try{
        var resp = await fetch(url, { method:'GET', headers:{'Accept':'application/json'} });
        var text = await resp.text();
        console.log('[GET /Calender]', resp.status, text);
        if(!resp.ok) throw new Error('Failed to load slots ('+resp.status+')');
        var data = text? JSON.parse(text):{};
        var list = Array.isArray(data)? data
                  : (Array.isArray(data.free_slots)? data.free_slots
                  : (Array.isArray(data.freeSlots)? data.freeSlots
                  : (Array.isArray(data.slots)? data.slots : [])));
        availableSlots = list.map(parseSlotString);
        
        if (currentSlotMode === 'household') {
          displayHouseholdSlots(availableSlots);
        } else {
          displayNormalSlots(availableSlots);
        }
      }catch(e){
        console.error(e);
        showError('Failed to load available appointment times. Please try again.');
      }
      finally{ 
        overlay.classList.remove('active'); 
      }
    }

    function groupByDate(slots){
  const map = {};
  slots.forEach(s => {
    const key = s.dateKey ?? `${s.y}-${String(s.m).padStart(2,'0')}-${String(s.d).padStart(2,'0')}`;
    if (!map[key]) {
      map[key] = { y: s.y, m: s.m, d: s.d, dateStr: s.dateStr, windows: [] };
    }
    map[key].windows.push({
      startMin: s.startMin,
      endMin: s.endMin,
      startStr: s.startTimeStr,
      endStr: s.endTimeStr
    });
  });
  return map;
}



function windowsToText(windows){
return windows.map(w => {
const s = minutesToHM(w.startMin), e = minutesToHM(w.endMin);
return t12fmt(s.hour, s.minute) + ' - ' + t12fmt(e.hour, e.minute);
}).join(', ');
}

function localDow(y,m,d){
const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
return days[new Date(y, m-1, d).getDay()];
}

    function displayNormalSlots(slots){
  const container = document.getElementById('timeSlots');
  container.innerHTML = '';

  selectedSlot = null;

  if (!slots || !slots.length){
    container.innerHTML = '<p>No available slots returned by the server. Please check back later.</p>';
    return;
  }

  // Accept raw strings or already-parsed objects
  if (typeof slots[0] === 'string' || !('startMin' in slots[0])) {
    try { slots = slots.map(parseSlotString); }
    catch (e) { console.error(e); container.innerHTML = '<p>Could not parse slots from server.</p>'; return; }
  }

  const byDate = groupByDate(slots);
  const keys = Object.keys(byDate).sort();

  if (!keys.length){
    container.innerHTML = '<p>No available windows returned by the server.</p>';
    return;
  }

  keys.forEach(key => {
    const dayData = byDate[key];

    const card = document.createElement('div');
    card.className = 'time-slot';

    const header = document.createElement('div');
    header.className = 'date';
    header.textContent = localDow(dayData.y, dayData.m, dayData.d) + ' ' + dayData.dateStr;

    const sub = document.createElement('div');
    sub.className = 'range';
    sub.textContent = 'Available: ' + windowsToText(dayData.windows);

    const grid = document.createElement('div');
    grid.className = 'slot-grid';

    const emittedStarts = new Set(); // avoid duplicate chips if windows overlap

    dayData.windows.forEach(w => {
      for (let m = w.startMin; m + CONFIG.SLOT_MINUTES <= w.endMin; m += CONFIG.SLOT_MINUTES) {
        if (emittedStarts.has(m)) continue;
        emittedStarts.add(m);

        const startHM = minutesToHM(m);
        const endHM   = minutesToHM(m + CONFIG.SLOT_MINUTES);

        const chipEl = document.createElement('div');
        chipEl.className = 'slot-chip';
        chipEl.setAttribute('role','button');
        chipEl.setAttribute('tabindex','0');
        chipEl.textContent = t12fmt(startHM.hour, startHM.minute) + '–' + t12fmt(endHM.hour, endHM.minute);

        chipEl.addEventListener('click', () => {
          document.querySelectorAll('.slot-chip').forEach(el => el.classList.remove('selected'));
          chipEl.classList.add('selected');

          selectedSlot = {
            y: dayData.y, m: dayData.m, d: dayData.d,
            dateStr: dayData.dateStr,
            start: { hour: startHM.hour, minute: startHM.minute },
            durationMinutes: CONFIG.SLOT_MINUTES,
            display: chipEl.textContent,
            mode: 'normal'
          };
        });

        chipEl.addEventListener('keydown', (ev) => {
          if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); chipEl.click(); }
        });

        grid.appendChild(chipEl);
      }
    });

    if (grid.children.length === 0) {
      const emptyMsg = document.createElement('div');
      emptyMsg.style.color = 'var(--gray-medium)';
      emptyMsg.textContent = "No 20-minute slots within today's windows.";
      grid.appendChild(emptyMsg);
    }

    card.appendChild(header);
    card.appendChild(sub);
    card.appendChild(grid);
    container.appendChild(card);
  });
}

    function displayHouseholdSlots(slots){
  const container = document.getElementById('timeSlots');
  container.innerHTML = '';
  selectedSlot = null;

  if (!slots || !slots.length){
    container.innerHTML = '<p>No available slots returned by the server. Please check back later.</p>';
    return;
  }
  if (typeof slots[0] === 'string' || !('startMin' in slots[0])) {
    try { slots = slots.map(parseSlotString); }
    catch(e){ console.error(e); container.innerHTML = '<p>Could not parse slots from server.</p>'; return; }
  }

  const byDate = groupByDate(slots);
  const keys = Object.keys(byDate).sort();
  if (!keys.length){
    container.innerHTML = '<p>No available windows returned by the server.</p>';
    return;
  }

  keys.forEach(key => {
    const dayData = byDate[key];

    const card = document.createElement('div');
    card.className = 'time-slot';

    const header = document.createElement('div');
    header.className = 'date';
    header.textContent = localDow(dayData.y, dayData.m, dayData.d) + ' ' + dayData.dateStr;

    const sub = document.createElement('div');
    sub.className = 'range';
    sub.textContent = 'Available window(s): ' + windowsToText(dayData.windows);

    const grid = document.createElement('div');
    grid.className = 'slot-grid';

    const emittedStarts = new Set();
    const need = CONFIG.SIBLING_BLOCK_MINUTES; // 180

    dayData.windows.forEach(w => {
      if ((w.endMin - w.startMin) < need) return;
      for (let m = w.startMin; m + need <= w.endMin; m += CONFIG.SLOT_MINUTES) {
        if (emittedStarts.has(m)) continue;
        emittedStarts.add(m);

        const startHM = minutesToHM(m);

        const chipEl = document.createElement('div');
        chipEl.className = 'slot-chip';
        chipEl.setAttribute('role','button');
        chipEl.setAttribute('tabindex','0');
        chipEl.textContent = t12fmt(startHM.hour, startHM.minute); // start only

        chipEl.addEventListener('click', () => {
          document.querySelectorAll('.slot-chip').forEach(el => el.classList.remove('selected'));
          chipEl.classList.add('selected');
          selectedSlot = {
            y: dayData.y, m: dayData.m, d: dayData.d,
            dateStr: dayData.dateStr,
            start: { hour: startHM.hour, minute: startHM.minute },
            durationMinutes: CONFIG.SIBLING_BLOCK_MINUTES,
            display: chipEl.textContent + ' (3-hour block)',
            mode: 'household'
          };
        });

        chipEl.addEventListener('keydown', (ev) => {
          if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); chipEl.click(); }
        });

        grid.appendChild(chipEl);
      }
    });

    if (grid.children.length === 0) {
      const emptyMsg = document.createElement('div');
      emptyMsg.style.color = 'var(--gray-medium)';
      emptyMsg.textContent = 'No 3-hour start times fit within today\'s windows.';
      grid.appendChild(emptyMsg);
    }

    card.appendChild(header);
    card.appendChild(sub);
    card.appendChild(grid);
    container.appendChild(card);
  });
}
    function humanTimeDisplayYMD(y,m,d,start,end){
      var mons=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      function p2(n){return (n<10?'0':'')+n;}
      function t12fmt(h,mn){
        var ap=h>=12?'pm':'am';
        var hh=h%12===0?12:h%12;
        return hh+(mn?':'+p2(mn):'')+ap;
      }
      return d+' '+mons[m-1]+' '+y+', '+t12fmt(start.hour,start.minute)+'–'+t12fmt(end.hour,end.minute);
    }

    function validateForm(){
  hideMessages();

  if(!selectedSlot){
    showError('Please choose a start time.');
    return false;
  }

  var appt = document.querySelector('input[name="appointmentType"]:checked');
  if(!appt){ 
    showError('Please select an appointment type'); 
    return false; 
  }

  var email=document.getElementById('email').value.trim();
  if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){
    showError('Please enter a valid email address');
    return false;
  }
  
  var dob = new Date(document.getElementById('dob').value);
  if (isNaN(dob)) {
    showError('Please enter a valid Date of Birth');
    return false;
  }
  var today = new Date();
  var age = today.getFullYear() - dob.getFullYear();
  var m = today.getMonth() - dob.getMonth();
  if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) age--;

  var over18Choice = document.querySelector('input[name="over18"]:checked');
  if (!over18Choice) {
    showError('Please select whether the client is over 18');
    return false;
  }
  if ((age >= 18 && over18Choice.value === 'no') || (age < 18 && over18Choice.value === 'yes')) {
    showError('The DOB and Over-18 selection do not match.');
    return false;
  }

  if(!document.getElementById('consent').checked){
    showError('Please consent to receive appointment reminders');
    return false;
  }
  if(!document.getElementById('emergency').checked){
    showError('Please confirm you are not experiencing an emergency');
    return false;
  }

  if (isSiblingFlow()) {
    // Gather and validate siblings
    var sibs = collectSiblingsPayload();
    if (sibs.length === 0) {
      showError('Please add at least one household member.');
      return false;
    }
    for (var i=0;i<sibs.length;i++){
      if (!sibs[i].name) { 
        showError('Please enter a name for each household member.'); 
        return false; 
      }
    }

    var anyUnder18 = sibs.some(s => s.under18);
    var same = document.getElementById('householdGuardianSame').checked;

    if (anyUnder18){
      if (same){
        // If minors use same guardian as main, the main must have a guardian on file.
        if (over18Choice.value === 'yes'){
          showError('At least one household member is under 18. Please uncheck the "same as main" option and provide guardian details for minors.');
          return false;
        } else {
          // Ensure main guardian fields present
          var gn = (document.getElementById('guardianName').value||'').trim();
          var gp = (document.getElementById('guardianPhone').value||'').trim();
          var ge = (document.getElementById('guardianEmail').value||'').trim();
          if (!gn || !gp || !ge){
            showError('Please complete the main guardian information for the minors.');
            return false;
          }
          if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(ge)){
            showError('Please enter a valid main guardian email');
            return false;
          }
        }
      } else {
        // Alternate household guardian required
        var hgn = (document.getElementById('householdGuardianName').value||'').trim();
        var hgp = (document.getElementById('householdGuardianPhone').value||'').trim();
        var hge = (document.getElementById('householdGuardianEmail').value||'').trim();
        if (!hgn || !hgp || !hge){
          showError('Please complete the alternate guardian information for the minors.');
          return false;
        }
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(hge)){
          showError('Please enter a valid alternate guardian email');
          return false;
        }
      }
    }

    // Ensure household slot mode is used
    if (selectedSlot && selectedSlot.mode !== 'household') {
      showError('Please use "Load Available Times (3-hour blocks)" for household appointments.');
      return false;
    }
  } else {
    // Individual: ensure normal slot mode is used
    if (selectedSlot && selectedSlot.mode === 'household') {
      showError('Please use "Load Available Times (20-minute slots)" for individual appointments.');
      return false;
    }
  }

  return true;
}

function showConfirmation(opts){
  // opts: { whenText, counselor, isTele, teleUrl, inPersonText, webLink }
  const card = document.getElementById('confirmationCard');
  document.getElementById('confWhen').textContent = opts.whenText || '—';
  document.getElementById('confCounselor').textContent = opts.counselor || 'Assigned counselor';

  const teleRow = document.getElementById('confTeleRow');
  const inRow   = document.getElementById('confInPersonRow');

  if (opts.isTele){
    teleRow.style.display = '';
    inRow.style.display = 'none';
    const a = document.getElementById('confTeleLink');
    if (opts.teleUrl){
      a.href = opts.teleUrl;
      a.textContent = 'Join video session';
    } else {
      // Fallback: no join URL on the event yet
      a.removeAttribute('href');
      a.textContent = 'We\'ll send your secure video link shortly';
    }
  } else {
    teleRow.style.display = 'none';
    inRow.style.display = '';
    document.getElementById('confVisitText').textContent =
      opts.inPersonText || 'We’ll send directions and arrival details via email/text.';
  }

  const ol = document.getElementById('confOutlookLink');
  if (opts.webLink){ ol.href = opts.webLink; } else { ol.removeAttribute('href'); }

  card.classList.add('visible');
  // Scroll into view for mobile
  card.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function friendlyWhenFromSelected(){
  // Uses the already-picked slot (avoids any timezone ambiguity)
  const st = { hour: selectedSlot.start.hour, minute: selectedSlot.start.minute };
  const endHM = addMinutesToHM(st.hour, st.minute, selectedSlot.durationMinutes);
  return humanTimeDisplayYMD(selectedSlot.y, selectedSlot.m, selectedSlot.d, st, endHM);
}


    async function handleSubmit(e){
  e.preventDefault();
  if(!validateForm()) return;

  const btn=document.getElementById('submitBtn');
  const spin=document.getElementById('submitSpinner');
  const overlay=document.getElementById('loadingOverlay');
  const overlayMsg=document.getElementById('overlayMessage');

  // Button spinner + overlay
  btn.disabled=true;
  spin.classList.remove('hidden');
  const prevOverlayText = overlayMsg.textContent;
  overlayMsg.textContent = 'Submitting your booking…';
  overlay.classList.add('active');

  // Hide any previous confirmation card
  document.getElementById('confirmationCard')?.classList.remove('visible');

  try{
    const form=new FormData(e.target);
    const first=String(form.get('firstName')||'').trim(),
          last =String(form.get('lastName')||'').trim(),
          email=String(form.get('email')||'').trim(),
          phone=String(form.get('phone')||'').trim(),
          apptType=String(form.get('appointmentType')||'').trim();

    const dob = String(form.get('dob') || '').trim();
    const over18Choice = String(form.get('over18') || '').trim(); // 'yes' | 'no'
    const guardianName = String(form.get('guardianName') || '').trim();
    const guardianPhone = String(form.get('guardianPhone') || '').trim();
    const guardianEmail = String(form.get('guardianEmail') || '').trim();

    const st = { hour: selectedSlot.start.hour, minute: selectedSlot.start.minute };
    const duration = selectedSlot.durationMinutes;
    const endHM = addMinutesToHM(st.hour, st.minute, duration);

    const startDT = ymdhms(selectedSlot.y, selectedSlot.m, selectedSlot.d, st.hour, st.minute);
    const endDT   = ymdhms(selectedSlot.y, selectedSlot.m, selectedSlot.d, endHM.hour, endHM.minute);

    const apptTypeLabel = (apptType === 'telehealth' ? 'telehealth' : 'in-person');

    let subjectBase = (apptType==='telehealth'?'Telehealth':'In-person')+' appointment';
    if (isSiblingFlow()) subjectBase = 'Household intake (3-hour block)';

    let body='Appointment scheduled for '+apptTypeLabel+' with '+first+' '+last+' on '
           + humanTimeDisplayYMD(selectedSlot.y, selectedSlot.m, selectedSlot.d, st, endHM)
           + '. Contact: '+phone+'.';

    const alt=String(form.get('alternateAvailability')||''),
          notes=String(form.get('additionalNotes')||'');

    if(alt)  body+=' Alternate availability: '+alt+'.';
    if(notes)body+=' Additional notes: '+notes+'.';
    body += ' Date of Birth: ' + dob + '.';
    body += ' Over 18: ' + (over18Choice === 'yes' ? 'Yes' : 'No') + '.';

    // Household payload (as you already had)
    let householdPayload = null;
    if (isSiblingFlow()) {
      const siblings = collectSiblingsPayload();
      const anyUnder18 = siblings.some(s => s.under18);
      const same = document.getElementById('householdGuardianSame').checked;

      let hGuardian = null;
      if (anyUnder18){
        if (same){
          hGuardian = (over18Choice === 'no') ? {
            name: guardianName, phone: guardianPhone, email: guardianEmail
          } : null;
        } else {
          hGuardian = {
            name:  (document.getElementById('householdGuardianName').value||'').trim(),
            phone: (document.getElementById('householdGuardianPhone').value||'').trim(),
            email: (document.getElementById('householdGuardianEmail').value||'').trim()
          };
        }
      }

      const siblingsForPayload = siblings.map(s => {
        const row = { name: s.name, under18: s.under18 };
        if (s.under18){
          row.guardianSame = same;
          row.guardian = hGuardian ? { ...hGuardian } : null;
        }
        return row;
      });

      householdPayload = { 
        hasSiblings: true, 
        householdBlockMinutes: duration,
        under18Guardian: { sameAsMain: same, details: hGuardian },
        siblings: siblingsForPayload
      };

      body += ' Household members: ' + siblings.map(s => (
        s.name + ' [' + (s.under18 ? 'Under 18' : '18+') + ']'
      )).join('; ') + '.';

      if (anyUnder18){
        if (same && hGuardian){
          body += ' Under-18 guardian (same as main): ' + hGuardian.name +
                  ' (Phone: ' + hGuardian.phone + ', Email: ' + hGuardian.email + ').';
        } else if (!same && hGuardian){
          body += ' Under-18 guardian: ' + hGuardian.name +
                  ' (Phone: ' + hGuardian.phone + ', Email: ' + hGuardian.email + ').';
        } else if (same && !hGuardian){
          body += ' Under-18 guardian: same as main.';
        }
      }
    } else {
      if (over18Choice === 'no') {
        body += ' Guardian: ' + guardianName +
                ' (Phone: ' + guardianPhone +
                ', Email: ' + guardianEmail + ').';
      }
    }

    const payload={
      subject: subjectBase,
      body: body,
      start: { dateTime: startDT, timeZone: CONFIG.TIMEZONE },
      end:   { dateTime: endDT,   timeZone: CONFIG.TIMEZONE },
      expectedDate: selectedSlot.y + '-' + p2(selectedSlot.m) + '-' + p2(selectedSlot.d),
      location:{ displayName: apptType==='telehealth'?'video':'in-person' },
      attendees:[{ address: email, name: first+' '+last, type:'required' }],
      allowNewTimeProposals:true,
      transactionId: generateUUID(),
      dob: dob,
      over18: over18Choice,
      guardian: over18Choice === 'no' ? {
        name: guardianName, phone: guardianPhone, email: guardianEmail
      } : null,
      household: householdPayload
    };

    console.log('[BOOK payload]', payload);

    const url=withKey(CONFIG.BOOK_APPOINTMENT_URL, CONFIG.BOOK_APPOINTMENT_KEY);
    const resp=await fetch(url,{ method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json'}, body: JSON.stringify(payload) });

    if(!resp.ok){
      let t=''; try{ t=await resp.text(); }catch(_){}
      throw new Error('Failed to book ('+resp.status+') '+t);
    }

    const result = await resp.json(); // get data for confirmation

    // Success banner
    showSuccess();

    // Build confirmation details
    const whenText = friendlyWhenFromSelected();
    const counselor =
      (result?.raw?.organizer?.emailAddress?.name) ||
      (result?.raw?.organizer?.emailAddress?.address) ||
      'Assigned counselor';

    const teleUrl =
      (result?.raw?.onlineMeeting?.joinUrl) ||
      (result?.raw?.onlineMeetingUrl) ||
      null;

    const isTele = (payload.location?.displayName === 'video') || !!teleUrl;
    const inPersonText = (result?.location?.displayName && result.location.displayName !== 'video')
      ? `Location: ${result.location.displayName}. We’ll send directions and arrival details.`
      : 'We’ll send directions and arrival details via email/text.';

    showConfirmation({
      whenText,
      counselor,
      isTele,
      teleUrl,
      inPersonText,
      webLink: result?.webLink || null
    });

    // “Book another” resets the form and hides the card
    document.getElementById('confBookAnother').onclick = function(){
      clearForm();
      document.getElementById('confirmationCard').classList.remove('visible');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };

  }catch(err){
    console.error(err);
    showError('There was an error booking your appointment. Please try again or call us directly.');
  }finally{
    // Restore UI
    btn.disabled=false;
    spin.classList.add('hidden');
    const overlay=document.getElementById('loadingOverlay');
    const overlayMsg=document.getElementById('overlayMessage');
    overlay.classList.remove('active');
    overlayMsg.textContent = 'Processing your request...'; // reset for next time
  }
}


    function clearForm(){
      document.getElementById('bookingForm').reset();
      document.getElementById('guardianInfo').classList.add('hidden');
      document.getElementById('siblingsWrap').classList.add('hidden');
      document.getElementById('siblingsList').innerHTML='';
      document.getElementById('normalSlotsSection').classList.remove('hidden');
      document.getElementById('householdSlotsSection').classList.add('hidden');
      document.getElementById('timeSlots').innerHTML='';
      selectedSlot=null;
      availableSlots = [];
      currentSlotMode = 'normal';
      siblingCounter = 0;
      hideMessages();
      var allChips = document.querySelectorAll('.slot-chip');
      for (var k=0;k<allChips.length;k++) allChips[k].classList.remove('selected');
      var cards=document.querySelectorAll('.radio-option');
      for(var i=0;i<cards.length;i++) cards[i].classList.remove('selected');
    }

    function showSuccess(){ 
      hideMessages(); 
      var el=document.getElementById('successMessage'); 
      el.style.display='block'; 
      setTimeout(function(){ el.style.display='none'; }, 5000); 
    }
    
    function showError(msg){ 
      hideMessages(); 
      var el=document.getElementById('errorMessage'); 
      el.textContent=msg; 
      el.style.display='block'; 
      setTimeout(function(){ el.style.display='none'; }, 6000); 
    }
    
    function hideMessages(){ 
      document.getElementById('successMessage').style.display='none'; 
      document.getElementById('errorMessage').style.display='none'; 
    }
  </script>
</body>
</html>