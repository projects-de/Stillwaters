<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Still Waters Counseling - Intake Form</title>
  <style>
  /* --- Reset & Tokens --- */
  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root{
    /* Palette (pleasant blues/teals with warm accents) */
    --primary: #4f46e5;   /* indigo-600 */
    --primary-700:#4338ca;
    --secondary:#06b6d4;  /* cyan-500 */
    --accent:  #38bdf8;   /* sky-400 */
    --success: #10b981;   /* emerald-500 */
    --danger:  #ef4444;   /* red-500 */

    /* Neutrals */
    --bg:      #f6f7fb;
    --card:    #ffffff;
    --muted:   #6b7280;   /* gray-500 */
    --text:    #0f172a;   /* slate-900 */
    --text-soft:#334155;  /* slate-700 */
    --border:  #e5e7eb;   /* gray-200 */

    /* Elevation */
    --shadow:  0 8px 24px rgba(2, 6, 23, .08);
    --shadow-lg: 0 18px 40px rgba(2, 6, 23, .12);

    /* Focus ring */
    --ring: rgba(79, 70, 229, .45);
    --ring-strong: rgba(6, 182, 212, .45);

    /* Radii */
    --r-lg: 20px;
    --r-xl: 24px;
    --r-full: 9999px;

    /* Transitions */
    --t-fast: .15s ease;
    --t-med: .25s ease;
  }

  @media (prefers-color-scheme: dark){
    :root{
      --bg:      #0b1220;
      --card:    #0f172a;
      --text:    #e5e7eb;
      --text-soft:#cbd5e1;
      --border:  #1f2937;
      --shadow:  0 8px 24px rgba(0,0,0,.5);
      --shadow-lg: 0 18px 50px rgba(0,0,0,.55);
      --ring: rgba(56, 189, 248, .5);
      --ring-strong: rgba(99, 102, 241, .55);
    }
  }

  /* --- Page --- */
  body{
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
    color: var(--text);
    line-height: 1.6;
    min-height: 100vh;
    padding: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    background:
      radial-gradient(1200px 600px at 10% -10%, rgba(79,70,229,.14), transparent 60%),
      radial-gradient(800px 500px at 90% 10%, rgba(6,182,212,.16), transparent 55%),
      linear-gradient(180deg, var(--bg), var(--bg));
  }

  .container{
    width: 100%;
    max-width: 960px;
    background: linear-gradient(0deg, rgba(255,255,255,.6), rgba(255,255,255,.6)) , var(--card);
    backdrop-filter: saturate(120%) blur(6px);
    border: 1px solid var(--border);
    border-radius: var(--r-xl);
    box-shadow: var(--shadow-lg);
    overflow: hidden;
    animation: slideIn .4s ease-out both;
  }

  @keyframes slideIn{ from{ opacity:0; transform: translateY(18px);} to{ opacity:1; transform: translateY(0);} }

  /* --- Header --- */
  .header{
    padding: 40px 32px;
    color: #fff;
    background:
      radial-gradient(800px 200px at 20% -20%, rgba(56,189,248,.35), transparent 60%),
      linear-gradient(135deg, var(--primary), var(--secondary));
  }
  .header h1{
    font-size: clamp(1.8rem, 2.6vw, 2.6rem);
    font-weight: 700;
    letter-spacing: -0.02em;
    margin-bottom: 8px;
  }
  .header .subtitle{
    font-size: 1.05rem;
    opacity: .95;
  }

  /* --- Form container --- */
  form{ padding: 32px; }
  
  .checkbox-statement {
    margin: 20px 0;
    padding: 16px;
    background: color-mix(in oklab, var(--primary) 8%, var(--card));
    border-left: 4px solid var(--primary);
    border-radius: 12px;
    box-shadow: var(--shadow);
  }
  .checkbox-statement label {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    font-size: .95rem;
    color: var(--text-soft);
  }
  .checkbox-statement input[type="checkbox"] {
    width: 18px;
    height: 18px;
    margin-top: 3px;
    cursor: pointer;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 18px;
    margin-bottom: 16px;
  }

  .form-group {
    margin-bottom: 16px;
  }

  label {
    display: block;
    margin-bottom: 8px;
    font-size: .95rem;
    font-weight: 600;
    color: var(--text-soft);
  }

  input[type="text"],
  input[type="email"],
  input[type="tel"],
  input[type="date"],
  textarea {
    width: 100%;
    appearance: none;
    background: var(--card);
    color: var(--text);
    border: 1.5px solid var(--border);
    border-radius: 12px;
    padding: 12px 14px;
    font-size: 1rem;
    transition: border-color var(--t-fast), box-shadow var(--t-fast), transform var(--t-fast);
  }

  input:hover, textarea:hover{
    border-color: color-mix(in oklab, var(--primary) 25%, var(--border));
  }

  input:focus, textarea:focus{
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 4px var(--ring);
  }

  textarea {
    resize: vertical;
    min-height: 110px;
  }

  .section-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text);
    margin: 28px 0 16px 0;
    padding-bottom: 8px;
    border-bottom: 2px solid var(--border);
  }

  .add-btn {
    display: inline-flex;
    align-items: center;
    padding: 10px 18px;
    background: linear-gradient(180deg, #ffffff, #fafafa);
    border: 1.5px solid color-mix(in oklab, var(--primary) 22%, var(--border));
    border-radius: 12px;
    font-size: .95rem;
    font-weight: 700;
    color: var(--primary);
    cursor: pointer;
    margin-top: 10px;
    transition: transform var(--t-fast), box-shadow var(--t-fast);
  }

  .add-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
  }

  .checkbox-group {
    margin: 14px 0;
  }

  .checkbox-group label {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    font-weight: normal;
    font-size: .95rem;
    color: var(--text-soft);
    cursor: pointer;
  }

  .checkbox-group input[type="checkbox"] {
    width: 18px;
    height: 18px;
    margin-top: 3px;
    cursor: pointer;
  }

  .consent-section {
    margin-top: 32px;
    padding-top: 24px;
    border-top: 2px solid var(--border);
  }

  .consent-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 16px;
  }

  /* --- Responsive --- */
  @media (max-width: 768px){
    .form-row{ grid-template-columns: 1fr; }
    .header{ padding: 28px 22px; }
    form{ padding: 22px; }
  }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Still Waters Counseling</h1>
      <p class="subtitle">Schedule Your Intake Appointment</p>
    </div>

    <form>
      <!-- Parent/Guardian Checkbox -->
      <div class="checkbox-statement">
        <label>
          <input type="checkbox" required>
          <span>I am the <strong>parent or guardian of an individual(s) making an appointment with a physician</strong> and confirm that I am over the age of 18.</span>
        </label>
      </div>

      <!-- Parent/Guardian Information -->
      <div class="form-row">
        <div class="form-group">
          <label>First Name (Parent or Guardian)</label>
          <input type="text" required>
        </div>
        <div class="form-group">
          <label>Last Name (Parent or Guardian)</label>
          <input type="text" required>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Email Address</label>
          <input type="email" required>
        </div>
        <div class="form-group">
          <label>Phone Number</label>
          <input type="tel" required>
        </div>
      </div>

      <!-- Individual Seeking Services -->
      <div class="section-title">Individual(s) seeking an appointment with a physician:</div>

      <div class="form-row">
        <div class="form-group">
          <label>First Name (Individual Seeking Services)</label>
          <input type="text" required>
        </div>
        <div class="form-group">
          <label>Last Name (Individual Seeking Services)</label>
          <input type="text" required>
        </div>
      </div>

      <div class="form-group">
        <label>Birth Date</label>
        <input type="date" required style="max-width: 300px;">
      </div>

      <button type="button" class="add-btn">+ Add additional individuals</button>

      <!-- Location Selection -->
      <div class="section-title">Which location do you wish to have your appointment(s)?</div>
      
      <div class="checkbox-group">
        <label>
          <input type="checkbox" name="location">
          <span>3711 Executive Center Dr. Augusta, GA 30907</span>
        </label>
      </div>

      <div class="checkbox-group">
        <label>
          <input type="checkbox" name="location">
          <span>640 Plum Street Suites 202 and 203 Macon, GA 30201</span>
        </label>
      </div>

      <div class="checkbox-group">
        <label>
          <input type="checkbox" name="location">
          <span>I will require a telehealth appointment due to location.</span>
        </label>
      </div>

      <!-- First Time or Follow-up -->
      <div class="section-title">Is this your first time seeing a physician at Still Waters Professional Counseling?</div>

      <div class="checkbox-group">
        <label>
          <input type="checkbox" name="visitType">
          <span>Yes, first-time (60 minutes)</span>
        </label>
      </div>

      <div class="checkbox-group">
        <label>
          <input type="checkbox" name="visitType">
          <span>No, follow-up (30 minutes)</span>
        </label>
      </div>

      <!-- Appointment Times -->
      <div class="section-title">Select Appointment Times</div>
      <div class="form-group">
        <input type="text" placeholder="Select appointment times">
      </div>

      <!-- Additional Fields -->
      <div class="form-row">
        <div class="form-group">
          <label>Alternate availability options</label>
          <textarea></textarea>
        </div>
        <div class="form-group">
          <label>Additional Notes (optional)</label>
          <textarea></textarea>
        </div>
      </div>

      <!-- Consent Section -->
      <div class="consent-section">
        <div class="consent-title">Consent & Acknowledgements</div>
        
        <div class="checkbox-group">
          <label>
            <input type="checkbox" required>
            <span>I consent to receive appointment reminders via text and email.</span>
          </label>
        </div>

        <div class="checkbox-group">
          <label>
            <input type="checkbox" required>
            <span>I confirm that I am not currently experiencing a medical or mental health emergency.</span>
          </label>
        </div>
      </div>
    </form>
  </div>


 <script>
   // ===== CONFIG =====
var CONFIG = {
  GET_SLOTS_URL: 'https://sw-function-b6c4h9cnexhbh4g3.canadacentral-01.azurewebsites.net/api/Calender',
  BOOK_APPOINTMENT_URL: 'https://sw-function-b6c4h9cnexhbh4g3.canadacentral-01.azurewebsites.net/api/CreateEvent',
  GET_SLOTS_KEY: '',
  BOOK_APPOINTMENT_KEY: '',
  TIMEZONE: 'Central Standard Time',
  SLOT_MINUTES: 20,
  SIBLING_BLOCK_MINUTES: 180
};

// Global variables
var selectedSlot = null;
var availableSlots = [];
var clientCounter = 1;

// Utility functions
function withKey(url, key) {
  if (!key) return url;
  try { 
    var u = new URL(url); 
    u.searchParams.set('code', key); 
    return u.toString(); 
  }
  catch(e) { 
    var sep = url.indexOf('?')>=0 ? '&' : '?'; 
    return url + sep + 'code=' + encodeURIComponent(key); 
  }
}

function p2(n){return (n<10?'0':'')+n;}

function generateUUID(){ 
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){ 
    var r=Math.random()*16|0, v=c==='x'?r:(r&0x3)|0x8; 
    return v.toString(16).toUpperCase(); 
  }); 
}

function convertTo24Hour(timeStr){
  var t=timeStr.trim().split(' ');
  var hm=t[0].split(':'), h=parseInt(hm[0],10), m=parseInt(hm[1],10), p=t[1];
  if(p==='PM'&&h!==12)h+=12;
  if(p==='AM'&&h===12)h=0;
  return {hours:h, minutes:m};
}

function hmToMinutes(h,m){ return h*60+m; }
function minutesToHM(total){ return {hour: Math.floor(total/60), minute: total%60}; }

function addMinutesToHM(h, m, delta){
  var total = h*60 + m + delta;
  return { hour: Math.floor(total/60), minute: total%60 };
}

function t12fmt(h, m){
  var ap=h>=12?'PM':'AM';
  var hh=h%12===0?12:(h%12);
  return hh + ':' + p2(m) + ' ' + ap;
}

function ymdhms(y,m,d,h,mi){ 
  return y+'-'+p2(m)+'-'+p2(d)+'T'+p2(h)+':'+p2(mi)+':00'; 
}

function localDow(y,m,d){
  var days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  return days[new Date(y, m-1, d).getDay()];
}

// Add additional individual functionality
function addClientRow() {
  clientCounter++;
  var form = document.querySelector('form');
  var addBtn = document.querySelector('.add-btn');
  
  var clientDiv = document.createElement('div');
  clientDiv.className = 'client-entry';
  clientDiv.innerHTML = `
    <div class="section-title">Additional Individual</div>
    <div class="form-row">
      <div class="form-group">
        <label>First Name (Individual Seeking Services)</label>
        <input type="text" name="additionalFirstName[]" required>
      </div>
      <div class="form-group">
        <label>Last Name (Individual Seeking Services)</label>
        <input type="text" name="additionalLastName[]" required>
      </div>
    </div>
    <div class="form-group">
      <label>Birth Date</label>
      <input type="date" name="additionalBirthDate[]" required style="max-width: 300px;">
    </div>
    <button type="button" class="remove-btn" onclick="this.parentElement.remove()">Remove Individual</button>
  `;
  
  form.insertBefore(clientDiv, addBtn.parentElement);
}

// Collect all client data
function collectClientsPayload() {
  var clients = [];
  
  // Main client
  var mainInputs = document.querySelectorAll('input[type="text"], input[type="date"]');
  var mainFirstName = mainInputs[2]?.value.trim(); // Third input (first individual first name)
  var mainLastName = mainInputs[3]?.value.trim();  // Fourth input (first individual last name)
  var mainBirthDate = mainInputs[4]?.value;        // Fifth input (birth date)
  
  if (mainFirstName && mainLastName && mainBirthDate) {
    clients.push({
      firstName: mainFirstName,
      lastName: mainLastName,
      birthDate: mainBirthDate,
      isMain: true
    });
  }

  // Additional clients
  document.querySelectorAll('.client-entry').forEach(entry => {
    var firstName = entry.querySelector('[name="additionalFirstName[]"]')?.value.trim();
    var lastName = entry.querySelector('[name="additionalLastName[]"]')?.value.trim();
    var birthDate = entry.querySelector('[name="additionalBirthDate[]"]')?.value;
    
    if (firstName && lastName && birthDate) {
      clients.push({
        firstName: firstName,
        lastName: lastName,
        birthDate: birthDate,
        isMain: false
      });
    }
  });

  return clients;
}

function isMultipleClients() {
  return clientCounter > 1;
}

// Parse slot string from API
function parseSlotString(slotStr){
  var parts = slotStr.split(', ');
  if (parts.length < 2) {
    throw new Error('Unexpected slot format: ' + slotStr);
  }

  var datePart = parts[0];
  var timePart = parts[1];

  var [dayStr, monStr, yearStr] = datePart.split(' ');
  var day = parseInt(dayStr, 10);
  var year = parseInt(yearStr, 10);

  var monthMap = {Jan:1,Feb:2,Mar:3,Apr:4,May:5,Jun:6,Jul:7,Aug:8,Sep:9,Oct:10,Nov:11,Dec:12};
  var monthNum = monthMap[monStr];
  if (!monthNum) {
    throw new Error('Unknown month in slot: ' + slotStr);
  }

  var [startStr, endStr] = timePart.split(' - ');
  var start24 = convertTo24Hour(startStr);
  var end24 = convertTo24Hour(endStr);

  var startMin = hmToMinutes(start24.hours, start24.minutes);
  var endMin = hmToMinutes(end24.hours, end24.minutes);

  return {
    y: year, m: monthNum, d: day,
    dateStr: datePart,
    startTimeStr: startStr,
    endTimeStr: endStr,
    startMin: startMin,
    endMin: endMin,
    dateKey: `${year}-${p2(monthNum)}-${p2(day)}`
  };
}

function groupByDate(slots){
  var map = {};
  slots.forEach(s => {
    var key = s.dateKey;
    if (!map[key]) {
      map[key] = { y: s.y, m: s.m, d: s.d, dateStr: s.dateStr, windows: [] };
    }
    map[key].windows.push({
      startMin: s.startMin,
      endMin: s.endMin,
      startStr: s.startTimeStr,
      endStr: s.endTimeStr
    });
  });
  return map;
}

function windowsToText(windows){
  return windows.map(w => {
    var s = minutesToHM(w.startMin), e = minutesToHM(w.endMin);
    return t12fmt(s.hour, s.minute) + ' - ' + t12fmt(e.hour, e.minute);
  }).join(', ');
}

// Load available slots
async function loadAvailableSlots(){
  showLoading(true, 'Loading available times…');
  var url = withKey(CONFIG.GET_SLOTS_URL, CONFIG.GET_SLOTS_KEY);
  try{
    var resp = await fetch(url, { method:'GET', headers:{'Accept':'application/json'} });
    var text = await resp.text();
    console.log('[GET /Calender]', resp.status, text);
    if(!resp.ok) throw new Error('Failed to load slots ('+resp.status+')');
    var data = text? JSON.parse(text):{};
    var list = Array.isArray(data)? data
              : (Array.isArray(data.free_slots)? data.free_slots
              : (Array.isArray(data.freeSlots)? data.freeSlots
              : (Array.isArray(data.slots)? data.slots : [])));
    availableSlots = list.map(parseSlotString);
    
    displaySlots(availableSlots);
  }catch(e){
    console.error(e);
    showError('Failed to load available appointment times. Please try again.');
  }
  finally{ 
    showLoading(false);
  }
}

// Display slots in the UI
function displaySlots(slots){
  var container = document.getElementById('timeSlots');
  if (!container) {
    // Create container if it doesn't exist
    container = document.createElement('div');
    container.id = 'timeSlots';
    document.querySelector('form').appendChild(container);
  }
  container.innerHTML = '';

  selectedSlot = null;

  if (!slots || !slots.length){
    container.innerHTML = '<p>No available slots returned by the server. Please check back later.</p>';
    return;
  }

  if (typeof slots[0] === 'string' || !('startMin' in slots[0])) {
    try { slots = slots.map(parseSlotString); }
    catch (e) { console.error(e); container.innerHTML = '<p>Could not parse slots from server.</p>'; return; }
  }

  var byDate = groupByDate(slots);
  var keys = Object.keys(byDate).sort();

  if (!keys.length){
    container.innerHTML = '<p>No available windows returned by the server.</p>';
    return;
  }

  keys.forEach(key => {
    var dayData = byDate[key];

    var card = document.createElement('div');
    card.className = 'time-slot';

    var header = document.createElement('div');
    header.className = 'date';
    header.textContent = localDow(dayData.y, dayData.m, dayData.d) + ' ' + dayData.dateStr;

    var sub = document.createElement('div');
    sub.className = 'range';
    sub.textContent = 'Available: ' + windowsToText(dayData.windows);

    var grid = document.createElement('div');
    grid.className = 'slot-grid';
    grid.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-top: 12px;';

    var emittedStarts = new Set();

    dayData.windows.forEach(w => {
      for (var m = w.startMin; m + CONFIG.SLOT_MINUTES <= w.endMin; m += CONFIG.SLOT_MINUTES) {
        if (emittedStarts.has(m)) continue;
        emittedStarts.add(m);

        var startHM = minutesToHM(m);
        var endHM   = minutesToHM(m + CONFIG.SLOT_MINUTES);

        var chipEl = document.createElement('div');
        chipEl.className = 'slot-chip';
        chipEl.style.cssText = 'padding: 10px 12px; text-align: center; border-radius: 9999px; background: linear-gradient(180deg, #ffffff, #fafafa); color: var(--text); border: 1.5px solid var(--border); font-weight: 600; font-size: .95rem; cursor: pointer; transition: all 0.15s ease;';
        chipEl.setAttribute('role','button');
        chipEl.setAttribute('tabindex','0');
        chipEl.textContent = t12fmt(startHM.hour, startHM.minute) + '–' + t12fmt(endHM.hour, endHM.minute);

        chipEl.addEventListener('click', () => {
          document.querySelectorAll('.slot-chip').forEach(el => {
            el.style.background = 'linear-gradient(180deg, #ffffff, #fafafa)';
            el.style.color = 'var(--text)';
            el.style.borderColor = 'var(--border)';
          });
          
          chipEl.style.background = 'linear-gradient(135deg, var(--primary), var(--secondary))';
          chipEl.style.color = '#fff';
          chipEl.style.borderColor = 'transparent';
          chipEl.style.boxShadow = '0 8px 26px rgba(79,70,229,.35)';

          selectedSlot = {
            y: dayData.y, m: dayData.m, d: dayData.d,
            dateStr: dayData.dateStr,
            start: { hour: startHM.hour, minute: startHM.minute },
            durationMinutes: CONFIG.SLOT_MINUTES,
            display: chipEl.textContent
          };
        });

        chipEl.addEventListener('keydown', (ev) => {
          if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); chipEl.click(); }
        });

        grid.appendChild(chipEl);
      }
    });

    if (grid.children.length === 0) {
      var emptyMsg = document.createElement('div');
      emptyMsg.style.color = 'var(--muted)';
      emptyMsg.textContent = "No start times within today's windows.";
      grid.appendChild(emptyMsg);
    }

    card.appendChild(header);
    card.appendChild(sub);
    card.appendChild(grid);
    container.appendChild(card);
  });
}

function humanTimeDisplayYMD(y,m,d,start,end){
  var mons=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  function t12fmt(h,mn){
    var ap=h>=12?'pm':'am';
    var hh=h%12===0?12:h%12;
    return hh+(mn?':'+p2(mn):'')+ap;
  }
  return d+' '+mons[m-1]+' '+y+', '+t12fmt(start.hour,start.minute)+'–'+t12fmt(end.hour,end.minute);
}

// Form validation
function validateForm(){
  hideMessages();

  // Parent/Guardian checkbox validation
  var guardianCheckbox = document.querySelector('.checkbox-statement input[type="checkbox"]');
  if(!guardianCheckbox || !guardianCheckbox.checked){
    showError('Please confirm you are the parent or guardian.');
    return false;
  }

  // Parent/Guardian information validation
  var inputs = document.querySelectorAll('input[type="text"], input[type="email"], input[type="tel"]');
  var guardianFirstName = inputs[0]?.value.trim();
  var guardianLastName = inputs[1]?.value.trim();
  var guardianEmail = inputs[2]?.value.trim();
  var guardianPhone = inputs[3]?.value.trim();

  if(!guardianFirstName || !guardianLastName) {
    showError('Please enter parent/guardian first and last name');
    return false;
  }

  if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(guardianEmail)){
    showError('Please enter a valid email address');
    return false;
  }

  if(!guardianPhone || guardianPhone.replace(/\D/g,'').length < 7){
    showError('Please enter a valid phone number');
    return false;
  }

  // Client validation
  var clients = collectClientsPayload();
  if (clients.length === 0) {
    showError('Please enter information for at least one individual seeking services');
    return false;
  }

  // Location validation
  var locationCheckboxes = document.querySelectorAll('input[name="location"]:checked');
  if(locationCheckboxes.length === 0){ 
    showError('Please select a location'); 
    return false; 
  }

  // Visit type validation
  var visitTypeCheckboxes = document.querySelectorAll('input[name="visitType"]:checked');
  if(visitTypeCheckboxes.length === 0){ 
    showError('Please select whether this is a first-time or follow-up appointment'); 
    return false; 
  }

  // Appointment time validation
  if(!selectedSlot){
    showError('Please choose an appointment time');
    return false;
  }

  // Consent validation
  var consentCheckboxes = document.querySelectorAll('.consent-section input[type="checkbox"]');
  if(consentCheckboxes.length < 2 || !consentCheckboxes[0].checked || !consentCheckboxes[1].checked){
    showError('Please agree to all consent statements');
    return false;
  }

  return true;
}

// Show confirmation
function showConfirmation(opts){
  var card = document.getElementById('confirmationCard');
  if (!card) {
    card = document.createElement('div');
    card.id = 'confirmationCard';
    card.className = 'confirm-card';
    card.style.cssText = 'background: color-mix(in oklab, var(--success) 10%, #fff); border: 1.5px solid color-mix(in oklab, var(--success) 30%, #fff); border-radius: 16px; padding: 18px; box-shadow: var(--shadow); margin: 16px 0; display: none;';
    
    card.innerHTML = `
      <h3 style="font-size:1.15rem; font-weight:800; margin-bottom:8px; color:#065f46;">Appointment Confirmed</h3>
      <div class="confirm-row" style="display:flex; gap:10px; align-items:flex-start; margin:6px 0; color:#064e3b;">
        <b style="min-width:130px; display:inline-block; color:#065f46;">When:</b> 
        <span id="confWhen">—</span>
      </div>
      <div class="confirm-row" style="display:flex; gap:10px; align-items:flex-start; margin:6px 0; color:#064e3b;">
        <b style="min-width:130px; display:inline-block; color:#065f46;">Where:</b> 
        <span id="confLocation">—</span>
      </div>
      <div class="confirm-notice" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid color-mix(in oklab, var(--success) 20%, #fff); font-size: .95rem; color: var(--text-soft);">
        You'll receive a confirmation email shortly. Please check in at the front desk when you arrive.
      </div>
    `;
    
    document.querySelector('form').appendChild(card);
  }

  document.getElementById('confWhen').textContent = opts.whenText || '—';
  document.getElementById('confLocation').textContent = opts.locationText || '—';

  card.style.display = 'block';
  card.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function friendlyWhenFromSelected(){
  var st = { hour: selectedSlot.start.hour, minute: selectedSlot.start.minute };
  var endHM = addMinutesToHM(st.hour, st.minute, selectedSlot.durationMinutes);
  return humanTimeDisplayYMD(selectedSlot.y, selectedSlot.m, selectedSlot.d, st, endHM);
}

function getLocationText() {
  var locationCheckboxes = document.querySelectorAll('input[name="location"]:checked');
  if (locationCheckboxes.length === 0) return 'Unknown location';
  
  var locationTexts = Array.from(locationCheckboxes).map(cb => {
    var span = cb.closest('label').querySelector('span');
    return span ? span.textContent : 'Unknown location';
  });
  
  return locationTexts.join(', ');
}

function getVisitTypeText() {
  var visitTypeCheckboxes = document.querySelectorAll('input[name="visitType"]:checked');
  if (visitTypeCheckboxes.length === 0) return 'Unknown type';
  
  var typeTexts = Array.from(visitTypeCheckboxes).map(cb => {
    var span = cb.closest('label').querySelector('span');
    return span ? span.textContent : 'Unknown type';
  });
  
  return typeTexts.join(', ');
}

// Main submit handler
async function handleSubmit(e){
  e.preventDefault();
  if(!validateForm()) return;

  showLoading(true, 'Submitting your booking…');

  try{
    var inputs = document.querySelectorAll('input[type="text"], input[type="email"], input[type="tel"]');
    var guardianFirstName = inputs[0]?.value.trim();
    var guardianLastName = inputs[1]?.value.trim();
    var guardianEmail = inputs[2]?.value.trim();
    var guardianPhone = inputs[3]?.value.trim();

    var clients = collectClientsPayload();
    var locationText = getLocationText();
    var visitTypeText = getVisitTypeText();
    var textareas = document.querySelectorAll('textarea');
    var alternateAvailability = textareas[0]?.value.trim();
    var additionalNotes = textareas[1]?.value.trim();

    var st = { hour: selectedSlot.start.hour, minute: selectedSlot.start.minute };
    var duration = selectedSlot.durationMinutes;
    var endHM = addMinutesToHM(st.hour, st.minute, duration);

    var startDT = ymdhms(selectedSlot.y, selectedSlot.m, selectedSlot.d, st.hour, st.minute);
    var endDT   = ymdhms(selectedSlot.y, selectedSlot.m, selectedSlot.d, endHM.hour, endHM.minute);

    var isTelehealth = locationText.includes('Telehealth');
    var isFirstTime = visitTypeText.includes('first-time');

    var subjectBase = 'Physician Appointment - ' + (isFirstTime ? 'First-Time' : 'Follow-Up');
    if (isMultipleClients()) subjectBase += ' (Multiple individuals)';

    // Build body content
    var body = 'Parent/Guardian: ' + guardianFirstName + ' ' + guardianLastName;
    body += ' (Email: ' + guardianEmail + ', Phone: ' + guardianPhone + ').\n\n';
    
    body += 'Individuals seeking services:\n';
    clients.forEach((client, index) => {
      body += '- ' + client.firstName + ' ' + client.lastName;
      body += ' (Birth Date: ' + client.birthDate + ')';
      if (client.isMain) body += ' [Main Client]';
      body += '\n';
    });

    body += '\nAppointment details:\n';
    body += '- Type: ' + visitTypeText + '\n';
    body += '- Location: ' + locationText + '\n';
    body += '- Date & Time: ' + humanTimeDisplayYMD(selectedSlot.y, selectedSlot.m, selectedSlot.d, st, endHM);

    if(alternateAvailability) body += '\n\nAlternate availability: ' + alternateAvailability;
    if(additionalNotes) body += '\n\nAdditional notes: ' + additionalNotes;

    var payload = {
      subject: subjectBase,
      body: body,
      start: { dateTime: startDT, timeZone: CONFIG.TIMEZONE },
      end: { dateTime: endDT, timeZone: CONFIG.TIMEZONE },
      expectedDate: selectedSlot.y + '-' + p2(selectedSlot.m) + '-' + p2(selectedSlot.d),
      location: { displayName: locationText },
      attendees: [
        { 
          address: guardianEmail, 
          name: guardianFirstName + ' ' + guardianLastName, 
          type: 'required' 
        }
      ],
      allowNewTimeProposals: true,
      transactionId: generateUUID(),
      guardian: {
        firstName: guardianFirstName,
        lastName: guardianLastName,
        email: guardianEmail,
        phone: guardianPhone
      },
      clients: clients,
      appointmentType: visitTypeText,
      locationType: locationText,
      isMultipleClients: isMultipleClients()
    };

    console.log('[BOOK payload]', payload);

    var url = withKey(CONFIG.BOOK_APPOINTMENT_URL, CONFIG.BOOK_APPOINTMENT_KEY);
    var resp = await fetch(url, { 
      method: 'POST', 
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      }, 
      body: JSON.stringify(payload) 
    });

    if(!resp.ok){
      var t=''; try{ t=await resp.text(); }catch(_){}
      throw new Error('Failed to book ('+resp.status+') '+t);
    }

    var result = await resp.json();

    // Success
    showSuccess();
    showConfirmation({
      whenText: friendlyWhenFromSelected(),
      locationText: locationText
    });

  } catch(err) {
    console.error(err);
    showError('There was an error booking your appointment. Please try again or call us directly.');
  } finally {
    showLoading(false);
  }
}

// UI helper functions
function showLoading(show, message) {
  var overlay = document.getElementById('loadingOverlay');
  if (!overlay) {
    overlay = document.createElement('div');
    overlay.id = 'loadingOverlay';
    overlay.style.cssText = 'position: fixed; inset:0; background: rgba(2,6,23,.5); display:none; place-items:center; z-index: 9999;';
    overlay.innerHTML = `
      <div class="loading-content" style="background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 24px; text-align:center; box-shadow: var(--shadow-lg); color: var(--text);">
        <div class="spinner" style="width: 52px; height:52px; border: 5px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 14px;"></div>
        <p id="overlayMessage">Processing your request...</p>
      </div>
    `;
    document.body.appendChild(overlay);
    
    // Add spinner animation
    var style = document.createElement('style');
    style.textContent = '@keyframes spin{ to{ transform: rotate(360deg); } }';
    document.head.appendChild(style);
  }
  
  if (message) {
    document.getElementById('overlayMessage').textContent = message;
  }
  
  overlay.style.display = show ? 'grid' : 'none';
}

function showSuccess(){ 
  hideMessages(); 
  showMessage('success', 'Appointment booked! You\'ll receive a confirmation shortly.'); 
}

function showError(msg){ 
  hideMessages(); 
  showMessage('error', msg); 
}

function showMessage(type, msg) {
  var messageDiv = document.getElementById(type + 'Message');
  if (!messageDiv) {
    messageDiv = document.createElement('div');
    messageDiv.id = type + 'Message';
    messageDiv.className = type + '-message';
    messageDiv.style.cssText = type === 'success' ? 
      'display:none; border-radius: 12px; padding: 14px 16px; font-weight: 700; margin: 14px 0; box-shadow: var(--shadow); background: color-mix(in oklab, var(--success) 18%, #ecfdf5); color: #065f46; border: 1.5px solid color-mix(in oklab, var(--success) 40%, #ffffff);' :
      'display:none; border-radius: 12px; padding: 14px 16px; font-weight: 700; margin: 14px 0; box-shadow: var(--shadow); background: color-mix(in oklab, var(--danger) 18%, #fef2f2); color: #7f1d1d; border: 1.5px solid color-mix(in oklab, var(--danger) 40%, #ffffff);';
    
    document.querySelector('form').insertBefore(messageDiv, document.querySelector('.checkbox-statement'));
  }
  
  messageDiv.textContent = msg;
  messageDiv.style.display = 'block';
  setTimeout(function(){ messageDiv.style.display = 'none'; }, type === 'success' ? 5000 : 6000);
}

function hideMessages(){ 
  var success = document.getElementById('successMessage');
  var error = document.getElementById('errorMessage');
  if (success) success.style.display = 'none';
  if (error) error.style.display = 'none';
}

// Initialize on DOM load
document.addEventListener('DOMContentLoaded', function () {
  // Add client button
  document.querySelector('.add-btn').addEventListener('click', addClientRow);

  // Form submission
  document.querySelector('form').addEventListener('submit', handleSubmit);

  // Phone number formatting
  var phoneInput = document.querySelector('input[type="tel"]');
  if (phoneInput) {
    phoneInput.addEventListener('input', function (e) {
      var v = e.target.value.replace(/\D/g,'').slice(0,10);
      if (v.length>6) e.target.value = v.slice(0,3)+'-'+v.slice(3,6)+'-'+v.slice(6);
      else if (v.length>3) e.target.value = v.slice(0,3)+'-'+v.slice(3);
      else e.target.value = v;
    });
  }

  // Load slots when visit type is selected
  document.querySelectorAll('input[name="visitType"]').forEach(function(checkbox){
    checkbox.addEventListener('change', function() {
      if (this.checked) {
        loadAvailableSlots();
      }
    });
  });
});
  </script>
</body>
</html>
