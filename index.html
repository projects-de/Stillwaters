<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Still Waters Counseling - Book Your Appointment</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --primary-color: #2c5282;
      --secondary-color: #4299e1;
      --accent-color: #63b3ed;
      --success-color: #48bb78;
      --danger-color: #f56565;
      --light-bg: #f7fafc;
      --white: #ffffff;
      --gray-light: #e2e8f0;
      --gray-medium: #718096;
      --gray-dark: #2d3748;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      line-height: 1.6;
    }

    .container {
      background: var(--white);
      border-radius: 20px;
      box-shadow: var(--shadow-lg);
      max-width: 900px;
      width: 100%;
      overflow: hidden;
      animation: slideIn 0.5s ease-out;
    }

    @keyframes slideIn { from { opacity: 0; transform: translateY(30px);} to { opacity: 1; transform: translateY(0);} }

    .header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: var(--white);
      padding: 40px 30px;
      text-align: center;
    }
    .header h1 { font-size: 2.5rem; margin-bottom: 10px; font-weight: 300; letter-spacing: -1px; }
    .header p { font-size: 1.1rem; opacity: 0.95; }

    .emergency-notice {
      background: var(--danger-color);
      color: var(--white);
      padding: 15px 30px;
      text-align: center;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    .emergency-notice svg { width: 24px; height: 24px; fill: currentColor; }

    .form-container { padding: 40px 30px; }
    .form-section { margin-bottom: 35px; animation: fadeIn 0.5s ease-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .form-section h2 {
      color: var(--gray-dark);
      font-size: 1.5rem;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--gray-light);
      font-weight: 600;
    }

    .form-group { margin-bottom: 20px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

    label { display: block; color: var(--gray-dark); font-weight: 500; margin-bottom: 8px; font-size: 0.95rem; }
    .required { color: var(--danger-color); }

    input[type="text"],
    input[type="email"],
    input[type="tel"],
    input[type="date"],
    input[type="time"],
    select,
    textarea {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid var(--gray-light);
      border-radius: 10px;
      font-size: 1rem;
      transition: all 0.3s ease;
      background: var(--white);
    }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--secondary-color); box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1); }
    textarea { resize: vertical; min-height: 100px; }

    .radio-group { display: flex; gap: 30px; margin-top: 10px; }
    .radio-option { display: flex; align-items: center; cursor: pointer; padding: 15px 25px; border: 2px solid var(--gray-light); border-radius: 10px; transition: all 0.3s ease; flex: 1; background: var(--white); }
    .radio-option:hover { border-color: var(--secondary-color); background: var(--light-bg); }
    .radio-option input[type="radio"] { margin-right: 10px; width: 20px; height: 20px; cursor: pointer; }
    .radio-option.selected { border-color: var(--secondary-color); background: linear-gradient(135deg, rgba(66, 153, 225, 0.1), rgba(99, 179, 237, 0.1)); }

    .checkbox-group { display: flex; align-items: flex-start; margin: 20px 0; }
    .checkbox-group input[type="checkbox"] { margin-right: 10px; margin-top: 5px; width: 20px; height: 20px; cursor: pointer; }
    .checkbox-group label { cursor: pointer; margin-bottom: 0; flex: 1; }

    .time-slots { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-top: 15px; }
    .time-slot { padding: 15px; border: 2px solid var(--gray-light); border-radius: 10px; cursor: pointer; transition: all 0.3s ease; background: var(--white); }
    .time-slot:hover { border-color: var(--secondary-color); transform: translateY(-2px); box-shadow: var(--shadow); }
    .time-slot.selected { background: var(--secondary-color); color: var(--white); border-color: var(--secondary-color); }
    .time-slot .date { font-weight: 600; font-size: 1rem; margin-bottom: 5px; }
    .time-slot .time { font-size: 0.9rem; opacity: 0.9; }

    .hidden { display: none !important; }

    .button-group { display: flex; gap: 15px; margin-top: 40px; justify-content: center; }
    .btn { padding: 15px 40px; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px; }
    .btn-primary { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: var(--white); box-shadow: 0 4px 15px rgba(66, 153, 225, 0.3); }
    .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(66, 153, 225, 0.4); }
    .btn-secondary { background: var(--white); color: var(--primary-color); border: 2px solid var(--primary-color); }
    .btn-secondary:hover { background: var(--light-bg); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .loading-spinner { width: 20px; height: 20px; border: 3px solid var(--white); border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; margin-left: 10px; display: inline-block; vertical-align: middle; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .success-message { background: var(--success-color); color: var(--white); padding: 20px; border-radius: 10px; text-align: center; margin: 20px 0; display: none; animation: slideDown 0.5s ease-out; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-20px);} to { opacity: 1; transform: translateY(0);} }
    .error-message { background: var(--danger-color); color: var(--white); padding: 15px; border-radius: 10px; text-align: center; margin: 20px 0; display: none; }

    .time-picker { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; padding: 15px; background: var(--light-bg); border-radius: 10px; }
    .time-picker label { font-size: 0.9rem; color: var(--gray-medium); }

    @media (max-width: 768px) {
      .header h1 { font-size: 2rem; }
      .form-row { grid-template-columns: 1fr; }
      .radio-group { flex-direction: column; }
      .time-slots { grid-template-columns: 1fr; }
      .button-group { flex-direction: column; }
      .btn { width: 100%; }
      .time-picker { grid-template-columns: 1fr; }
    }

    .loading-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 9999; }
    .loading-overlay.active { display: flex; }
    .loading-content { background: var(--white); padding: 30px; border-radius: 15px; text-align: center; box-shadow: var(--shadow-lg); }
    .loading-content .spinner { width: 50px; height: 50px; border: 5px solid var(--gray-light); border-top-color: var(--secondary-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Still Waters Counseling</h1>
      <p>Schedule Your Intake Appointment</p>
    </div>

    <div class="emergency-notice">
      <svg viewBox="0 0 24 24"><path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/></svg>
      <span>If you are experiencing an emergency, please dial 911 immediately</span>
    </div>

    <form id="bookingForm" class="form-container" novalidate>
      <!-- Success/Error Messages -->
      <div id="successMessage" class="success-message">Appointment booked successfully! You'll receive a confirmation soon.</div>
      <div id="errorMessage" class="error-message">There was an error booking your appointment. Please try again.</div>

      <!-- Client Information Section -->
      <div class="form-section">
        <h2>Client Information</h2>
        <div class="form-row">
          <div class="form-group">
            <label for="firstName">First Name <span class="required">*</span></label>
            <input type="text" id="firstName" name="firstName" required />
          </div>
          <div class="form-group">
            <label for="lastName">Last Name <span class="required">*</span></label>
            <input type="text" id="lastName" name="lastName" required />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="email">Email Address <span class="required">*</span></label>
            <input type="email" id="email" name="email" required />
          </div>
          <div class="form-group">
            <label for="phone">Phone Number <span class="required">*</span></label>
            <input type="tel" id="phone" name="phone" required placeholder="123-456-7890" />
          </div>
        </div>
      </div>

      <!-- Appointment Type Section -->
      <div class="form-section">
        <h2>Appointment Type</h2>
        <div class="form-group">
          <label>Select your preferred appointment type <span class="required">*</span></label>
          <div class="radio-group">
            <div class="radio-option" data-type="telehealth">
              <input type="radio" id="telehealth" name="appointmentType" value="telehealth" required />
              <label for="telehealth">Telehealth (Video Call)</label>
            </div>
            <div class="radio-option" data-type="inperson">
              <input type="radio" id="inperson" name="appointmentType" value="inperson" required />
              <label for="inperson">In-Person Visit</label>
            </div>
          </div>
        </div>
      </div>

      <!-- In-Person Details Section (Hidden by default) -->
      <div id="inPersonDetails" class="form-section hidden">
        <h2>In-Person Visit Details</h2>
        <div class="form-group">
          <label for="address">Service Address <span class="required">*</span></label>
          <input type="text" id="address" name="address" placeholder="Full street address" />
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="unit">Apartment/Unit Number</label>
            <input type="text" id="unit" name="unit" placeholder="Apt, Suite, Unit #" />
          </div>
          <div class="form-group">
            <label for="parking">Parking Instructions</label>
            <input type="text" id="parking" name="parking" placeholder="Where to park" />
          </div>
        </div>
        <div class="form-group">
          <label for="entryNotes">Gate/Entry Notes</label>
          <textarea id="entryNotes" name="entryNotes" placeholder="Gate codes, building access details, etc."></textarea>
        </div>
        <div class="form-group">
          <label for="safetyConsiderations">Safety Considerations</label>
          <textarea id="safetyConsiderations" name="safetyConsiderations" placeholder="Any safety issues our clinician should know about"></textarea>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="arrivalWindow" name="arrivalWindow" />
          <label for="arrivalWindow">I understand the clinician will arrive within a 10-15 minute window around the start time</label>
        </div>
      </div>

      <!-- Appointment Scheduling Section -->
      <div class="form-section">
        <h2>Select Appointment Time</h2>
        <div class="form-group">
          <button type="button" class="btn btn-secondary" id="loadSlotsBtn">Load Available Times</button>
        </div>
        <div id="timeSlots" class="time-slots"></div>

        <!-- Time Selection for selected day -->
        <div id="timePickerSection" class="form-group hidden">
          <div class="time-picker">
            <div>
              <label for="startTime">Preferred Start Time <span class="required">*</span></label>
              <select id="startTime" name="startTime">
                <option value="">Select start time</option>
              </select>
            </div>
            <div>
              <label for="endTime">Preferred End Time <span class="required">*</span></label>
              <select id="endTime" name="endTime">
                <option value="">Select end time</option>
              </select>
            </div>
          </div>
          <small style="color: var(--gray-medium); margin-top: 10px; display: block;">Select your preferred 2-hour window within the available time slot</small>
        </div>
      </div>

      <!-- Additional Information Section -->
      <div class="form-section">
        <h2>Additional Information</h2>
        <div class="form-group">
          <label for="alternateAvailability">Alternate Availability (Optional)</label>
          <textarea id="alternateAvailability" name="alternateAvailability" placeholder="If the available slots don't work, please describe your availability"></textarea>
        </div>
        <div class="form-group">
          <label for="additionalNotes">Additional Notes (Optional)</label>
          <textarea id="additionalNotes" name="additionalNotes" placeholder="Any other information you'd like us to know"></textarea>
        </div>
      </div>

      <!-- Consent Section -->
      <div class="form-section">
        <h2>Consent & Acknowledgments</h2>
        <div class="checkbox-group">
          <input type="checkbox" id="consent" name="consent" required />
          <label for="consent">I consent to receive appointment reminders via text and email <span class="required">*</span></label>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="emergency" name="emergency" required />
          <label for="emergency">I confirm that I am not currently experiencing a medical or mental health emergency <span class="required">*</span></label>
        </div>
      </div>

      <!-- Submit Buttons -->
      <div class="button-group">
        <button type="button" class="btn btn-secondary" id="clearFormBtn">Clear Form</button>
        <button type="submit" class="btn btn-primary" id="submitBtn">
          Book Appointment
          <span class="loading-spinner hidden" id="submitSpinner"></span>
        </button>
      </div>
    </form>
  </div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
      <div class="spinner"></div>
      <p>Processing your request...</p>
    </div>
  </div>

  <script>
    // ===============================
    // CONFIGURATION
    // !!! Fill these values and you're good.
    // ===============================
    const CONFIG = {
      // Your Function endpoints (include the route names)
      GET_SLOTS_URL: 'https://sw-function-b6c4h9cnexhbh4g3.canadacentral-01.azurewebsites.net/api/Calender', // NOTE: route is spelled Calender
      BOOK_APPOINTMENT_URL: 'https://sw-function-b6c4h9cnexhbh4g3.canadacentral-01.azurewebsites.net/api/CreateEvent',

      // If your functions are protected with a function key, put it here (optional). Leave as '' if not required.
      GET_SLOTS_KEY: '',
      BOOK_APPOINTMENT_KEY: '',

      // Time zone to send with the request body
      TIMEZONE: 'Pacific Standard Time'
    };

    // Helper: append ?code=KEY if provided
    function withKey(url, key) {
      if (!key) return url;
      try {
        const u = new URL(url);
        u.searchParams.set('code', key);
        return u.toString();
      } catch (e) {
        // If URL constructor fails for some reason, fallback
        const sep = url.includes('?') ? '&' : '?';
        return url + sep + 'code=' + encodeURIComponent(key);
      }
    }

    let selectedSlot = null;
    let selectedDate = null;
    let availableSlots = [];

    // ====== INIT ======
    document.addEventListener('DOMContentLoaded', function () {
      // Wire up listeners (no Node imports, no module syntax)
      document.getElementById('bookingForm').addEventListener('submit', handleSubmit);
      document.getElementById('loadSlotsBtn').addEventListener('click', loadAvailableSlots);
      document.getElementById('clearFormBtn').addEventListener('click', clearForm);

      // Appointment type card click behavior
      document.querySelectorAll('.radio-option').forEach((opt) => {
        opt.addEventListener('click', () => selectAppointmentType(opt.dataset.type));
      });

      // Phone number formatting (US style 3-3-4)
      document.getElementById('phone').addEventListener('input', function (e) {
        let v = e.target.value.replace(/\D/g, '').slice(0, 10);
        const parts = [];
        if (v.length > 0) parts.push(v.slice(0, 3));
        if (v.length >= 4) parts.push(v.slice(3, 6));
        if (v.length >= 7) parts.push(v.slice(6, 10));
        e.target.value = parts.join('-');
      });

      // Start time => auto-calc 2-hr end option
      document.getElementById('startTime').addEventListener('change', updateEndTimeOptions);
    });

    // ====== HELPERS ======
    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
        const r = (Math.random() * 16) | 0;
        const v = c === 'x' ? r : (r & 0x3) | 0x8;
        return v.toString(16).toUpperCase();
      });
    }

    function selectAppointmentType(type) {
      const radio = document.getElementById(type === 'telehealth' ? 'telehealth' : 'inperson');
      if (radio) radio.checked = true;

      document.querySelectorAll('.radio-option').forEach((o) => o.classList.remove('selected'));
      const chosen = document.querySelector(`.radio-option[data-type="${type}"]`);
      if (chosen) chosen.classList.add('selected');

      // Toggle in-person block
      const inPersonDetails = document.getElementById('inPersonDetails');
      if (type === 'inperson') {
        inPersonDetails.classList.remove('hidden');
        document.getElementById('address').required = true;
        document.getElementById('arrivalWindow').required = true;
      } else {
        inPersonDetails.classList.add('hidden');
        document.getElementById('address').required = false;
        document.getElementById('arrivalWindow').required = false;
      }
    }

    // Parse slot string like "05 Sep 2025, 09:00 AM - 02:00 PM"
    function parseSlotString(slotStr) {
      const parts = slotStr.split(', ');
      const datePart = parts[0]; // e.g. "05 Sep 2025"
      const timePart = parts[1]; // e.g. "09:00 AM - 02:00 PM"

      const [dayStr, monthStr, yearStr] = datePart.split(' ');
      const monthMap = { Jan: 0, Feb: 1, Mar: 2, Apr: 3, May: 4, Jun: 5, Jul: 6, Aug: 7, Sep: 8, Oct: 9, Nov: 10, Dec: 11 };

      const [startTimeStr, endTimeStr] = timePart.split(' - ');

      return {
        date: new Date(parseInt(yearStr), monthMap[monthStr], parseInt(dayStr)),
        dateStr: datePart,
        startTimeStr,
        endTimeStr,
        originalString: slotStr,
      };
    }

    // Convert time string like "09:00 AM" to 24-hr numbers
    function convertTo24Hour(timeStr) {
      const [time, period] = timeStr.trim().split(' ');
      let [hours, minutes] = time.split(':').map(Number);
      if (period === 'PM' && hours !== 12) hours += 12;
      if (period === 'AM' && hours === 12) hours = 0;
      return { hours, minutes };
    }

    // Format date to API format: YYYY-MM-DDTHH:mm:00 (no timezone offset)
    function pad2(n) { return String(n).padStart(2, '0'); }
    function formatDateTimeForAPI(date, hours, minutes) {
      const y = date.getFullYear();
      const m = pad2(date.getMonth() + 1);
      const d = pad2(date.getDate());
      const hh = pad2(hours);
      const mm = pad2(minutes);
      return `${y}-${m}-${d}T${hh}:${mm}:00`;
    }

    function humanTimeDisplay(date, start, end) {
      // e.g., "2 Sept 2025, 12–2pm"
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const day = date.getDate();
      const mon = months[date.getMonth()];
      const year = date.getFullYear();

      function to12h(h, m) {
        const period = h >= 12 ? 'pm' : 'am';
        const hh = h % 12 === 0 ? 12 : h % 12;
        const mm = m === 0 ? '' : ':' + pad2(m);
        return `${hh}${mm}${period}`;
      }

      return `${day} ${mon} ${year}, ${to12h(start.hour, start.minute)}–${to12h(end.hour, end.minute)}`;
    }

    // ====== LOAD AVAILABLE SLOTS ======
    async function loadAvailableSlots() {
      const loadingOverlay = document.getElementById('loadingOverlay');
      loadingOverlay.classList.add('active');
      const url = withKey(CONFIG.GET_SLOTS_URL, CONFIG.GET_SLOTS_KEY);

      try {
        const headers = { Accept: 'application/json' };
        // NOTE: we pass the key via the URL (?code=...) to avoid a CORS preflight on GET.
        // Do not send x-functions-key header here.

        const response = await fetch(url, { method: 'GET', headers });
        if (!response.ok) throw new Error(`Failed to load available slots (${response.status})`);

        const data = await response.json();
        const free_slots = Array.isArray(data.free_slots) ? data.free_slots : [];
        availableSlots = free_slots.map(parseSlotString);
        displayAvailableSlots(availableSlots);
      } catch (err) {
        console.error('Error loading slots:', err);
        showError('Failed to load available appointment times. Please try again.');
      } finally {
        loadingOverlay.classList.remove('active');
      }
    }

    function displayAvailableSlots(slots) {
      const container = document.getElementById('timeSlots');
      container.innerHTML = '';

      if (!slots || slots.length === 0) {
        container.innerHTML = '<p>No available slots at this time. Please check back later.</p>';
        return;
      }

      slots.forEach((slot, index) => {
        const el = document.createElement('div');
        el.className = 'time-slot';
        el.dataset.slotIndex = index;
        el.innerHTML = `<div class="date">${slot.dateStr}</div><div class="time">${slot.startTimeStr} - ${slot.endTimeStr}</div>`;
        el.addEventListener('click', () => selectTimeSlot(slot, index));
        container.appendChild(el);
      });
    }

    function generateTimeOptions(startHour, endHour) {
      const options = [];
      for (let hour = startHour; hour <= endHour; hour++) {
        for (let minute = 0; minute < 60; minute += 30) {
          if (hour === endHour && minute > 0) break;
          const displayHour = hour > 12 ? hour - 12 : hour === 0 ? 12 : hour;
          const period = hour >= 12 ? 'PM' : 'AM';
          const timeStr = `${displayHour}:${String(minute).padStart(2, '0')} ${period}`;
          options.push({ display: timeStr, hour, minute });
        }
      }
      return options;
    }

    function selectTimeSlot(slot, index) {
      document.querySelectorAll('.time-slot').forEach((el) => el.classList.remove('selected'));
      const chosen = document.querySelector(`[data-slot-index="${index}"]`);
      if (chosen) chosen.classList.add('selected');

      selectedSlot = slot;
      selectedDate = slot.date;

      const timePickerSection = document.getElementById('timePickerSection');
      timePickerSection.classList.remove('hidden');

      const start = convertTo24Hour(slot.startTimeStr);
      const end = convertTo24Hour(slot.endTimeStr);

      const startTimeSelect = document.getElementById('startTime');
      startTimeSelect.innerHTML = '<option value="">Select start time</option>';

      const lastStartHour = end.hours - 2; // ensure 2-hr window fits
      const opts = generateTimeOptions(start.hours, lastStartHour);
      opts.forEach((o) => {
        const opt = document.createElement('option');
        opt.value = JSON.stringify(o);
        opt.textContent = o.display;
        startTimeSelect.appendChild(opt);
      });

      // Reset endTime
      const endTimeSelect = document.getElementById('endTime');
      endTimeSelect.innerHTML = '<option value="">Select end time</option>';
    }

    function updateEndTimeOptions() {
      const startTimeSelect = document.getElementById('startTime');
      const endTimeSelect = document.getElementById('endTime');
      if (!startTimeSelect.value) {
        endTimeSelect.innerHTML = '<option value="">Select end time</option>';
        return;
      }
      const startTime = JSON.parse(startTimeSelect.value);
      const endHour = startTime.hour + 2;
      const endMinute = startTime.minute;
      const displayHour = endHour > 12 ? endHour - 12 : endHour === 0 ? 12 : endHour;
      const period = endHour >= 12 ? 'PM' : 'AM';
      const endTimeStr = `${displayHour}:${String(endMinute).padStart(2, '0')} ${period}`;

      endTimeSelect.innerHTML = '';
      const opt = document.createElement('option');
      opt.value = JSON.stringify({ hour: endHour, minute: endMinute, display: endTimeStr });
      opt.textContent = endTimeStr;
      opt.selected = true;
      endTimeSelect.appendChild(opt);
    }

    // ====== SUBMIT ======
    async function handleSubmit(e) {
      e.preventDefault();

      if (!validateForm()) return;

      const submitBtn = document.getElementById('submitBtn');
      const spinner = document.getElementById('submitSpinner');
      submitBtn.disabled = true;
      spinner.classList.remove('hidden');

      try {
        const form = new FormData(e.target);
        const firstName = form.get('firstName').trim();
        const lastName = form.get('lastName').trim();
        const email = form.get('email').trim();
        const phone = form.get('phone').trim();
        const appointmentType = form.get('appointmentType');

        const startTimeData = JSON.parse(document.getElementById('startTime').value);
        const endTimeData = JSON.parse(document.getElementById('endTime').value);

        const startDateTime = formatDateTimeForAPI(selectedDate, startTimeData.hour, startTimeData.minute);
        const endDateTime = formatDateTimeForAPI(selectedDate, endTimeData.hour, endTimeData.minute);

        const typeText = appointmentType === 'telehealth' ? 'Telehealth' : 'In-person';

        // Build human-friendly body details
        let body = `Appointment scheduled for ${appointmentType} with ${firstName} on ${humanTimeDisplay(selectedDate, startTimeData, endTimeData)}.`;
        body += ` Contact: ${phone}.`;

        // Include in-person details in the body if applicable
        if (appointmentType === 'inperson') {
          const address = form.get('address');
          const unit = form.get('unit');
          const entryNotes = form.get('entryNotes');
          const parking = form.get('parking');
          const safety = form.get('safetyConsiderations');
          const arrivalWindow = document.getElementById('arrivalWindow').checked ? 'Yes' : 'No';

          body += ` Address: ${address || ''}${unit ? ', ' + unit : ''}.`;
          if (entryNotes) body += ` Entry notes: ${entryNotes}.`;
          if (parking) body += ` Parking: ${parking}.`;
          if (safety) body += ` Safety considerations: ${safety}.`;
          body += ` Arrival window acknowledged: ${arrivalWindow}.`;
        }

        const altAvail = form.get('alternateAvailability');
        const extraNotes = form.get('additionalNotes');
        if (altAvail) body += ` Alternate availability: ${altAvail}.`;
        if (extraNotes) body += ` Additional notes: ${extraNotes}.`;

        const appointmentData = {
          start: startDateTime, // e.g. "2025-09-02T12:00:00"
          end: endDateTime,
          subject: `${typeText} appointment`,
          body: body,
          timeZone: CONFIG.TIMEZONE, // e.g. "Pacific Standard Time"
          location: {
            displayName: appointmentType === 'telehealth' ? 'video' : 'in-person'
          },
          attendees: [
            { address: email, name: `${firstName} ${lastName}`, type: 'required' }
          ],
          allowNewTimeProposals: true,
          transactionId: generateUUID()
        };

        const url = withKey(CONFIG.BOOK_APPOINTMENT_URL, CONFIG.BOOK_APPOINTMENT_KEY);
        const headers = { 'Content-Type': 'application/json', Accept: 'application/json' };
        // We pass the key via the URL (?code=...) to simplify CORS. Avoid x-functions-key header.
        // (POST with JSON will still preflight, ensure CORS is configured on the Function App.)

        const resp = await fetch(url, { method: 'POST', headers, body: JSON.stringify(appointmentData) });
        if (!resp.ok) {
          const text = await resp.text().catch(() => '');
          throw new Error(`Failed to book appointment (${resp.status}) ${text}`);
        }

        // If function returns JSON, you can inspect it here if needed
        // const result = await resp.json();

        showSuccess();
        setTimeout(clearForm, 1500);
      } catch (err) {
        console.error('Error booking appointment:', err);
        showError('There was an error booking your appointment. Please try again or call us directly.');
      } finally {
        document.getElementById('submitBtn').disabled = false;
        document.getElementById('submitSpinner').classList.add('hidden');
      }
    }

    // ====== VALIDATION & UI HELPERS ======
    function validateForm() {
      hideMessages();

      // Slot selected?
      if (!selectedSlot) {
        showError('Please select an appointment date');
        return false;
      }

      // Times selected?
      const startTime = document.getElementById('startTime').value;
      const endTime = document.getElementById('endTime').value;
      if (!startTime || !endTime) {
        showError('Please select your preferred appointment times');
        return false;
      }

      const appt = document.querySelector('input[name="appointmentType"]:checked');
      if (!appt) {
        showError('Please select an appointment type');
        return false;
      }

      // In-person requireds
      if (appt.value === 'inperson') {
        if (!document.getElementById('address').value.trim()) {
          showError('Please provide the service address for in-person visit');
          return false;
        }
        if (!document.getElementById('arrivalWindow').checked) {
          showError('Please acknowledge the 10-15 minute arrival window');
          return false;
        }
      }

      // Consent boxes
      if (!document.getElementById('consent').checked) {
        showError('Please consent to receive appointment reminders');
        return false;
      }
      if (!document.getElementById('emergency').checked) {
        showError('Please confirm you are not experiencing an emergency');
        return false;
      }

      // Basic email sanity
      const email = document.getElementById('email').value.trim();
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        showError('Please enter a valid email address');
        return false;
      }

      return true;
    }

    function clearForm() {
      document.getElementById('bookingForm').reset();
      document.getElementById('inPersonDetails').classList.add('hidden');
      document.getElementById('timePickerSection').classList.add('hidden');
      document.getElementById('timeSlots').innerHTML = '';
      document.querySelectorAll('.radio-option').forEach((o) => o.classList.remove('selected'));
      selectedSlot = null;
      selectedDate = null;
      hideMessages();
    }

    function showSuccess() {
      hideMessages();
      const el = document.getElementById('successMessage');
      el.style.display = 'block';
      setTimeout(() => (el.style.display = 'none'), 5000);
    }

    function showError(message) {
      hideMessages();
      const el = document.getElementById('errorMessage');
      el.textContent = message;
      el.style.display = 'block';
      setTimeout(() => (el.style.display = 'none'), 6000);
    }

    function hideMessages() {
      document.getElementById('successMessage').style.display = 'none';
      document.getElementById('errorMessage').style.display = 'none';
    }
  </script>
</body>
</html>
