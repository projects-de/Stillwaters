<script>
  // ===== CONFIG (adjust if needed) =====
  var CONFIG = {
    GET_SLOTS_URL: 'https://sw-function-b6c4h9cnexhbh4g3.canadacentral-01.azurewebsites.net/api/Calender', // now anonymous
    BOOK_APPOINTMENT_URL: 'https://sw-function-b6c4h9cnexhbh4g3.canadacentral-01.azurewebsites.net/api/CreateEvent',
    GET_SLOTS_KEY: '',     // leave empty when anonymous
    BOOK_APPOINTMENT_KEY: '', // add if CreateEvent requires a key (we append ?code= automatically)
    TIMEZONE: 'Pacific Standard Time'
  };

  function withKey(url, key) {
    if (!key) return url;
    try {
      var u = new URL(url);
      u.searchParams.set('code', key);
      return u.toString();
    } catch (e) {
      var sep = url.indexOf('?') >= 0 ? '&' : '?';
      return url + sep + 'code=' + encodeURIComponent(key);
    }
  }

  var selectedSlot = null;
  var selectedDate = null;
  var availableSlots = [];

  // -------- DOM READY --------
  document.addEventListener('DOMContentLoaded', function () {
    document.getElementById('bookingForm').addEventListener('submit', handleSubmit);
    document.getElementById('loadSlotsBtn').addEventListener('click', loadAvailableSlots);
    document.getElementById('clearFormBtn').addEventListener('click', clearForm);
    document.getElementById('startTime').addEventListener('change', updateEndTimeOptions);

    // Clickable appointment-type cards (no event.currentTarget)
    var typeCards = document.querySelectorAll('.radio-option');
    for (var i = 0; i < typeCards.length; i++) {
      typeCards[i].addEventListener('click', function () {
        var t = this.getAttribute('data-type');
        selectAppointmentType(t);
      });
    }

    // Phone formatting (###-###-####)
    document.getElementById('phone').addEventListener('input', function (e) {
      var v = e.target.value.replace(/\D/g, '').slice(0, 10);
      var out = v;
      if (v.length > 6) out = v.slice(0,3) + '-' + v.slice(3,6) + '-' + v.slice(6);
      else if (v.length > 3) out = v.slice(0,3) + '-' + v.slice(3);
      e.target.value = out;
    });
  });

  // -------- Helpers --------
  function generateUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
      var r = Math.random() * 16 | 0;
      var v = c === 'x' ? r : (r & 0x3) | 0x8;
      return v.toString(16).toUpperCase();
    });
  }

  function selectAppointmentType(type) {
    // select the radio
    var radioId = type === 'telehealth' ? 'telehealth' : 'inperson';
    var radio = document.getElementById(radioId);
    if (radio) radio.checked = true;

    // toggle selected class
    var cards = document.querySelectorAll('.radio-option');
    for (var i = 0; i < cards.length; i++) cards[i].classList.remove('selected');
    var chosen = document.querySelector('.radio-option[data-type="' + type + '"]');
    if (chosen) chosen.classList.add('selected');

    // show/hide in-person section + requireds
    var inPersonDetails = document.getElementById('inPersonDetails');
    if (type === 'inperson') {
      inPersonDetails.classList.remove('hidden');
      document.getElementById('address').required = true;
      document.getElementById('arrivalWindow').required = true;
    } else {
      inPersonDetails.classList.add('hidden');
      document.getElementById('address').required = false;
      document.getElementById('arrivalWindow').required = false;
    }
  }

  function parseSlotString(slotStr) {
    // e.g. "05 Sep 2025, 09:00 AM - 02:00 PM"
    var parts = slotStr.split(', ');
    var datePart = parts[0]; // "05 Sep 2025"
    var timePart = parts[1]; // "09:00 AM - 02:00 PM"

    var dtBits = datePart.split(' ');
    var day = parseInt(dtBits[0], 10);
    var mon = dtBits[1];
    var year = parseInt(dtBits[2], 10);
    var monthMap = { Jan:0, Feb:1, Mar:2, Apr:3, May:4, Jun:5, Jul:6, Aug:7, Sep:8, Oct:9, Nov:10, Dec:11 };

    var timeBits = timePart.split(' - ');
    var startTimeStr = timeBits[0];
    var endTimeStr = timeBits[1];

    return {
      date: new Date(year, monthMap[mon], day),
      dateStr: datePart,
      startTimeStr: startTimeStr,
      endTimeStr: endTimeStr,
      originalString: slotStr
    };
  }

  function convertTo24Hour(timeStr) {
    // "09:00 AM"
    var t = timeStr.trim().split(' ');
    var hm = t[0].split(':');
    var hours = parseInt(hm[0], 10);
    var minutes = parseInt(hm[1], 10);
    var period = t[1];
    if (period === 'PM' && hours !== 12) hours += 12;
    if (period === 'AM' && hours === 12) hours = 0;
    return { hours: hours, minutes: minutes };
  }

  function pad2(n) { return (n < 10 ? '0' : '') + n; }

  function formatDateTimeForAPI(date, hours, minutes) {
    return date.getFullYear() + '-' + pad2(date.getMonth()+1) + '-' + pad2(date.getDate())
      + 'T' + pad2(hours) + ':' + pad2(minutes) + ':00';
  }

  function humanTimeDisplay(date, start, end) {
    var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    function t12(h, m) {
      var ap = h >= 12 ? 'pm' : 'am';
      var hh = h % 12 === 0 ? 12 : h % 12;
      return hh + (m ? ':' + pad2(m) : '') + ap;
    }
    return date.getDate() + ' ' + months[date.getMonth()] + ' ' + date.getFullYear()
      + ', ' + t12(start.hour, start.minute) + 'â€“' + t12(end.hour, end.minute);
  }

  // -------- Slots --------
  async function loadAvailableSlots() {
    var loadingOverlay = document.getElementById('loadingOverlay');
    loadingOverlay.classList.add('active');

    var url = withKey(CONFIG.GET_SLOTS_URL, CONFIG.GET_SLOTS_KEY);

    try {
      var resp = await fetch(url, { method: 'GET', headers: { 'Accept': 'application/json' } });
      var text = await resp.text();
      console.log('[GET /Calender] status:', resp.status, 'raw:', text);
      if (!resp.ok) throw new Error('Failed to load available slots (' + resp.status + ')');

      var data = text ? JSON.parse(text) : {};
      var list = Array.isArray(data) ? data :
                 (Array.isArray(data.free_slots) ? data.free_slots :
                  (Array.isArray(data.freeSlots) ? data.freeSlots :
                   (Array.isArray(data.slots) ? data.slots : [])));

      availableSlots = list.map(parseSlotString);
      displayAvailableSlots(availableSlots);
    } catch (e) {
      console.error('Error loading slots:', e);
      showError('Failed to load available appointment times. Please try again.');
    } finally {
      loadingOverlay.classList.remove('active');
    }
  }

  function displayAvailableSlots(slots) {
    var container = document.getElementById('timeSlots');
    container.innerHTML = '';

    if (!slots || !slots.length) {
      container.innerHTML = '<p>No available slots returned by the server. Please check back later.</p>';
      return;
    }

    for (var i = 0; i < slots.length; i++) {
      var slot = slots[i];
      var el = document.createElement('div');
      el.className = 'time-slot';
      el.setAttribute('data-slot-index', String(i));
      el.innerHTML = '<div class="date">' + slot.dateStr + '</div>' +
                     '<div class="time">' + slot.startTimeStr + ' - ' + slot.endTimeStr + '</div>';
      el.addEventListener('click', (function(s, idx) {
        return function () { selectTimeSlot(s, idx); };
      })(slot, i));
      container.appendChild(el);
    }
  }

  function generateTimeOptions(startHour, endHour) {
    var options = [];
    for (var h = startHour; h <= endHour; h++) {
      for (var m = 0; m < 60; m += 30) {
        if (h === endHour && m > 0) break;
        var dispH = h > 12 ? h - 12 : (h === 0 ? 12 : h);
        var ap = h >= 12 ? 'PM' : 'AM';
        options.push({ display: dispH + ':' + pad2(m) + ' ' + ap, hour: h, minute: m });
      }
    }
    return options;
  }

  function selectTimeSlot(slot, index) {
    var cards = document.querySelectorAll('.time-slot');
    for (var i = 0; i < cards.length; i++) cards[i].classList.remove('selected');
    var chosen = document.querySelector('[data-slot-index="' + index + '"]');
    if (chosen) chosen.classList.add('selected');

    selectedSlot = slot;
    selectedDate = slot.date;

    var start = convertTo24Hour(slot.startTimeStr);
    var end = convertTo24Hour(slot.endTimeStr);
    var lastStartHour = end.hours - 2;

    var startSel = document.getElementById('startTime');
    var endSel = document.getElementById('endTime');
    startSel.innerHTML = '<option value="">Select start time</option>';
    endSel.innerHTML = '<option value="">Select end time</option>';

    var opts = generateTimeOptions(start.hours, lastStartHour);
    for (var j = 0; j < opts.length; j++) {
      var o = opts[j];
      var op = document.createElement('option');
      op.value = JSON.stringify(o);
      op.textContent = o.display;
      startSel.appendChild(op);
    }

    document.getElementById('timePickerSection').classList.remove('hidden');
  }

  function updateEndTimeOptions() {
    var startSel = document.getElementById('startTime');
    var endSel = document.getElementById('endTime');
    if (!startSel.value) {
      endSel.innerHTML = '<option value="">Select end time</option>';
      return;
    }
    var s = JSON.parse(startSel.value);
    var endHour = s.hour + 2;
    var endMinute = s.minute;
    var dispH = endHour > 12 ? endHour - 12 : (endHour === 0 ? 12 : endHour);
    var ap = endHour >= 12 ? 'PM' : 'AM';
    var label = dispH + ':' + pad2(endMinute) + ' ' + ap;

    endSel.innerHTML = '';
    var op = document.createElement('option');
    op.value = JSON.stringify({ hour: endHour, minute: endMinute, display: label });
    op.textContent = label;
    op.selected = true;
    endSel.appendChild(op);
  }

  // -------- Submit --------
  function validateForm() {
    hideMessages();

    if (!selectedSlot) { showError('Please select an appointment date'); return false; }
    if (!document.getElementById('startTime').value || !document.getElementById('endTime').value) {
      showError('Please select your preferred appointment times'); return false;
    }

    var appt = document.querySelector('input[name="appointmentType"]:checked');
    if (!appt) { showError('Please select an appointment type'); return false; }
    if (appt.value === 'inperson') {
      if (!document.getElementById('address').value.trim()) { showError('Please provide the service address for in-person visit'); return false; }
      if (!document.getElementById('arrivalWindow').checked) { showError('Please acknowledge the 10-15 minute arrival window'); return false; }
    }

    if (!document.getElementById('consent').checked) { showError('Please consent to receive appointment reminders'); return false; }
    if (!document.getElementById('emergency').checked) { showError('Please confirm you are not experiencing an emergency'); return false; }

    var email = document.getElementById('email').value.trim();
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { showError('Please enter a valid email address'); return false; }

    return true;
  }

  async function handleSubmit(e) {
    e.preventDefault();
    if (!validateForm()) return;

    var submitBtn = document.getElementById('submitBtn');
    var spinner = document.getElementById('submitSpinner');
    submitBtn.disabled = true;
    spinner.classList.remove('hidden');

    try {
      var form = new FormData(e.target);
      var firstName = String(form.get('firstName') || '').trim();
      var lastName  = String(form.get('lastName')  || '').trim();
      var email     = String(form.get('email')     || '').trim();
      var phone     = String(form.get('phone')     || '').trim();
      var apptType  = String(form.get('appointmentType') || '').trim();

      var startTimeData = JSON.parse(document.getElementById('startTime').value);
      var endTimeData   = JSON.parse(document.getElementById('endTime').value);

      var startDateTime = formatDateTimeForAPI(selectedDate, startTimeData.hour, startTimeData.minute);
      var endDateTime   = formatDateTimeForAPI(selectedDate, endTimeData.hour, endTimeData.minute);

      var subject = (apptType === 'telehealth' ? 'Telehealth' : 'In-person') + ' appointment';

      var body = 'Appointment scheduled for ' + apptType + ' with ' + firstName +
                 ' on ' + humanTimeDisplay(selectedDate, startTimeData, endTimeData) + '. ' +
                 'Contact: ' + phone + '.';

      if (apptType === 'inperson') {
        var address = String(form.get('address') || '');
        var unit = String(form.get('unit') || '');
        var entryNotes = String(form.get('entryNotes') || '');
        var parking = String(form.get('parking') || '');
        var safety = String(form.get('safetyConsiderations') || '');
        var arrivalWindowAck = document.getElementById('arrivalWindow').checked ? 'Yes' : 'No';
        body += ' Address: ' + address + (unit ? ', ' + unit : '') + '.';
        if (entryNotes) body += ' Entry notes: ' + entryNotes + '.';
        if (parking) body += ' Parking: ' + parking + '.';
        if (safety) body += ' Safety considerations: ' + safety + '.';
        body += ' Arrival window acknowledged: ' + arrivalWindowAck + '.';
      }

      var altAvail = String(form.get('alternateAvailability') || '');
      var notes = String(form.get('additionalNotes') || '');
      if (altAvail) body += ' Alternate availability: ' + altAvail + '.';
      if (notes) body += ' Additional notes: ' + notes + '.';

      var appointmentData = {
        start: startDateTime,
        end: endDateTime,
        subject: subject,
        body: body,
        timeZone: CONFIG.TIMEZONE,
        location: { displayName: apptType === 'telehealth' ? 'video' : 'in-person' },
        attendees: [{ address: email, name: firstName + ' ' + lastName, type: 'required' }],
        allowNewTimeProposals: true,
        transactionId: generateUUID()
      };

      var url = withKey(CONFIG.BOOK_APPOINTMENT_URL, CONFIG.BOOK_APPOINTMENT_KEY);
      var resp = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify(appointmentData)
      });

      if (!resp.ok) {
        var errTxt = '';
        try { errTxt = await resp.text(); } catch (_) {}
        throw new Error('Failed to book appointment (' + resp.status + ') ' + errTxt);
      }

      showSuccess();
      setTimeout(clearForm, 1500);
    } catch (err) {
      console.error('Error booking appointment:', err);
      showError('There was an error booking your appointment. Please try again or call us directly.');
    } finally {
      submitBtn.disabled = false;
      spinner.classList.add('hidden');
    }
  }

  // -------- Messages & reset --------
  function showSuccess() {
    hideMessages();
    var el = document.getElementById('successMessage');
    el.style.display = 'block';
    setTimeout(function () { el.style.display = 'none'; }, 5000);
  }

  function showError(message) {
    hideMessages();
    var el = document.getElementById('errorMessage');
    el.textContent = message;
    el.style.display = 'block';
    setTimeout(function () { el.style.display = 'none'; }, 6000);
  }

  function hideMessages() {
    document.getElementById('successMessage').style.display = 'none';
    document.getElementById('errorMessage').style.display = 'none';
  }

  function clearForm() {
    document.getElementById('bookingForm').reset();
    document.getElementById('inPersonDetails').classList.add('hidden');
    document.getElementById('timePickerSection').classList.add('hidden');
    document.getElementById('timeSlots').innerHTML = '';
    var cards = document.querySelectorAll('.radio-option');
    for (var i = 0; i < cards.length; i++) cards[i].classList.remove('selected');
    selectedSlot = null;
    selectedDate = null;
    hideMessages();
  }
</script>
