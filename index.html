<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Still Waters Counseling - Book Your Appointment</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #2c5282;
            --secondary-color: #4299e1;
            --accent-color: #63b3ed;
            --success-color: #48bb78;
            --danger-color: #f56565;
            --light-bg: #f7fafc;
            --white: #ffffff;
            --gray-light: #e2e8f0;
            --gray-medium: #718096;
            --gray-dark: #2d3748;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            background: var(--white);
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            max-width: 800px;
            width: 100%;
            overflow: hidden;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: var(--white);
            padding: 40px 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
            letter-spacing: -1px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.95;
        }

        .emergency-notice {
            background: var(--danger-color);
            color: var(--white);
            padding: 15px 30px;
            text-align: center;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .emergency-notice svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        .form-container {
            padding: 40px 30px;
        }

        .form-section {
            margin-bottom: 35px;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .form-section h2 {
            color: var(--gray-dark);
            font-size: 1.5rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--gray-light);
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        label {
            display: block;
            color: var(--gray-dark);
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .required {
            color: var(--danger-color);
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        input[type="time"],
        select,
        textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--gray-light);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: var(--white);
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .radio-group {
            display: flex;
            gap: 30px;
            margin-top: 10px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 15px 25px;
            border: 2px solid var(--gray-light);
            border-radius: 10px;
            transition: all 0.3s ease;
            flex: 1;
            background: var(--white);
        }

        .radio-option:hover {
            border-color: var(--secondary-color);
            background: var(--light-bg);
        }

        .radio-option input[type="radio"] {
            margin-right: 10px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .radio-option.selected {
            border-color: var(--secondary-color);
            background: linear-gradient(135deg, rgba(66, 153, 225, 0.1), rgba(99, 179, 237, 0.1));
        }

        .checkbox-group {
            display: flex;
            align-items: flex-start;
            margin: 20px 0;
        }

        .checkbox-group input[type="checkbox"] {
            margin-right: 10px;
            margin-top: 5px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-group label {
            cursor: pointer;
            margin-bottom: 0;
            flex: 1;
        }

        .time-slots {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .time-slot {
            padding: 15px;
            border: 2px solid var(--gray-light);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--white);
        }

        .time-slot:hover {
            border-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .time-slot.selected {
            background: var(--secondary-color);
            color: var(--white);
            border-color: var(--secondary-color);
        }

        .time-slot .date {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .time-slot .time {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .hidden {
            display: none !important;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 40px;
            justify-content: center;
        }

        .btn {
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: var(--white);
            box-shadow: 0 4px 15px rgba(66, 153, 225, 0.3);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(66, 153, 225, 0.4);
        }

        .btn-secondary {
            background: var(--white);
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }

        .btn-secondary:hover {
            background: var(--light-bg);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 3px solid var(--white);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 10px;
            display: inline-block;
            vertical-align: middle;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .success-message {
            background: var(--success-color);
            color: var(--white);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
            display: none;
            animation: slideDown 0.5s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .error-message {
            background: var(--danger-color);
            color: var(--white);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
            display: none;
        }

        .time-picker {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
            padding: 15px;
            background: var(--light-bg);
            border-radius: 10px;
        }

        .time-picker label {
            font-size: 0.9rem;
            color: var(--gray-medium);
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .radio-group {
                flex-direction: column;
            }

            .time-slots {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            .time-picker {
                grid-template-columns: 1fr;
            }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            background: var(--white);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: var(--shadow-lg);
        }

        .loading-content .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--gray-light);
            border-top-color: var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Still Waters Counseling</h1>
            <p>Schedule Your Intake Appointment</p>
        </div>

        <div class="emergency-notice">
            <svg viewBox="0 0 24 24">
                <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/>
            </svg>
            <span>If you are experiencing an emergency, please dial 911 immediately</span>
        </div>

        <form id="bookingForm" class="form-container">
            <!-- Success/Error Messages -->
            <div id="successMessage" class="success-message">
                Appointment booked successfully! You'll receive a confirmation soon.
            </div>
            <div id="errorMessage" class="error-message">
                There was an error booking your appointment. Please try again.
            </div>

            <!-- Client Information Section -->
            <div class="form-section">
                <h2>Client Information</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="firstName">First Name <span class="required">*</span></label>
                        <input type="text" id="firstName" name="firstName" required>
                    </div>
                    <div class="form-group">
                        <label for="lastName">Last Name <span class="required">*</span></label>
                        <input type="text" id="lastName" name="lastName" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="email">Email Address <span class="required">*</span></label>
                        <input type="email" id="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="phone">Phone Number <span class="required">*</span></label>
                        <input type="tel" id="phone" name="phone" required>
                    </div>
                </div>
            </div>

            <!-- Appointment Type Section -->
            <div class="form-section">
                <h2>Appointment Type</h2>
                <div class="form-group">
                    <label>Select your preferred appointment type <span class="required">*</span></label>
                    <div class="radio-group">
                        <div class="radio-option" onclick="selectAppointmentType('telehealth')">
                            <input type="radio" id="telehealth" name="appointmentType" value="telehealth" required>
                            <label for="telehealth">Telehealth (Video Call)</label>
                        </div>
                        <div class="radio-option" onclick="selectAppointmentType('inperson')">
                            <input type="radio" id="inperson" name="appointmentType" value="inperson" required>
                            <label for="inperson">In-Person Visit</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- In-Person Details Section (Hidden by default) -->
            <div id="inPersonDetails" class="form-section hidden">
                <h2>In-Person Visit Details</h2>
                <div class="form-group">
                    <label for="address">Service Address <span class="required">*</span></label>
                    <input type="text" id="address" name="address" placeholder="Full street address">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="unit">Apartment/Unit Number</label>
                        <input type="text" id="unit" name="unit" placeholder="Apt, Suite, Unit #">
                    </div>
                    <div class="form-group">
                        <label for="parking">Parking Instructions</label>
                        <input type="text" id="parking" name="parking" placeholder="Where to park">
                    </div>
                </div>
                <div class="form-group">
                    <label for="entryNotes">Gate/Entry Notes</label>
                    <textarea id="entryNotes" name="entryNotes" placeholder="Gate codes, building access details, etc."></textarea>
                </div>
                <div class="form-group">
                    <label for="safetyConsiderations">Safety Considerations</label>
                    <textarea id="safetyConsiderations" name="safetyConsiderations" placeholder="Any safety issues our clinician should know about"></textarea>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="arrivalWindow" name="arrivalWindow">
                    <label for="arrivalWindow">I understand the clinician will arrive within a 10-15 minute window around the start time</label>
                </div>
            </div>

            <!-- Appointment Scheduling Section -->
            <div class="form-section">
                <h2>Select Appointment Time</h2>
                <div class="form-group">
                    <button type="button" class="btn btn-secondary" onclick="loadAvailableSlots()">
                        Load Available Times
                    </button>
                </div>
                <div id="timeSlots" class="time-slots"></div>
                
                <!-- Time Selection for selected day -->
                <div id="timePickerSection" class="form-group hidden">
                    <div class="time-picker">
                        <div>
                            <label for="startTime">Preferred Start Time <span class="required">*</span></label>
                            <select id="startTime" name="startTime">
                                <option value="">Select start time</option>
                            </select>
                        </div>
                        <div>
                            <label for="endTime">Preferred End Time <span class="required">*</span></label>
                            <select id="endTime" name="endTime">
                                <option value="">Select end time</option>
                            </select>
                        </div>
                    </div>
                    <small style="color: var(--gray-medium); margin-top: 10px; display: block;">
                        Select your preferred 2-hour window within the available time slot
                    </small>
                </div>
            </div>

            <!-- Additional Information Section -->
            <div class="form-section">
                <h2>Additional Information</h2>
                <div class="form-group">
                    <label for="alternateAvailability">Alternate Availability (Optional)</label>
                    <textarea id="alternateAvailability" name="alternateAvailability" placeholder="If the available slots don't work, please describe your availability"></textarea>
                </div>
                <div class="form-group">
                    <label for="additionalNotes">Additional Notes (Optional)</label>
                    <textarea id="additionalNotes" name="additionalNotes" placeholder="Any other information you'd like us to know"></textarea>
                </div>
            </div>

            <!-- Consent Section -->
            <div class="form-section">
                <h2>Consent & Acknowledgments</h2>
                <div class="checkbox-group">
                    <input type="checkbox" id="consent" name="consent" required>
                    <label for="consent">I consent to receive appointment reminders via text and email <span class="required">*</span></label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="emergency" name="emergency" required>
                    <label for="emergency">I confirm that I am not currently experiencing a medical or mental health emergency <span class="required">*</span></label>
                </div>
            </div>

            <!-- Submit Buttons -->
            <div class="button-group">
                <button type="button" class="btn btn-secondary" onclick="clearForm()">Clear Form</button>
                <button type="submit" class="btn btn-primary">
                    Book Appointment
                    <span class="loading-spinner hidden"></span>
                </button>
            </div>
        </form>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p>Processing your request...</p>
        </div>
    </div>

    <script>
        // ============================================================
        // CONFIGURATION - UPDATE THESE WITH YOUR AZURE FUNCTION URLS
        // ============================================================
        import 'dotenv/config'; 
        const BASE = process.env.AZ_FUNC_BASE || 'https://sw-function-b6c4h9cnexhbh4g3.canadacentral-01.azurewebsites.net';

        const GET_SLOTS_PATH = process.env.GET_SLOTS_PATH || '/api/Calender';   // your route is spelled "Calender"
        const BOOK_APPOINTMENT_PATH = process.env.BOOK_APPOINTMENT_PATH || '/api/CreateEvent';

        const GET_SLOTS_KEY = process.env.GET_SLOTS_KEY || '';
        const BOOK_APPOINTMENT_KEY = process.env.BOOK_APPOINTMENT_KEY || '';

        const buildUrl = (path, key) => {
  const u = new URL(path, BASE);
  if (key) u.searchParams.set('code', key);
  return u.toString();
};

        const GET_SLOTS_URL = buildUrl(GET_SLOTS_PATH, GET_SLOTS_KEY);
        const BOOK_APPOINTMENT_URL = buildUrl(BOOK_APPOINTMENT_PATH, BOOK_APPOINTMENT_KEY);
        const CONFIG = {
            // Replace with your actual Azure Function URLs
            GET_SLOTS_URL: 'https://sw-function-b6c4h9cnexhbh4g3.canadacentral-01.azurewebsites.net',
            BOOK_APPOINTMENT_URL: 'https://sw-function-b6c4h9cnexhbh4g3.canadacentral-01.azurewebsites.net',
            
            // Optional: Add Function Keys for security (leave empty if not using function keys)
            GET_SLOTS_KEY: GET_SLOTS_URL,  
            BOOK_APPOINTMENT_KEY: BOOK_APPOINTMENT_URL,
            
            // Timezone for appointments
            TIMEZONE: 'Pacific Standard Time'
        };
        // ============================================================

        let selectedSlot = null;
        let selectedDate = null;
        let availableSlots = [];

        // Initialize form
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listeners
            document.getElementById('bookingForm').addEventListener('submit', handleSubmit);
            
            // Phone number formatting
            document.getElementById('phone').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length >= 6) {
                    value = value.slice(0, 3) + '-' + value.slice(3, 6) + '-' + value.slice(6, 10);
                } else if (value.length >= 3) {
                    value = value.slice(0, 3) + '-' + value.slice(3);
                }
                e.target.value = value;
            });

            // Time selection listeners
            document.getElementById('startTime').addEventListener('change', updateEndTimeOptions);
        });

        // Generate UUID for transaction ID
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16).toUpperCase();
            });
        }

        // Select appointment type
        function selectAppointmentType(type) {
            // Update radio button
            document.getElementById(type === 'telehealth' ? 'telehealth' : 'inperson').checked = true;
            
            // Update visual selection
            document.querySelectorAll('.radio-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Show/hide in-person details
            const inPersonDetails = document.getElementById('inPersonDetails');
            if (type === 'inperson') {
                inPersonDetails.classList.remove('hidden');
                document.getElementById('address').required = true;
                document.getElementById('arrivalWindow').required = true;
            } else {
                inPersonDetails.classList.add('hidden');
                document.getElementById('address').required = false;
                document.getElementById('arrivalWindow').required = false;
            }
        }

        // Parse slot string like "05 Sep 2025, 09:00 AM - 02:00 PM"
        function parseSlotString(slotStr) {
            // Extract date and time parts
            const parts = slotStr.split(', ');
            const datePart = parts[0]; // "05 Sep 2025"
            const timePart = parts[1]; // "09:00 AM - 02:00 PM"
            
            // Parse the date
            const [day, month, year] = datePart.split(' ');
            const monthMap = {
                'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3, 'May': 4, 'Jun': 5,
                'Jul': 6, 'Aug': 7, 'Sep': 8, 'Oct': 9, 'Nov': 10, 'Dec': 11
            };
            
            // Parse the time range
            const [startTimeStr, endTimeStr] = timePart.split(' - ');
            
            return {
                date: new Date(year, monthMap[month], parseInt(day)),
                dateStr: datePart,
                startTimeStr: startTimeStr,
                endTimeStr: endTimeStr,
                originalString: slotStr
            };
        }

        // Convert time string like "09:00 AM" to 24-hour format
        function convertTo24Hour(timeStr) {
            const [time, period] = timeStr.split(' ');
            let [hours, minutes] = time.split(':').map(Number);
            
            if (period === 'PM' && hours !== 12) {
                hours += 12;
            } else if (period === 'AM' && hours === 12) {
                hours = 0;
            }
            
            return { hours, minutes };
        }

        // Format date to ISO string for API
        function formatDateTimeForAPI(date, hours, minutes) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hour = String(hours).padStart(2, '0');
            const minute = String(minutes).padStart(2, '0');
            
            return `${year}-${month}-${day}T${hour}:${minute}:00`;
        }

        // Load available slots from Azure Function
        async function loadAvailableSlots() {
  const loadingOverlay = document.getElementById('loadingOverlay');
  loadingOverlay.classList.add('active');

  try {
    const response = await fetch(CONFIG.GET_SLOTS_URL, {
      method: 'GET',
      headers: { 'Accept': 'application/json' }
    });

    if (!response.ok) {
      throw new Error(`Failed to load available slots (${response.status})`);
    }

    const { free_slots = [] } = await response.json();
    availableSlots = free_slots.map(parseSlotString);
    displayAvailableSlots(availableSlots);
  } catch (error) {
    console.error('Error loading slots:', error);
    showError('Failed to load available appointment times. Please try again.');
  } finally {
    loadingOverlay.classList.remove('active');
  }
}


        // Display available slots
        function displayAvailableSlots(slots) {
            const container = document.getElementById('timeSlots');
            container.innerHTML = '';
            
            if (!slots || slots.length === 0) {
                container.innerHTML = '<p>No available slots at this time. Please check back later.</p>';
                return;
            }
            
            slots.forEach((slot, index) => {
                const slotElement = document.createElement('div');
                slotElement.className = 'time-slot';
                slotElement.onclick = () => selectTimeSlot(slot, index);
                
                slotElement.innerHTML = `
                    <div class="date">${slot.dateStr}</div>
                    <div class="time">${slot.startTimeStr} - ${slot.endTimeStr}</div>
                `;
                
                slotElement.dataset.slotIndex = index;
                container.appendChild(slotElement);
            });
        }

        // Generate time options for dropdowns
        function generateTimeOptions(startHour, endHour) {
            const options = [];
            for (let hour = startHour; hour <= endHour; hour++) {
                for (let minute = 0; minute < 60; minute += 30) {
                    if (hour === endHour && minute > 0) break;
                    
                    const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
                    const period = hour >= 12 ? 'PM' : 'AM';
                    const timeStr = `${displayHour}:${String(minute).padStart(2, '0')} ${period}`;
                    options.push({
                        display: timeStr,
                        hour: hour,
                        minute: minute
                    });
                }
            }
            return options;
        }

        // Select a time slot
        function selectTimeSlot(slot, index) {
            // Update visual selection
            document.querySelectorAll('.time-slot').forEach(el => {
                el.classList.remove('selected');
            });
            document.querySelector(`[data-slot-index="${index}"]`).classList.add('selected');
            
            // Store selected slot
            selectedSlot = slot;
            selectedDate = slot.date;
            
            // Show time picker section
            const timePickerSection = document.getElementById('timePickerSection');
            timePickerSection.classList.remove('hidden');
            
            // Parse available time range
            const startTime = convertTo24Hour(slot.startTimeStr);
            const endTime = convertTo24Hour(slot.endTimeStr);
            
            // Generate time options for start time dropdown
            const startTimeSelect = document.getElementById('startTime');
            startTimeSelect.innerHTML = '<option value="">Select start time</option>';
            
            const timeOptions = generateTimeOptions(startTime.hours, endTime.hours - 2); // -2 to ensure 2-hour window
            timeOptions.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = JSON.stringify(option);
                optionElement.textContent = option.display;
                startTimeSelect.appendChild(optionElement);
            });
        }

        // Update end time options based on selected start time
        function updateEndTimeOptions() {
            const startTimeSelect = document.getElementById('startTime');
            const endTimeSelect = document.getElementById('endTime');
            
            if (!startTimeSelect.value) {
                endTimeSelect.innerHTML = '<option value="">Select end time</option>';
                return;
            }
            
            const startTime = JSON.parse(startTimeSelect.value);
            endTimeSelect.innerHTML = '<option value="">Select end time</option>';
            
            // Add 2-hour window option
            const endHour = startTime.hour + 2;
            const endMinute = startTime.minute;
            
            const displayHour = endHour > 12 ? endHour - 12 : (endHour === 0 ? 12 : endHour);
            const period = endHour >= 12 ? 'PM' : 'AM';
            const endTimeStr = `${displayHour}:${String(endMinute).padStart(2, '0')} ${period}`;
            
            const option = document.createElement('option');
            option.value = JSON.stringify({ hour: endHour, minute: endMinute, display: endTimeStr });
            option.textContent = endTimeStr;
            option.selected = true;
            endTimeSelect.appendChild(option);
        }

        // Handle form submission
        async function handleSubmit(e) {
            e.preventDefault();
            
            // Validate form
            if (!validateForm()) {
                return;
            }
            
            // Show loading
            const submitBtn = document.querySelector('.btn-primary');
            const spinner = submitBtn.querySelector('.loading-spinner');
            submitBtn.disabled = true;
            spinner.classList.remove('hidden');
            
            // Get form data
            const formData = new FormData(e.target);
            const firstName = formData.get('firstName');
            const lastName = formData.get('lastName');
            const email = formData.get('email');
            const appointmentType = formData.get('appointmentType');
            
            // Parse selected times
            const startTimeData = JSON.parse(document.getElementById('startTime').value);
            const endTimeData = JSON.parse(document.getElementById('endTime').value);
            
            // Format dates for API
            const startDateTime = formatDateTimeForAPI(selectedDate, startTimeData.hour, startTimeData.minute);
            const endDateTime = formatDateTimeForAPI(selectedDate, endTimeData.hour, endTimeData.minute);
            
            // Format appointment subject and body
            const appointmentTypeText = appointmentType === 'telehealth' ? 'Telehealth' : 'In-person';
            const subject = `${appointmentTypeText} appointment`;
            const body = `Appointment scheduled for ${appointmentType} with ${firstName} on ${selectedSlot.dateStr}, ${startTimeData.display}â€“${endTimeData.display}.`;
            
            // Add address info to body if in-person
            let fullBody = body;
            if (appointmentType === 'inperson') {
                const address = formData.get('address');
                const unit = formData.get('unit');
                fullBody += ` Address: ${address}${unit ? ', ' + unit : ''}.`;
                
                const entryNotes = formData.get('entryNotes');
                if (entryNotes) {
                    fullBody += ` Entry notes: ${entryNotes}.`;
                }
                
                const parking = formData.get('parking');
                if (parking) {
                    fullBody += ` Parking: ${parking}.`;
                }
                
                const safety = formData.get('safetyConsiderations');
                if (safety) {
                    fullBody += ` Safety considerations: ${safety}.`;
                }
            }
            
            // Add additional notes if provided
            const additionalNotes = formData.get('additionalNotes');
            if (additionalNotes) {
                fullBody += ` Additional notes: ${additionalNotes}.`;
            }
            
            // Prepare appointment data in the exact format required by the API
            const appointmentData = {
                start: startDateTime,
                end: endDateTime,
                subject: subject,
                body: fullBody,
                timeZone: CONFIG.TIMEZONE,
                location: {
                    displayName: appointmentType === 'telehealth' ? 'video' : 'in-person'
                },
                attendees: [
                    {
                        address: email,
                        name: `${firstName} ${lastName}`,
                        type: "required"
                    }
                ],
                allowNewTimeProposals: true,
                transactionId: generateUUID()
            };
            
            try {
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                // Add function key if configured
                if (CONFIG.BOOK_APPOINTMENT_KEY) {
                    headers['x-functions-key'] = CONFIG.BOOK_APPOINTMENT_KEY;
                }
                
                const response = await fetch(CONFIG.BOOK_APPOINTMENT_URL, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(appointmentData)
                });
                
                if (!response.ok) {
                    throw new Error('Failed to book appointment');
                }
                
                const result = await response.json();
                
                // Show success message
                showSuccess();
                
                // Clear form after short delay
                setTimeout(() => {
                    clearForm();
                }, 3000);
                
            } catch (error) {
                console.error('Error booking appointment:', error);
                showError('There was an error booking your appointment. Please try again or call us directly.');
            } finally {
                submitBtn.disabled = false;
                spinner.classList.add('hidden');
            }
        }

        // Validate form
        function validateForm() {
            // Check if slot is selected
            if (!selectedSlot) {
                showError('Please select an appointment date');
                return false;
            }
            
            // Check if times are selected
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            
            if (!startTime || !endTime) {
                showError('Please select your preferred appointment times');
                return false;
            }
            
            // Check appointment type specific requirements
            const appointmentType = document.querySelector('input[name="appointmentType"]:checked');
            if (!appointmentType) {
                showError('Please select an appointment type');
                return false;
            }
            
            if (appointmentType.value === 'inperson') {
                if (!document.getElementById('address').value.trim()) {
                    showError('Please provide the service address for in-person visit');
                    return false;
                }
                if (!document.getElementById('arrivalWindow').checked) {
                    showError('Please acknowledge the 10-15 minute arrival window');
                    return false;
                }
            }
            
            // Check consent checkboxes
            if (!document.getElementById('consent').checked) {
                showError('Please consent to receive appointment reminders');
                return false;
            }
            
            if (!document.getElementById('emergency').checked) {
                showError('Please confirm you are not experiencing an emergency');
                return false;
            }
            
            return true;
        }

        // Clear form
        function clearForm() {
            document.getElementById('bookingForm').reset();
            document.getElementById('inPersonDetails').classList.add('hidden');
            document.getElementById('timePickerSection').classList.add('hidden');
            document.getElementById('timeSlots').innerHTML = '';
            document.querySelectorAll('.radio-option').forEach(option => {
                option.classList.remove('selected');
            });
            selectedSlot = null;
            selectedDate = null;
            hideMessages();
        }

        // Show success message
        function showSuccess() {
            hideMessages();
            const successMsg = document.getElementById('successMessage');
            successMsg.style.display = 'block';
            setTimeout(() => {
                successMsg.style.display = 'none';
            }, 5000);
        }

        // Show error message
        function showError(message) {
            hideMessages();
            const errorMsg = document.getElementById('errorMessage');
            errorMsg.textContent = message;
            errorMsg.style.display = 'block';
            setTimeout(() => {
                errorMsg.style.display = 'none';
            }, 5000);
        }

        // Hide all messages
        function hideMessages() {
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
        }
    </script>
</body>
</html>